{% extends 'admin/master.html' %}

{% block head_css %}
    {{ super() }}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .metric-card {
            border-radius: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .metric-card .card-body {
            padding: 1.5rem;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .metric-label {
            color: #6c757d;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        .metric-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        
        .card-blue {
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            color: white;
        }
        
        .card-green {
            background: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
            color: white;
        }
        
        .card-yellow {
            background: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
            color: white;
        }
        
        .card-red {
            background: linear-gradient(135deg, #e74a3b 0%, #be2617 100%);
            color: white;
        }
        
        .metric-light-text {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .chart-container {
            height: 300px;
            margin-bottom: 2rem;
        }
        
        .table-container {
            margin-top: 2rem;
        }
        
        .mode-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        .mode-sandbox {
            background-color: #ffc107;
            color: #212529;
        }
        
        .mode-live {
            background-color: #28a745;
            color: white;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Dashboard</h2>
        <div>
            <span class="me-2">PayPal Mode:</span>
            <span class="mode-badge {% if paypal_mode == 'live' %}mode-live{% else %}mode-sandbox{% endif %}">
                {{ paypal_mode|upper }}
            </span>
            <form method="post" action="{{ url_for('admin_panel.toggle_paypal_mode') }}" class="d-inline ms-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-sm btn-outline-secondary">Toggle Mode</button>
            </form>
        </div>
    </div>
    
    <!-- Metrics Cards -->
    <div class="row">
        <!-- Users -->
        <div class="col-md-3">
            <div class="card metric-card card-blue">
                <div class="card-body">
                    <div class="row">
                        <div class="col-8">
                            <div class="metric-value">{{ total_users }}</div>
                            <div class="metric-label metric-light-text">Total Users</div>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-users metric-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Affiliates -->
        <div class="col-md-3">
            <div class="card metric-card card-green">
                <div class="card-body">
                    <div class="row">
                        <div class="col-8">
                            <div class="metric-value">{{ active_affiliates }}/{{ total_affiliates }}</div>
                            <div class="metric-label metric-light-text">Active Affiliates</div>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-handshake metric-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Commissions -->
        <div class="col-md-3">
            <div class="card metric-card card-yellow">
                <div class="card-body">
                    <div class="row">
                        <div class="col-8">
                            <div class="metric-value">{{ pending_commissions }}</div>
                            <div class="metric-label metric-light-text">Pending Payouts</div>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-money-bill-wave metric-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Revenue -->
        <div class="col-md-3">
            <div class="card metric-card card-red">
                <div class="card-body">
                    <div class="row">
                        <div class="col-8">
                            <div class="metric-value">${{ total_revenue|round(2) }}</div>
                            <div class="metric-label metric-light-text">Total Revenue</div>
                        </div>
                        <div class="col-4 text-end">
                            <i class="fas fa-chart-line metric-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">User Registrations (Last 30 Days)</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="userChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Revenue (Last 30 Days)</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity Tables -->
    <div class="row mt-4">
        <!-- Recent Commissions -->
        <div class="col-md-6 table-container">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Recent Commissions</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Affiliate</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for commission in recent_commissions %}
                                <tr>
                                    <td>{{ commission.id }}</td>
                                    <td>{{ commission.affiliate_id }}</td>
                                    <td>${{ commission.commission_amount|round(2) }}</td>
                                    <td>
                                        {% if commission.status == 'held' %}
                                        <span class="badge bg-warning text-dark">Held</span>
                                        {% elif commission.status == 'approved' %}
                                        <span class="badge bg-primary">Approved</span>
                                        {% elif commission.status == 'paid' %}
                                        <span class="badge bg-success">Paid</span>
                                        {% elif commission.status == 'rejected' %}
                                        <span class="badge bg-danger">Rejected</span>
                                        {% elif commission.status == 'processing' %}
                                        <span class="badge bg-info">Processing</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ commission.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ commission.created_at.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-end mt-3">
                        <a href="{{ url_for('admin_panel.commissions') }}" class="btn btn-primary btn-sm">Manage Commissions</a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Users -->
        <div class="col-md-6 table-container">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Recent Users</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Joined</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in recent_users %}
                                <tr>
                                    <td>{{ user.id }}</td>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-end mt-3">
                        <a href="{{ url_for('usermodelview.index_view') }}" class="btn btn-primary btn-sm">View All Users</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block tail_js %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // User registrations chart
    const userCtx = document.getElementById('userChart').getContext('2d');
    const userChart = new Chart(userCtx, {
        type: 'line',
        data: {
            labels: {{ user_labels|tojson }},
            datasets: [{
                label: 'New Users',
                data: {{ user_data|tojson }},
                backgroundColor: 'rgba(78, 115, 223, 0.2)',
                borderColor: 'rgba(78, 115, 223, 1)',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 3,
                pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                pointBorderColor: '#fff',
                pointHoverRadius: 5,
                pointHoverBackgroundColor: 'rgba(78, 115, 223, 1)',
                pointHoverBorderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
    
    // Revenue chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const revenueChart = new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: {{ revenue_labels|tojson }},
            datasets: [{
                label: 'Revenue (USD)',
                data: {{ revenue_data|tojson }},
                backgroundColor: 'rgba(28, 200, 138, 0.2)',
                borderColor: 'rgba(28, 200, 138, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}