{% extends "base.html" %}

{% block title %}Affiliate Admin Dashboard{% endblock %}

{% block styles %}
<style>
    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #4e73df;
    }
    
    .stat-label {
        font-size: 14px;
        color: #6c757d;
    }
    
    .card {
        margin-bottom: 30px;
    }
    
    .table-heading {
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0;
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .affiliate-table, .commission-table, .payout-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .affiliate-table th, .affiliate-table td,
    .commission-table th, .commission-table td,
    .payout-table th, .payout-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e3e6f0;
    }
    
    .affiliate-table th, .commission-table th, .payout-table th {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .status-held {
        background-color: #ffeeba;
        color: #856404;
    }
    
    .status-approved {
        background-color: #c3e6cb;
        color: #155724;
    }
    
    .status-paid {
        background-color: #b8daff;
        color: #004085;
    }
    
    .status-rejected {
        background-color: #f5c6cb;
        color: #721c24;
    }
    
    .status-failed {
        background-color: #f5c6cb;
        color: #721c24;
    }
    
    .status-inactive {
        background-color: #f5c6cb;
        color: #721c24;
    }
    
    .status-active {
        background-color: #c3e6cb;
        color: #155724;
    }
    
    .status-suspended {
        background-color: #ffeeba;
        color: #856404;
    }
    
    .payout-details {
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 10px;
    }
    
    .payout-details h5 {
        margin-top: 0;
    }
    
    .payout-meta {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Affiliate Administration</h1>
    
    <div class="card">
        <div class="card-header">
            <h4>Affiliates</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="affiliate-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>PayPal Email</th>
                            <th>Referral Code</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for affiliate in affiliates %}
                        <tr>
                            <td>{{ affiliate.name }}</td>
                            <td>{{ affiliate.email }}</td>
                            <td>
                                {{ affiliate.paypal_email }}
                                {% if affiliate.paypal_email_verified_at %}
                                <span class="badge badge-success">Verified</span>
                                {% else %}
                                <span class="badge badge-warning">Unverified</span>
                                {% endif %}
                            </td>
                            <td><code>{{ affiliate.referral_code }}</code></td>
                            <td>
                                {% if affiliate.status == 0 %}
                                <span class="status-badge status-inactive">Inactive</span>
                                {% elif affiliate.status == 1 %}
                                <span class="status-badge status-active">Active</span>
                                {% elif affiliate.status == 2 %}
                                <span class="status-badge status-suspended">Suspended</span>
                                {% endif %}
                            </td>
                            <td>{{ affiliate.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <a href="{{ url_for('affiliate.toggle_status', affiliate_id=affiliate.id) }}" class="btn btn-sm {% if affiliate.status == 1 %}btn-warning{% else %}btn-success{% endif %}">
                                    {% if affiliate.status == 1 %}Deactivate{% else %}Activate{% endif %}
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4>Pending Commissions</h4>
            <div>
                <strong>Total: £{{ total_pending|round(2) }}</strong>
            </div>
        </div>
        <div class="card-body">
            {% if pending_commissions %}
            <form action="{{ url_for('affiliate.process_commissions') }}" method="post">
                <div class="table-responsive">
                    <table class="commission-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll"> Select</th>
                                <th>Affiliate</th>
                                <th>Amount</th>
                                <th>PayPal Email</th>
                                <th>Level</th>
                                <th>Earned Date</th>
                                <th>Available Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for commission in pending_commissions %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="commission_ids" value="{{ commission.id }}" class="commission-checkbox">
                                </td>
                                <td>{{ commission.affiliate.name }}</td>
                                <td>£{{ commission.commission_amount }}</td>
                                <td>
                                    {{ commission.affiliate.paypal_email }}
                                    {% if commission.affiliate.paypal_email_verified_at %}
                                    <span class="badge badge-success">Verified</span>
                                    {% else %}
                                    <span class="badge badge-warning">Unverified</span>
                                    {% endif %}
                                </td>
                                <td>{{ "Direct" if commission.commission_level == 1 else "Second-Tier" }}</td>
                                <td>{{ commission.commission_earned_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ commission.commission_available_date.strftime('%Y-%m-%d') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="form-group mt-3">
                    <button type="submit" class="btn btn-primary" id="processBtn" disabled>Process Selected Payouts</button>
                </div>
            </form>
            {% else %}
            <div class="alert alert-info">
                There are no pending commissions to process at this time.
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h4>Recent Payout Batches</h4>
        </div>
        <div class="card-body">
            {% if batched_payouts %}
                {% for batch_id, payout in batched_payouts.items() %}
                <div class="payout-details">
                    <div class="payout-meta">
                        <div>
                            <strong>Batch ID:</strong> {{ batch_id }}
                        </div>
                        <div>
                            <strong>Date:</strong> {{ payout.date.strftime('%Y-%m-%d %H:%M') }}
                        </div>
                        <div>
                            <strong>Status:</strong> {{ payout.status }}
                        </div>
                        <div>
                            <strong>Total:</strong> £{{ payout.total_amount|round(2) }}
                        </div>
                        <div>
                            <a href="{{ url_for('affiliate.check_payout_status', batch_id=batch_id) }}" class="btn btn-sm btn-info">
                                Refresh Status
                            </a>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="payout-table">
                            <thead>
                                <tr>
                                    <th>Affiliate</th>
                                    <th>Amount</th>
                                    <th>PayPal Email</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for commission in payout.commissions %}
                                <tr>
                                    <td>{{ commission.affiliate.name }}</td>
                                    <td>£{{ commission.commission_amount }}</td>
                                    <td>{{ commission.affiliate.paypal_email }}</td>
                                    <td>
                                        {% if commission.status == 2 %}
                                        <span class="status-badge status-paid">Paid</span>
                                        {% elif commission.status == 4 %}
                                        <span class="status-badge status-failed">Failed</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="alert alert-info">
                No payout batches have been processed yet.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle "Select All" checkbox
        var selectAllCheckbox = document.getElementById('selectAll');
        var commissionCheckboxes = document.querySelectorAll('.commission-checkbox');
        var processBtn = document.getElementById('processBtn');
        
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                var isChecked = this.checked;
                
                commissionCheckboxes.forEach(function(checkbox) {
                    checkbox.checked = isChecked;
                });
                
                updateProcessButtonState();
            });
        }
        
        // Handle individual commission checkboxes
        commissionCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                updateProcessButtonState();
                
                // Update "Select All" checkbox state
                var allChecked = true;
                commissionCheckboxes.forEach(function(cb) {
                    if (!cb.checked) {
                        allChecked = false;
                    }
                });
                
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = allChecked;
                }
            });
        });
        
        // Enable/disable process button based on checkbox selections
        function updateProcessButtonState() {
            var anyChecked = false;
            
            commissionCheckboxes.forEach(function(checkbox) {
                if (checkbox.checked) {
                    anyChecked = true;
                }
            });
            
            if (processBtn) {
                processBtn.disabled = !anyChecked;
            }
        }
    });
</script>
{% endblock %}