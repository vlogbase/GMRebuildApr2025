{% extends "base.html" %}

{% block title %}Test Model Fallback Confirmation{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .test-card {
        background-color: #2a2a2a;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        color: white;
    }
    .test-header {
        font-size: 1.5rem;
        margin-bottom: 15px;
        border-bottom: 1px solid #3a3a3a;
        padding-bottom: 10px;
    }
    .test-description {
        margin-bottom: 20px;
        color: #ccc;
    }
    .test-button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
    }
    .test-button:hover {
        background-color: #45a049;
    }
    .test-button.secondary {
        background-color: #607D8B;
    }
    .test-button.secondary:hover {
        background-color: #546E7A;
    }
    .test-result {
        margin-top: 20px;
        padding: 15px;
        background-color: #1a1a1a;
        border-radius: 5px;
        font-family: monospace;
        display: none;
    }
    .current-setting {
        padding: 10px;
        background-color: #333;
        border-radius: 5px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }
    .setting-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        margin-right: 10px;
        display: inline-block;
    }
    .setting-indicator.enabled {
        background-color: #4CAF50;
    }
    .setting-indicator.disabled {
        background-color: #F44336;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="card-title mb-1">Model Fallback Confirmation Testing</h1>
                            <p class="text-muted">Test the model fallback confirmation dialog and auto-fallback setting</p>
                        </div>
                        <a href="{{ url_for('index') }}" class="btn btn-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Chat
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Setting Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="test-card">
                <h2 class="test-header">Current Auto-Fallback Setting</h2>
                
                <div class="current-setting">
                    <span class="setting-indicator {% if user_chat_settings and user_chat_settings.auto_fallback_enabled %}enabled{% else %}disabled{% endif %}"></span>
                    <span>
                        Auto-fallback is currently 
                        <strong>{% if user_chat_settings and user_chat_settings.auto_fallback_enabled %}ENABLED{% else %}DISABLED{% endif %}</strong>
                    </span>
                </div>
                
                <p class="test-description">
                    When auto-fallback is enabled, the system will automatically use an alternative model when the 
                    selected model is unavailable, without showing a confirmation dialog.
                </p>
                
                <button id="toggleSetting" class="test-button secondary">
                    {% if user_chat_settings and user_chat_settings.auto_fallback_enabled %}
                        Disable Auto-Fallback
                    {% else %}
                        Enable Auto-Fallback
                    {% endif %}
                </button>
            </div>
        </div>
    </div>
    
    <!-- Test Fallback Dialog -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="test-card">
                <h2 class="test-header">Test Fallback Dialog</h2>
                <p class="test-description">
                    This test will simulate a situation where the selected model (e.g., Claude 3 Haiku) is unavailable,
                    and the system needs to offer a fallback model (e.g., Gemini Flash). 
                    If auto-fallback is disabled, you should see a confirmation dialog.
                </p>
                
                <div class="mb-3">
                    <label for="selectedModel" class="form-label">Select model to test:</label>
                    <select id="selectedModel" class="form-select">
                        <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
                        <option value="anthropic/claude-3-sonnet">Claude 3 Sonnet</option>
                        <option value="anthropic/claude-3-opus">Claude 3 Opus</option>
                        <option value="google/gemini-pro">Gemini Pro</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="testMessage" class="form-label">Test message:</label>
                    <input type="text" id="testMessage" class="form-control" 
                           value="This is a test message to trigger the model fallback dialog.">
                </div>
                
                <button id="testFallbackBtn" class="test-button">Test Fallback Dialog</button>
                
                <div id="testResult" class="test-result"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle auto-fallback setting
        const toggleSettingBtn = document.getElementById('toggleSetting');
        toggleSettingBtn.addEventListener('click', function() {
            // Get current setting
            const currentSetting = {% if user_chat_settings and user_chat_settings.auto_fallback_enabled %}true{% else %}false{% endif %};
            
            // Save opposite setting
            fetch('/api/user/chat_settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify({
                    auto_fallback_enabled: !currentSetting
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload page to show updated setting
                    window.location.reload();
                } else {
                    alert('Failed to update setting: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update setting');
            });
        });
        
        // Test fallback dialog
        const testFallbackBtn = document.getElementById('testFallbackBtn');
        testFallbackBtn.addEventListener('click', function() {
            const selectedModel = document.getElementById('selectedModel').value;
            const testMessage = document.getElementById('testMessage').value;
            const testResult = document.getElementById('testResult');
            
            testResult.style.display = 'block';
            testResult.innerHTML = 'Testing fallback dialog...';
            
            // Call API to simulate fallback
            fetch('/test/api/simulate_fallback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify({
                    model: selectedModel,
                    message: testMessage
                })
            })
            .then(response => response.json())
            .then(data => {
                testResult.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
                // If auto-fallback is disabled, show the fallback dialog
                const autoFallbackEnabled = {% if user_chat_settings and user_chat_settings.auto_fallback_enabled %}true{% else %}false{% endif %};
                
                if (!autoFallbackEnabled && window.ModelFallback) {
                    window.ModelFallback.showFallbackDialog(
                        data.requested_model,
                        data.fallback_model,
                        testMessage
                    );
                } else if (autoFallbackEnabled) {
                    testResult.innerHTML += '<p>Auto-fallback is enabled, so no dialog is shown.</p>';
                } else {
                    testResult.innerHTML += '<p>ERROR: ModelFallback is not available.</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                testResult.innerHTML = 'Error: ' + error.message;
            });
        });
    });
</script>
{% endblock %}