{% extends "base.html" %}

{% block title %}Account Management{% endblock %}

{% block body_class %}account-page{% endblock %}

{% block styles %}
{{ super() }}
<!-- Custom styles are now in static/css/style.css -->
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="card-title mb-1">Account Management</h1>
                            <p class="text-muted">Manage your account, add funds, and view your usage history</p>
                        </div>
                        <a href="{{ url_for('index') }}" class="btn btn-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Chat
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Balance Display -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-4">
                    <h5 class="card-title">Available Balance</h5>
                    <div class="balance-amount">${{ "%.2f"|format(user.get_balance_usd()) }}</div>
                    <p class="text-muted">
                        <i class="fas fa-info-circle"></i> Funds are used for AI model access. Different models have different pricing based on their capabilities and token usage.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="accountTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="funds-tab" data-bs-toggle="tab" data-bs-target="#funds" 
                            type="button" role="tab" aria-controls="funds" aria-selected="true">
                        <i class="fas fa-credit-card me-2"></i>Add Credits
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" 
                            type="button" role="tab" aria-controls="history" aria-selected="false">
                        <i class="fas fa-receipt me-2"></i>Purchase History
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="usage-tab" data-bs-toggle="tab" data-bs-target="#usage" 
                            type="button" role="tab" aria-controls="usage" aria-selected="false">
                        <i class="fas fa-chart-line me-2"></i>Usage Analytics
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pricing-tab" data-bs-toggle="tab" data-bs-target="#pricing" 
                            type="button" role="tab" aria-controls="pricing" aria-selected="false">
                        <i class="fas fa-tag me-2"></i>Pricing
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" 
                            type="button" role="tab" aria-controls="settings" aria-selected="false">
                        <i class="fas fa-cog me-2"></i>Account Settings
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tellFriend-tab" data-bs-toggle="tab" data-bs-target="#tellFriend" 
                            type="button" role="tab" aria-controls="tellFriend" aria-selected="false">
                        <i class="fas fa-users me-2"></i>Tell a Friend
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content pt-4">
        <!-- Add Funds Tab -->
        <div id="funds" class="tab-pane fade show active" role="tabpanel" aria-labelledby="funds-tab">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Select Credit Package</h5>
                        </div>
                        <div class="card-body">
                            <!-- Packages Grid -->
                            <div class="row">
                                {% for package in packages %}
                                {% set is_starter_package = package.stripe_price_id == 'price_1RKOl0CkgfcNKUGFhI5RljJd' %}
                                {% set has_previous_purchases = recent_transactions|length > 0 %}
                                {% if not (is_starter_package and has_previous_purchases) %}
                                <div class="col-md-3 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            {% if is_starter_package %}
                                            <h5 class="mb-0">Starter Credit Pack</h5>
                                            <span class="badge bg-info">First-time purchase only</span>
                                            {% elif package.amount_usd == 10 %}
                                            <h5 class="mb-0">Small Credit Pack</h5>
                                            {% elif package.amount_usd == 25 %}
                                            <h5 class="mb-0">Medium Credit Pack</h5>
                                            {% elif package.amount_usd == 100 %}
                                            <h5 class="mb-0">Large Credit Pack</h5>
                                            {% else %}
                                            <h5 class="mb-0">{{ "$%.2f"|format(package.amount_usd) }} Credit Pack</h5>
                                            {% endif %}
                                        </div>
                                        <div class="card-body d-flex flex-column">
                                            <div class="text-center mb-3">
                                                <span class="display-6">${{ "%.2f"|format(package.amount_usd) }}</span>
                                            </div>
                                            <p class="text-center">Pay what you use - no minimums</p>
                                            <div class="mt-auto">
                                                <ul class="list-group list-group-flush mb-3">
                                                    <li class="list-group-item bg-transparent text-light"><i class="fas fa-check-circle text-success me-2"></i>Access premium models</li>
                                                    <li class="list-group-item bg-transparent text-light"><i class="fas fa-check-circle text-success me-2"></i>Tax calculated at checkout</li>
                                                    <li class="list-group-item bg-transparent text-light"><i class="fas fa-check-circle text-success me-2"></i>Secure payment via Stripe</li>
                                                </ul>
                                                <form id="purchase-form-{{package.id}}" action="{{ url_for('billing.purchase_package', package_id=package.id) }}" method="post">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-primary w-100">Buy Now</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="fas fa-info-circle fa-2x"></i>
                                    </div>
                                    <div>
                                        <h5 class="alert-heading">Secure Payments</h5>
                                        <p class="mb-0">Payments are processed securely by Stripe. All prices are in USD and taxes will be calculated at checkout based on your location.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Purchase History Tab -->
        <div id="history" class="tab-pane fade" role="tabpanel" aria-labelledby="history-tab">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Purchase History</h5>
                            <button class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-download me-2"></i>Export CSV
                            </button>
                        </div>
                        <div class="card-body">
                            {% if recent_transactions %}
                            <div class="table-responsive">
                                <table class="table table-dark table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th class="text-white">Date</th>
                                            <th class="text-white">Amount</th>
                                            <th class="text-white">Payment Method</th>
                                            <th class="text-white">Status</th>
                                            <th class="text-white">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaction in recent_transactions %}
                                        <tr>
                                            <td class="text-light">{{ transaction.created_at.strftime('%Y-%m-%d') }}</td>
                                            <td class="text-light">${{ "%.2f"|format(transaction.amount_usd) }}</td>
                                            <td class="text-light">
                                                <span class="d-flex align-items-center">
                                                    {% if transaction.payment_method == 'stripe' %}
                                                    <i class="fab fa-cc-stripe me-2 text-primary"></i>
                                                    {% else %}
                                                    <i class="fas fa-credit-card me-2"></i>
                                                    {% endif %}
                                                    {{ transaction.payment_method|capitalize }}
                                                </span>
                                            </td>
                                            <td class="text-light">
                                                {% if transaction.status == 'completed' %}
                                                    <span class="badge bg-success">Completed</span>
                                                {% elif transaction.status == 'pending' %}
                                                    <span class="badge bg-warning text-dark">Pending</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Failed</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-light">
                                                <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="tooltip" data-bs-placement="top" title="View Receipt">
                                                    <i class="fas fa-receipt"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <div class="mb-3">
                                    <i class="fas fa-receipt fa-3x text-muted"></i>
                                </div>
                                <h5>No Purchase History</h5>
                                <p class="text-muted mb-4">You haven't made any purchases yet.</p>
                                <a href="#funds" class="btn btn-primary" data-bs-toggle="tab" data-bs-target="#funds" type="button" role="tab" aria-controls="funds" aria-selected="false">
                                    <i class="fas fa-credit-card me-2"></i>Add Credits
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Usage Analytics Tab -->
        <div id="usage" class="tab-pane fade" role="tabpanel" aria-labelledby="usage-tab">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Usage Analytics</h5>
                                <div>
                                    <div class="btn-group me-2">
                                        <button class="btn btn-sm btn-outline-secondary active" id="summaryViewBtn" data-bs-toggle="tab" data-bs-target="#usage-summary-tab">
                                            <i class="fas fa-chart-pie me-1"></i>Summary
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" id="detailedViewBtn" data-bs-toggle="tab" data-bs-target="#usage-detailed-tab">
                                            <i class="fas fa-table me-1"></i>Detailed
                                        </button>
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary" id="exportCsvBtn">
                                        <i class="fas fa-download me-1"></i> Export CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <!-- Date Range Selector -->
                            <div class="mb-4">
                                <h6>Date Range</h6>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-secondary" data-range="30">Last 30 Days</button>
                                    <button class="btn btn-sm btn-outline-secondary" data-range="7">Last 7 Days</button>
                                    <button class="btn btn-sm btn-outline-secondary active" data-range="month">This Month</button>
                                </div>
                            </div>
                            
                            <!-- Usage Analytics Content -->
                            <div class="tab-content">
                                <!-- Summary View -->
                                <div id="usage-summary-tab" class="tab-pane fade show active" role="tabpanel" aria-labelledby="summaryViewBtn">
                                    {% if recent_usage %}
                                    <!-- Usage Statistics Cards -->
                                    <div class="row mb-4">
                                        <div class="col-md-4 mb-3">
                                            <div class="card bg-dark h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-calculator fa-2x mb-3 text-primary"></i>
                                                    <h2 class="text-light">
                                                        {% set total_spent = namespace(value=0) %}
                                                        {% for usage in recent_usage %}
                                                            {% set total_spent.value = total_spent.value + (usage.credits_used / 100000) %}
                                                        {% endfor %}
                                                        ${{ "%.2f"|format(total_spent.value) }}
                                                    </h2>
                                                    <p class="text-muted">Total Spent</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="card bg-dark h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-tag fa-2x mb-3 text-success"></i>
                                                    <h2 class="text-light">
                                                        {% set total_tokens = namespace(value=0) %}
                                                        {% for usage in recent_usage %}
                                                            {% if usage.prompt_tokens %}
                                                                {% set total_tokens.value = total_tokens.value + usage.prompt_tokens %}
                                                            {% endif %}
                                                            {% if usage.completion_tokens %}
                                                                {% set total_tokens.value = total_tokens.value + usage.completion_tokens %}
                                                            {% endif %}
                                                        {% endfor %}
                                                        {{ total_tokens.value }}
                                                    </h2>
                                                    <p class="text-muted">Total Tokens</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="card bg-dark h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-bolt fa-2x mb-3 text-warning"></i>
                                                    <h2 class="text-light">{{ recent_usage|length }}</h2>
                                                    <p class="text-muted">API Requests</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-dark table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th style="min-width: 110px;" class="text-white">Date</th>
                                                    <th style="min-width: 80px;" class="text-white">Type</th>
                                                    <th style="min-width: 180px;" class="text-white">Model</th>
                                                    <th style="min-width: 80px;" class="text-white">Cost</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for usage in recent_usage %}
                                                <tr>
                                                    <td class="text-light">{{ usage.created_at.strftime('%Y-%m-%d') }}</td>
                                                    <td class="text-light">
                                                        <span class="badge {% if usage.usage_type == 'chat' %}bg-info{% elif usage.usage_type == 'embedding' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                                                            {{ usage.usage_type|capitalize }}
                                                        </span>
                                                    </td>
                                                    <td class="text-light">{{ usage.model_id }}</td>
                                                    <td class="text-light">${{ "%.4f"|format(usage.credits_used / 100000) }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <div class="mb-3">
                                            <i class="fas fa-chart-line fa-3x text-muted"></i>
                                        </div>
                                        <h5>No Usage Data</h5>
                                        <p class="text-muted mb-4">No usage data available for the selected time period.</p>
                                        <div class="d-flex justify-content-center gap-3">
                                            <button class="btn btn-outline-secondary">
                                                <i class="fas fa-calendar-alt me-2"></i>Change Date Range
                                            </button>
                                            <a href="{{ url_for('index') }}" class="btn btn-primary">
                                                <i class="fas fa-robot me-2"></i>Try Using Models
                                            </a>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Detailed View -->
                                <div id="usage-detailed-tab" class="tab-pane fade" role="tabpanel" aria-labelledby="detailedViewBtn">
                                    {% if recent_usage %}
                                    <div class="table-responsive">
                                        <table class="table table-dark table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th style="min-width: 110px;" class="text-white">Date</th>
                                                    <th style="min-width: 180px;" class="text-white">Model</th>
                                                    <th style="min-width: 100px;" class="text-white">Input Tokens</th>
                                                    <th style="min-width: 100px;" class="text-white">Input Cost</th>
                                                    <th style="min-width: 100px;" class="text-white">Output Tokens</th>
                                                    <th style="min-width: 100px;" class="text-white">Output Cost</th>
                                                    <th style="min-width: 100px;" class="text-white">Total Cost</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for usage in recent_usage %}
                                                <tr>
                                                    <td class="text-light">{{ usage.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                                    <td class="text-light">{{ usage.model_id }}</td>
                                                    <td class="text-light">{{ usage.prompt_tokens if usage.prompt_tokens else 'N/A' }}</td>
                                                    <td class="text-light">
                                                        {% if usage.prompt_tokens and usage.model_id %}
                                                            {% set input_cost = ((usage.credits_used / 100000) * 0.7)|float %}
                                                            ${{ "%.4f"|format(input_cost) }}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-light">{{ usage.completion_tokens if usage.completion_tokens else 'N/A' }}</td>
                                                    <td class="text-light">
                                                        {% if usage.completion_tokens and usage.model_id %}
                                                            {% set output_cost = ((usage.credits_used / 100000) * 0.3)|float %}
                                                            ${{ "%.4f"|format(output_cost) }}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-light">${{ "%.4f"|format(usage.credits_used / 100000) }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <div class="mb-3">
                                            <i class="fas fa-chart-line fa-3x text-muted"></i>
                                        </div>
                                        <h5>No Usage Data</h5>
                                        <p class="text-muted mb-4">No usage data available for the selected time period.</p>
                                        <div class="d-flex justify-content-center gap-3">
                                            <button class="btn btn-outline-secondary">
                                                <i class="fas fa-calendar-alt me-2"></i>Change Date Range
                                            </button>
                                            <a href="{{ url_for('index') }}" class="btn btn-primary">
                                                <i class="fas fa-robot me-2"></i>Try Using Models
                                            </a>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pricing Tab -->
        <div id="pricing" class="tab-pane fade" role="tabpanel" aria-labelledby="pricing-tab">
            <div class="balance-card p-4">
                <h4 class="mb-3">Model Pricing</h4>
                <p class="caption mb-4">Pricing information for all available AI models. Click on any column header to sort by that attribute.</p>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span id="lastUpdated" class="caption"></span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-search text-muted me-2"></i>
                        <input type="text" class="form-control custom-amount-input" id="modelSearch" placeholder="Search models...">
                    </div>
                </div>
                
                <div class="mt-3 mb-2">
                    <span class="caption">• Prices are per million tokens • All prices include our platform fee</span>
                </div>
                
                <div class="table-responsive mt-2" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-dark table-hover table-striped" id="pricingTable">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th onclick="sortPricingTable(0)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        Model <i id="sort-icon-0" class="fas fa-sort-up"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(1)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">
                                    <div class="d-flex justify-content-end align-items-center">
                                        Input Cost <i id="sort-icon-1" class="fas fa-sort"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(2)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">
                                    <div class="d-flex justify-content-end align-items-center">
                                        Output Cost <i id="sort-icon-2" class="fas fa-sort"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(3)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">
                                    <div class="d-flex justify-content-end align-items-center">
                                        Context <i id="sort-icon-3" class="fas fa-sort"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(4)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-center py-3">
                                    <div class="d-flex justify-content-center align-items-center">
                                        Multimodal <i id="sort-icon-4" class="fas fa-sort"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(5)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-center py-3">
                                    <div class="d-flex justify-content-center align-items-center">
                                        PDFs <i id="sort-icon-5" class="fas fa-sort"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(6)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-center py-3">
                                    <div class="d-flex justify-content-center align-items-center">
                                        Cost Band <i id="sort-icon-6" class="fas fa-sort"></i>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="pricingTableBody">
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <div class="d-flex flex-column align-items-center">
                                        <div class="spinner-border text-info mb-3" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="caption">Loading pricing data from OpenRouter...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pricing table styles moved to static/css/style.css -->
                
                <!-- Error message removed as requested -->
                
                <div class="mt-3">
                    <p class="caption text-muted"><i class="fas fa-info-circle"></i> The pricing information is fetched directly from OpenRouter and our internal pricing configuration. Prices may vary based on model updates and availability.</p>
                </div>
            </div>
        </div>
        
        <!-- Account Settings Tab -->
        <div id="settings" class="tab-pane fade" role="tabpanel" aria-labelledby="settings-tab">
            <div class="balance-card p-4">
                <h4 class="mb-4">Account Settings</h4>
                
                <form>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control custom-amount-input" id="username" value="{{ user.username }}" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control custom-amount-input" id="email" value="{{ user.email }}" readonly>
                    </div>
                    
                    <hr class="my-4" style="border-color: #3f4246;">
                    
                    <h5>Notification Preferences</h5>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="emailNotifications" checked>
                        <label class="form-check-label" for="emailNotifications">Receive email notifications</label>
                    </div>
                    
                    <hr class="my-4" style="border-color: #3f4246;">
                    
                    <h5>Data Management</h5>
                    <div class="mt-3">
                        <button id="clear-conversations-btn-account" class="btn btn-danger">
                            <i class="fa-regular fa-trash-can me-2"></i> Clear All Conversations
                        </button>
                        <p class="text-muted mt-2 small">
                            <i class="fas fa-info-circle me-1"></i> This action will permanently delete all your conversation history.
                        </p>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="lowBalanceAlerts" checked>
                        <label class="form-check-label" for="lowBalanceAlerts">Low balance alerts</label>
                    </div>
                    
                    <hr class="my-4" style="border-color: #3f4246;">
                    
                    <h5>Danger Zone</h5>
                    <p class="caption">These actions cannot be undone. Please proceed with caution.</p>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="select-button bg-danger">Delete Account</button>
                        <button type="button" class="select-button" style="background-color: #fd7e14;">Export My Data</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Tell a Friend Tab -->
        <div id="tellFriend" class="tab-pane fade" role="tabpanel" aria-labelledby="tellFriend-tab">
            {% include 'affiliate/tell_friend_tab.html' %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded event fired - Initializing account page functions');
    
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
    
    // Usage Analytics sub-tab functionality
    const summaryViewBtn = document.getElementById('summaryViewBtn');
    const detailedViewBtn = document.getElementById('detailedViewBtn');
    const summaryTab = document.getElementById('usage-summary-tab');
    const detailedTab = document.getElementById('usage-detailed-tab');
    
    if (summaryViewBtn && detailedViewBtn && summaryTab && detailedTab) {
        summaryViewBtn.addEventListener('click', function() {
            summaryViewBtn.classList.add('active');
            detailedViewBtn.classList.remove('active');
            
            summaryTab.classList.add('show', 'active');
            detailedTab.classList.remove('show', 'active');
        });
        
        detailedViewBtn.addEventListener('click', function() {
            detailedViewBtn.classList.add('active');
            summaryViewBtn.classList.remove('active');
            
            detailedTab.classList.add('show', 'active');
            summaryTab.classList.remove('show', 'active');
        });
    }
            
    // Initialize date range selection buttons
    const dateRangeButtons = document.querySelectorAll('.btn-group .btn[data-range]');
    
    dateRangeButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            dateRangeButtons.forEach(function(btn) {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // TODO: Add actual date range filtering functionality
            console.log(`Selected date range: ${this.getAttribute('data-range')}`);
        });
    });
    
    // Enable/disable activation button based on checkbox
    const agreeCheckbox = document.getElementById('agreeToTerms');
    const activateButton = document.getElementById('activateReferralBtn');
    
    if (agreeCheckbox && activateButton) {
        agreeCheckbox.addEventListener('change', function() {
            activateButton.disabled = !this.checked;
        });
    }
    
    // Copy referral link functionality
    const copyBtn = document.getElementById('copyReferralLink');
    const referralLinkInput = document.getElementById('referralLink');
    
    if (copyBtn && referralLinkInput) {
        copyBtn.addEventListener('click', function() {
            referralLinkInput.select();
            document.execCommand('copy');
            
            // Show feedback
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            
            setTimeout(function() {
                copyBtn.innerHTML = originalText;
            }, 2000);
        });
    }
    
    // Function to calculate cost band based on pricing
    function calculateCostBand(inputPrice, outputPrice) {
        // Handle string price inputs (with $ symbol)
        if (typeof inputPrice === 'string') {
            inputPrice = parseFloat(inputPrice.replace('$', '')) || 0;
        }
        if (typeof outputPrice === 'string') {
            outputPrice = parseFloat(outputPrice.replace('$', '')) || 0;
        }
        
        // Determine if this is a free model
        const isFreeModel = (inputPrice === 0 || inputPrice <= 0.001) && 
                           (outputPrice === 0 || outputPrice <= 0.001);
        
        if (isFreeModel) {
            return '';  // Free models don't show a cost band
        }
        
        // Calculate band based on maximum price
        const maxPrice = Math.max(inputPrice, outputPrice);
        
        if (maxPrice >= 100.0) {
            return '$$$$';
        } else if (maxPrice >= 10.0) {
            return '$$$';
        } else if (maxPrice >= 1.0) {
            return '$$';
        } else if (maxPrice >= 0.01) {
            return '$';
        }
        
        return '';  // Default for very low prices
    }
    
    // Stripe integration is complete - custom amount calculator removed
    
    // Debug form submission for purchase buttons
    // Select all purchase forms
    const purchaseForms = document.querySelectorAll('form[id^="purchase-form-"]');
    
    // Add event listeners to each form
    purchaseForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            console.log('Purchase form submitted:', form.id);
            // Continue with form submission (do not prevent default)
        });
        
        // Add event listeners to the buttons inside forms
        const button = form.querySelector('button[type="submit"]');
        if (button) {
            button.addEventListener('click', function(e) {
                console.log('Buy button clicked for form:', form.id);
                // Let the normal form submission happen
            });
        }
    });
    
    // Clear conversations button functionality
    const clearConversationsBtn = document.getElementById('clear-conversations-btn-account');
    if (clearConversationsBtn) {
        clearConversationsBtn.addEventListener('click', function() {
            // Show confirmation dialog
            if (confirm('Are you sure you want to delete all conversations? This action cannot be undone.')) {
                // User confirmed, send request to clear conversations
                fetch('/clear-conversations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('All conversations have been cleared successfully.');
                    } else {
                        alert('Error clearing conversations: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error clearing conversations:', error);
                    alert('Error clearing conversations. Please try again later.');
                });
            }
        });
    }
    
    // Initialize Bootstrap tab functionality
    var triggerTabList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tab"]'));
    triggerTabList.forEach(function (triggerEl) {
        triggerEl.addEventListener('shown.bs.tab', function (event) {
            console.log(`Tab shown: ${event.target.getAttribute('data-bs-target')}`);
            
            // Get the tab name from data-bs-target attribute (removing the # symbol)
            const tabName = event.target.getAttribute('data-bs-target').substring(1);
            
            // Tab-specific logic
            if (tabName === 'pricing') {
                loadPricingData();
            } else if (tabName === 'tellFriend' && typeof window.initializeTellFriendTabContent === 'function') {
                window.initializeTellFriendTabContent();
            }
        });
    });
    
    // Legacy openTab function for backward compatibility
    window.openTab = function(tabName, clickEvent) {
        console.log(`Opening tab with Bootstrap 5: ${tabName}`);
        
        // Find the corresponding tab trigger element
        const tabTrigger = document.querySelector(`[data-bs-target="#${tabName}"]`);
        
        if (tabTrigger) {
            // Use Bootstrap's tab API to show the tab
            const bsTab = new bootstrap.Tab(tabTrigger);
            bsTab.show();
        } else {
            console.error(`Tab trigger not found for: #${tabName}`);
        }
        
        // Tab-specific logic
        if (tabName === 'pricing') {
            loadPricingData();
        } else if (tabName === 'tellFriend') {
            console.log('Loading Tell a Friend tab content');
            // No need to set inline style - the .active class will handle this
            const tellFriendTab = document.getElementById('tellFriend');
            if (tellFriendTab && typeof window.initializeTellFriendTabContent === 'function') {
                // Just call the initialization function
                window.initializeTellFriendTabContent();
            }
        }
    }
    
    // Model Pricing Table functionality
    let pricingData = [];
    let sortColumn = 0;
    let sortDirection = 1; // 1 for ascending, -1 for descending
    let previousSorts = []; // Track previous sort criteria for multi-level sorting
    
    // Function to load pricing data from API
    function loadPricingData() {
        const pricingTableBody = document.getElementById('pricingTableBody');
        const lastUpdatedElem = document.getElementById('lastUpdated');

        // Show loading state
        pricingTableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-5">
                    <div class="d-flex flex-column align-items-center">
                        <div class="spinner-border text-info mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="caption">Loading pricing data...</p>
                    </div>
                </td>
            </tr>
        `;
        lastUpdatedElem.textContent = 'Loading...';

        // Fetch data from API (Using the endpoint that works with our price_updater module)
        fetch('/api/get_model_prices')
            .then(response => {
                if (!response.ok) {
                    // Try to get error message from response body
                    return response.text().then(text => {
                        throw new Error(`Failed to fetch pricing data. Status: ${response.status}. Message: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log("Received pricing data from API:", data); // Log the received data structure

                // --- Check the structure of the received data ---
                if (typeof data.prices !== 'object' || data.prices === null) {
                    console.error('Invalid pricing data format received:', data);
                    throw new Error('Invalid pricing data format from server.');
                }
                
                // Store the prices object in pricingData
                pricingData = data.prices; // <-- This is the object containing model prices

                // Convert the pricingData object into an array of model objects for table rendering
                pricingData = Object.entries(pricingData).map(([modelId, modelDetails]) => {
                    // Format the model name (use provided name if available, otherwise format the ID)
                    const modelName = modelDetails.model_name || 
                                      modelId.split('/').pop().replace(/-/g, ' ').replace(/(^\w|\s\w)/g, m => m.toUpperCase());
                    
                    // Format prices with appropriate precision
                    // For very small values, show more decimal places
                    let inputPriceStr, outputPriceStr;
                    
                    if (modelDetails.input_price === 0) {
                        inputPriceStr = '$0.00';
                    } else if (modelDetails.input_price < 0.01) {
                        inputPriceStr = `$${modelDetails.input_price.toFixed(4)}`;
                    } else {
                        inputPriceStr = `$${modelDetails.input_price.toFixed(2)}`;
                    }
                    
                    if (modelDetails.output_price === 0) {
                        outputPriceStr = '$0.00';
                    } else if (modelDetails.output_price < 0.01) {
                        outputPriceStr = `$${modelDetails.output_price.toFixed(4)}`;
                    } else {
                        outputPriceStr = `$${modelDetails.output_price.toFixed(2)}`;
                    }
                    
                    return {
                        model_id: modelId,
                        model_name: modelName,
                        input_price: inputPriceStr,
                        output_price: outputPriceStr,
                        context_length: modelDetails.context_length || 'N/A',
                        multimodal: modelDetails.is_multimodal ? 'Yes' : 'No',
                        pdfs: modelDetails.supports_pdf ? 'Yes' : 'No',
                        cost_band: modelDetails.cost_band || ''
                    };
                });

                // Store in localStorage for caching
                try {
                    localStorage.setItem('modelPricingData', JSON.stringify(pricingData));
                    localStorage.setItem('modelPricingTimestamp', new Date().getTime().toString());
                } catch (e) {
                    console.warn('Could not store pricing data in localStorage:', e);
                }
                
                // Remove any existing alert
                const existingAlert = document.querySelector('#pricing .alert');
                if (existingAlert) existingAlert.remove();
                
                // Render the table
                renderPricingTable();
                
                // Update last updated timestamp
                if (data.last_updated) {
                    const lastUpdatedDate = new Date(data.last_updated);
                    lastUpdatedElem.textContent = `Last updated: ${lastUpdatedDate.toLocaleTimeString()} ${lastUpdatedDate.toLocaleDateString()}`;
                } else {
                    const currentTime = new Date();
                    lastUpdatedElem.textContent = `Last updated: ${currentTime.toLocaleTimeString()} ${currentTime.toLocaleDateString()}`;
                }
            })
            .catch(error => {
                console.error('Error loading pricing data:', error);
                
                // Try to use cached data if available
                const cachedData = localStorage.getItem('modelPricingData');
                const cachedTimestamp = localStorage.getItem('modelPricingTimestamp');
                
                if (cachedData) {
                    try {
                        pricingData = JSON.parse(cachedData);
                        renderPricingTable();
                        
                        // Update the last updated timestamp to show it's cached data
                        lastUpdatedElem.textContent = `Last updated: ${new Date(parseInt(cachedTimestamp)).toLocaleString()} (cached)`;
                        
                        // Remove any existing alert
                        const existingAlert = document.querySelector('#pricing .alert');
                        if (existingAlert) existingAlert.remove();
                        
                        // Show warning about using cached data
                        const pricingCard = document.querySelector('#pricing .balance-card');
                        const warningAlert = document.createElement('div');
                        warningAlert.className = 'alert alert-warning mt-3';
                        warningAlert.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i> Could not fetch current pricing data. Using previously cached data.';
                        pricingCard.insertBefore(warningAlert, pricingCard.firstChild);
                        
                        // Auto-hide the warning message after 5 seconds
                        setTimeout(() => {
                            warningAlert.remove();
                        }, 5000);
                        
                        return;
                    } catch (e) {
                        console.error('Failed to use cached data:', e);
                    }
                }
                
                // No cached data or failed to parse it - show empty state
                pricingTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <p class="caption text-danger">No pricing data available. Please try again later.</p>
                            <small class="text-muted">${error.message}</small>
                        </td>
                    </tr>
                `;
                lastUpdatedElem.textContent = 'Update failed';
            });
    }
    
    // Function to render the pricing table
    function renderPricingTable() {
        const pricingTableBody = document.getElementById('pricingTableBody');
        const searchTerm = document.getElementById('modelSearch')?.value.toLowerCase() || '';
        
        // Filter data based on search term
        const filteredData = pricingData.filter(model => 
            model.model_name.toLowerCase().includes(searchTerm) || 
            model.model_id.toLowerCase().includes(searchTerm)
        );
        
        // Sort data with multi-level sorting support
        filteredData.sort((a, b) => {
            // Create a function to get values for any column
            function getColumnValues(item, colIndex) {
                // Check for special cases
                const isAutoRouter = item.model_id.toLowerCase().includes('router') || item.model_id.toLowerCase().includes('openrouter');
                const isFreeModel = item.input_price === '$0.00' && item.output_price === '$0.00';
                
                let value;
                
                switch(colIndex) {
                    case 0: // Model Name
                        value = item.model_name.toLowerCase();
                        break;
                        
                    case 1: // Input Cost
                        if (item.input_price === 'Variable' || isAutoRouter) {
                            value = 0.00005;
                        } else if (item.input_price === 'N/A') {
                            value = 0;
                        } else {
                            value = parseFloat(item.input_price.replace('$', ''));
                            if (isNaN(value)) value = 0;
                        }
                        break;
                        
                    case 2: // Output Cost
                        if (item.output_price === 'Variable' || isAutoRouter) {
                            value = 0.00005;
                        } else if (item.output_price === 'N/A') {
                            value = 0;
                        } else {
                            value = parseFloat(item.output_price.replace('$', ''));
                            if (isNaN(value)) value = 0;
                        }
                        break;
                        
                    case 3: // Context Length
                        value = item.context_length === 'N/A' ? 0 : parseInt(item.context_length);
                        break;
                        
                    case 4: // Multimodal
                        value = item.multimodal === 'Yes' ? 0 : 1;
                        break;
                    
                    case 5: // PDFs
                        value = item.pdfs === 'Yes' ? 0 : 1;
                        break;
                    
                    case 6: // Cost Band
                        value = item.cost_band ? item.cost_band.length : 0;
                        break;
                        
                    default:
                        value = item.model_name.toLowerCase();
                }
                
                return value;
            }
            
            // First compare by primary sort column
            const aValue = getColumnValues(a, sortColumn);
            const bValue = getColumnValues(b, sortColumn);
            
            // Compare values based on sort direction
            if (aValue < bValue) return -1 * sortDirection;
            if (aValue > bValue) return 1 * sortDirection;
            
            // If values are equal, check secondary sort criteria
            for (const prevSort of previousSorts) {
                const prevAValue = getColumnValues(a, prevSort.column);
                const prevBValue = getColumnValues(b, prevSort.column);
                
                if (prevAValue < prevBValue) return -1 * prevSort.direction;
                if (prevAValue > prevBValue) return 1 * prevSort.direction;
            }
            
            // If everything is equal, use model name as final tiebreaker
            const aName = a.model_name.toLowerCase();
            const bName = b.model_name.toLowerCase();
            if (aName < bName) return -1;
            if (aName > bName) return 1;
            return 0;
        });
        
        // Generate table content
        if (filteredData.length === 0) {
            pricingTableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <p class="caption">No matching models found.</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        pricingTableBody.innerHTML = filteredData.map(model => {
            // Check for special model types
            const isAutoRouter = model.model_id.toLowerCase().includes('router') || model.model_id.toLowerCase().includes('openrouter');
            // Check for free models - looking for $0.00 prices or very low values (for rounding issues)
            const inputPrice = parseFloat(model.input_price?.replace('$', '') || '0');
            const outputPrice = parseFloat(model.output_price?.replace('$', '') || '0');
            const isFreeModel = (model.input_price === '$0.00' || inputPrice === 0 || inputPrice <= 0.001) &&
                               (model.output_price === '$0.00' || outputPrice === 0 || outputPrice <= 0.001);
            const isEmbedding = model.model_id === 'text-embedding-3-large';
            
            // Handle model name display (no special styling for model names - all will use default color)
            let modelNameClass = '';
            // Removed special styling for models to ensure consistent colors
            
            // Calculate cost band based on pricing data
            let costBand = '';
            let costBandClass = '';
            
            if (isFreeModel) {
                costBand = '';  // Free models don't need a cost band
                costBandClass = 'cost-band-free';
            } else if (isAutoRouter) {
                costBand = '$$$';  // AutoRouter is variable but typically higher end
                costBandClass = 'cost-band-3-warn';
            } else {
                // Extract numeric values from price strings
                const inputPrice = parseFloat(model.input_price.replace('$', '')) || 0;
                const outputPrice = parseFloat(model.output_price.replace('$', '')) || 0;
                const maxPrice = Math.max(inputPrice, outputPrice);
                
                if (maxPrice >= 100.0) {
                    costBand = '$$$$';
                    costBandClass = 'cost-band-4-danger';
                } else if (maxPrice >= 10.0) {
                    costBand = '$$$';
                    costBandClass = 'cost-band-3-warn';
                } else if (maxPrice >= 1.0) {
                    costBand = '$$';
                    costBandClass = 'cost-band-2';
                } else if (maxPrice >= 0.01) {
                    costBand = '$';
                    costBandClass = 'cost-band-1';
                }
            }
            
            // Determine if the model is a good value
            const isGoodValue = !isAutoRouter && !isFreeModel && 
                              model.input_price !== 'N/A' && model.input_price !== 'Variable' &&
                              parseFloat(model.input_price.replace('$', '')) < 10.0;
            
            // Handle price display
            let inputPriceDisplay = model.input_price;
            let outputPriceDisplay = model.output_price;
            
            // Format for AutoRouter with tooltip explanation
            if (isAutoRouter) {
                inputPriceDisplay = `
                    <span class="tooltip-container">
                        <span class="fw-bold text-warning">Variable</span>
                        <span class="tooltip-text">AutoRouter dynamically selects a model based on quality and cost at the time of your request.</span>
                    </span>`;
                outputPriceDisplay = `
                    <span class="tooltip-container">
                        <span class="fw-bold text-warning">Variable</span>
                        <span class="tooltip-text">Costs vary based on the selected model.</span>
                    </span>`;
            }
            
            // Format free models with consistent color (no special color)
            if (isFreeModel) {
                inputPriceDisplay = `$0.00`;
                outputPriceDisplay = `$0.00`;
            }
            
            // Remove special color for "good value" models to make all pricing consistent
            // No special highlighting for any price values
            
            // Format context length with K or M suffix
            let contextDisplay = model.context_length;
            if (model.context_length !== 'N/A' && !isNaN(model.context_length)) {
                const contextNum = parseInt(model.context_length);
                contextDisplay = contextNum >= 1000000 
                    ? `${(contextNum / 1000000).toFixed(1)}M` 
                    : `${(contextNum / 1000).toFixed(0)}K`;
            }
            
            // Create multimodal badge/label for the dedicated column
            const multimodalDisplay = model.multimodal === 'Yes' 
                ? '<span class="badge bg-success">Yes</span>' 
                : '<span class="badge bg-secondary">No</span>';
            
            return `
                <tr>
                    <td>
                        <div>
                            <span class="${modelNameClass} fw-medium">${model.model_name}</span>
                            ${costBand ? `<span class="cost-band-indicator ${costBandClass}">${costBand}</span>` : ''}
                        </div>
                        <small class="text-muted d-block text-truncate" style="max-width: 250px;">${model.model_id}</small>
                    </td>
                    <td class="text-end">${inputPriceDisplay}</td>
                    <td class="text-end">${outputPriceDisplay}</td>
                    <td class="text-end">${contextDisplay}</td>
                    <td class="text-center">
                        ${multimodalDisplay}
                    </td>
                    <td class="text-center">
                        ${model.pdfs === 'Yes' ? 
                            '<span class="badge bg-success">Yes</span>' : 
                            '<span class="badge bg-secondary">No</span>'}
                    </td>
                    <td class="text-center">
                        ${costBand ? `<span class="cost-band-indicator ${costBandClass}">${costBand}</span>` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    // Function to handle table sorting with multi-level sort support
    window.sortPricingTable = function(columnIndex) {
        // If clicking the same column, reverse the sort direction
        if (sortColumn === columnIndex) {
            sortDirection *= -1;
        } else {
            // Save the previous sort criteria before changing
            if (sortColumn !== columnIndex) {
                // Only keep the most recent sort in history
                if (previousSorts.length > 0) {
                    // If the current column is already in previousSorts, remove it
                    previousSorts = previousSorts.filter(sort => sort.column !== columnIndex);
                }
                
                // Add the current sort to history before changing
                previousSorts.unshift({
                    column: sortColumn,
                    direction: sortDirection
                });
                
                // Limit history to 2 levels for simplicity
                if (previousSorts.length > 2) {
                    previousSorts.pop();
                }
            }
            
            // Set new primary sort
            sortColumn = columnIndex;
            sortDirection = 1;
        }
        
        // Update the table with new sort order
        renderPricingTable();
        
        // Update sort icons to show primary and secondary sorts
        document.querySelectorAll('#pricingTable th i').forEach((icon, index) => {
            if (index === sortColumn) {
                // Primary sort (current)
                icon.className = sortDirection === 1 ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else if (previousSorts.some(sort => sort.column === index)) {
                // Secondary sort (previous)
                const prevSort = previousSorts.find(sort => sort.column === index);
                icon.className = prevSort.direction === 1 ? 'fas fa-sort-up text-muted' : 'fas fa-sort-down text-muted';
            } else {
                // Not sorted
                icon.className = 'fas fa-sort';
            }
        });
    };
    
    // Search functionality for pricing table
    if (document.getElementById('modelSearch')) {
        document.getElementById('modelSearch').addEventListener('input', renderPricingTable);
    }
    
    // Set up automatic periodic refresh (every 4 hours)
    const REFRESH_INTERVAL = 4 * 60 * 60 * 1000; // 4 hours in milliseconds
    
    // Periodic auto-refresh
    setInterval(function() {
        console.log('Auto-refreshing pricing data...');
        // Only refresh if the pricing tab is active or if there's no cached data
        const activeTab = document.querySelectorAll('.tab-pane.active')[0]?.id;
        const cachedTimestamp = localStorage.getItem('modelPricingTimestamp');
        if (activeTab === 'pricing' || !cachedTimestamp) {
            loadPricingData();
        }
    }, REFRESH_INTERVAL);
    
    // Function to sort the pricing table
    window.sortPricingTable = function(column) {
        // Toggle sort direction if clicking the same column
        if (sortColumn === column) {
            sortDirection *= -1;
        } else {
            sortColumn = column;
            sortDirection = 1;
        }
        
        // Update sort icons
        for (let i = 0; i < 6; i++) {
            const icon = document.getElementById(`sort-icon-${i}`);
            if (i === column) {
                icon.className = sortDirection === 1 ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else {
                icon.className = 'fas fa-sort';
            }
        }
        
        renderPricingTable();
    };

    // Load pricing data on page load if we're on the pricing tab
    if (window.location.hash === '#pricing') {
        openTab('pricing', null);
    }
    
    // Initialize the usage analytics sub-tab functionality
    const handleUsageSubTabs = function() {
        const usageTabButtons = document.querySelectorAll('.usage-tab-button');
        const usageSubTabs = document.querySelectorAll('.usage-sub-tab');
        
        usageTabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Deactivate all tab buttons
                usageTabButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Hide all sub-tabs
                usageSubTabs.forEach(tab => {
                    tab.style.display = 'none';
                });
                
                // Activate the clicked button
                button.classList.add('active');
                
                // Show the selected sub-tab
                const tabToShow = button.getAttribute('data-tab');
                document.getElementById(`usage-${tabToShow}-tab`).style.display = 'block';
            });
        });
    };
    
    // CSV Export functionality
    const handleCsvExport = function() {
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        if (exportCsvBtn) {
            exportCsvBtn.addEventListener('click', function() {
                // Force switch to detailed tab before export
                const detailedButton = document.querySelector('.usage-tab-button[data-tab="detailed"]');
                if (detailedButton) {
                    detailedButton.click();
                }
                
                // Get the detailed table data
                const detailedTab = document.getElementById('usage-detailed-tab');
                if (!detailedTab) return;
                
                // Get the table rows from the detailed tab
                const table = detailedTab.querySelector('table');
                if (!table) {
                    alert('No data available to export');
                    return;
                }
                
                // Get all table headers
                const headers = [];
                const headerCells = table.querySelectorAll('thead th');
                headerCells.forEach(cell => {
                    headers.push(cell.textContent.trim());
                });
                
                // Get all table rows
                const rows = [];
                const tableRows = table.querySelectorAll('tbody tr');
                tableRows.forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach(cell => {
                        rowData.push(cell.textContent.trim().replace('$', ''));
                    });
                    rows.push(rowData);
                });
                
                // Create CSV content
                let csvContent = headers.join(',') + '\n';
                rows.forEach(row => {
                    csvContent += row.join(',') + '\n';
                });
                
                // Create a Blob and download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'usage_analytics_detailed.csv');
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }
    };
    
    // Initialize the usage analytics functionality
    handleUsageSubTabs();
    handleCsvExport();
});
</script>
{% endblock %}