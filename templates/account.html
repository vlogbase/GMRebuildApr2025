{% extends "base.html" %}

{% block title %}Account Management{% endblock %}

{% block styles %}
{{ super() }}
<style>
    body {
        background-color: #131416;
        color: #e4e6eb;
        /* Ensure page content scrolls vertically if needed */
        min-height: 100vh;
        overflow-y: auto;
    }
    
    .container {
        max-width: 1000px;
        margin: 0 auto; /* Center content */
    }
    
    .account-header {
        margin-bottom: 1.5rem;
        text-align: center; /* Center the header */
    }
    
    .account-header .d-flex {
        justify-content: space-between;
        align-items: center;
    }
    
    .balance-card {
        background-color: #1e2124;
        border: none;
        border-radius: 8px;
        margin-bottom: 2rem;
        text-align: center; /* Center balance display */
    }
    
    .balance-amount {
        font-size: 2.5rem;
        color: #4cd964;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .caption {
        font-size: 0.9rem;
        opacity: 0.7;
    }
    
    .tab-navigation {
        display: flex;
        justify-content: center; /* Center the tab buttons */
        margin-bottom: 1.5rem;
    }
    
    .tab-button {
        background-color: #1e2124;
        color: #e4e6eb;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        margin-right: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .tab-button:hover {
        background-color: #2a2d31;
    }
    
    .tab-button.active {
        background-color: #17a2b8;
        color: white;
    }
    
    .package-card {
        background-color: #1e2124;
        border: 1px solid #2c2f33;
        border-radius: 8px;
        padding: 1.5rem;
        height: 100%;
        transition: all 0.3s ease;
    }
    
    .package-card:hover {
        /* More subtle hover effect instead of jumping/lifting */
        background-color: #23262a;
        border-color: #17a2b8;
        box-shadow: 0 0 8px rgba(23, 162, 184, 0.3);
    }
    
    .package-title {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 0.5rem;
    }
    
    .package-price {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .package-feature {
        font-size: 0.9rem;
        opacity: 0.7;
        margin-bottom: 0.5rem;
    }
    
    .select-button {
        background-color: #17a2b8;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 0;
        width: 100%;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 1rem;
    }
    
    .select-button:hover {
        background-color: #138496;
    }
    
    .custom-amount-card {
        background-color: #1e2124;
        border: 1px solid #2c2f33;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .custom-amount-title {
        font-size: 1.2rem;
        margin-bottom: 1rem;
    }
    
    .custom-amount-input {
        background-color: #2c2f33;
        border: 1px solid #3f4246;
        color: white;
        border-radius: 6px;
    }
    
    .custom-amount-input::placeholder {
        color: #a0a0a0;
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-top: 1px solid #2c2f33;
    }
    
    .back-to-chat {
        background-color: #17a2b8;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .back-to-chat:hover {
        background-color: #138496;
        color: white;
    }
    
    .tab-content {
        margin-top: 1.5rem;
    }
    
    .tab-pane {
        display: none;
    }
    
    .tab-pane.active {
        display: block;
    }
    
    .purchase-button {
        background-color: #17a2b8;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 10px 0;
        width: 100%;
        cursor: pointer;
        transition: all 0.2s ease;
        display: block;
        margin-top: 1rem;
    }
    
    .purchase-button:hover {
        background-color: #138496;
    }
    
    .purchase-button:disabled {
        background-color: #3f4246;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="account-header d-flex justify-content-between align-items-center">
        <div>
            <h1>Account Management</h1>
            <p class="caption">Manage your account, add funds, and view your usage history</p>
        </div>
        <a href="{{ url_for('index') }}" class="back-to-chat">Back to Chat</a>
    </div>

    <!-- Balance Display -->
    <div class="balance-card p-4">
        <h5>Available Balance</h5>
        <div class="balance-amount">${{ "%.2f"|format(user.get_balance_usd()) }}</div>
        <p class="caption"><i class="fas fa-info-circle"></i> Funds are used for AI model access. Different models have different pricing based on their capabilities and token usage.</p>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" onclick="openTab('funds')">Add Funds</button>
        <button class="tab-button" onclick="openTab('history')">Purchase History</button>
        <button class="tab-button" onclick="openTab('usage')">Usage Analytics</button>
        <button class="tab-button" onclick="openTab('pricing')">Pricing</button>
        <button class="tab-button" onclick="openTab('settings')">Account Settings</button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Add Funds Tab -->
        <div id="funds" class="tab-pane active">
            <!-- Packages -->
            <div class="row">
                {% for package in packages %}
                {% set is_starter_package = package.stripe_price_id == 'price_1RKOl0CkgfcNKUGFhI5RljJd' %}
                {% set has_previous_purchases = recent_transactions|length > 0 %}
                {% if not (is_starter_package and has_previous_purchases) %}
                <div class="col-md-3 mb-4">
                    <div class="package-card">
                        {% if is_starter_package %}
                        <div class="package-title">Starter Credit Pack</div>
                        <span class="badge bg-info">First-time purchase only</span>
                        {% elif package.amount_usd == 10 %}
                        <div class="package-title">Small Credit Pack</div>
                        {% elif package.amount_usd == 25 %}
                        <div class="package-title">Medium Credit Pack</div>
                        {% elif package.amount_usd == 100 %}
                        <div class="package-title">Large Credit Pack</div>
                        {% else %}
                        <div class="package-title">{{ "$%.2f"|format(package.amount_usd) }} Credit Pack</div>
                        {% endif %}
                        <div class="package-price">${{ "%.2f"|format(package.amount_usd) }}</div>
                        <p class="package-feature">{{ package.credits // 1000 }} credits (${{"%.2f"|format(package.amount_usd)}} value)</p>
                        <ul class="list-unstyled">
                            <li class="package-feature">✓ Access premium models</li>
                            <li class="package-feature">✓ Tax calculated at checkout</li>
                            <li class="package-feature">✓ Secure payment via Stripe</li>
                        </ul>
                        <form id="purchase-form-{{package.id}}" action="{{ url_for('billing.purchase_package', package_id=package.id) }}" method="post">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="select-button">Buy Now</button>
                        </form>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            
            <div class="alert alert-info mt-4">
                <i class="fas fa-info-circle"></i> Payments are processed securely by Stripe. All prices are in USD and taxes will be calculated at checkout based on your location.
            </div>
        </div>
        
        <!-- Purchase History Tab -->
        <div id="history" class="tab-pane">
            <div class="balance-card p-4">
                <h4 class="mb-3">Purchase History</h4>
                
                {% if recent_transactions %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Payment Method</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in recent_transactions %}
                            <tr>
                                <td>{{ transaction.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>${{ "%.2f"|format(transaction.amount_usd) }}</td>
                                <td>{{ transaction.payment_method|capitalize }}</td>
                                <td>
                                    {% if transaction.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% elif transaction.status == 'pending' %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    {% else %}
                                        <span class="badge bg-danger">Failed</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-receipt fa-3x text-muted"></i>
                    </div>
                    <h5>No Purchase History</h5>
                    <p class="caption">You haven't made any purchases yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Usage Analytics Tab -->
        <div id="usage" class="tab-pane">
            <div class="balance-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0">Usage Analytics</h4>
                    <div>
                        <button class="tab-button usage-tab-button active btn-sm" data-tab="summary">Summary</button>
                        <button class="tab-button usage-tab-button btn-sm" data-tab="detailed">Detailed</button>
                        <button class="tab-button btn-sm" id="exportCsvBtn">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h6>Date Range</h6>
                    <div>
                        <button class="tab-button date-range-btn btn-sm" data-range="30">Last 30 Days</button>
                        <button class="tab-button date-range-btn btn-sm" data-range="7">Last 7 Days</button>
                        <button class="tab-button date-range-btn active btn-sm" data-range="month">This Month</button>
                    </div>
                </div>
                
                <div id="usage-summary-tab" class="usage-sub-tab active">
                {% if recent_usage %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th style="min-width: 110px;">Date</th>
                                <th style="min-width: 80px;">Type</th>
                                <th style="min-width: 180px;">Model</th>
                                <th style="min-width: 80px;">Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usage in recent_usage %}
                            <tr>
                                <td>{{ usage.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>{{ usage.usage_type }}</td>
                                <td>{{ usage.model_id }}</td>
                                <td>${{ "%.4f"|format(usage.credits_used / 1000) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-chart-line fa-3x text-muted"></i>
                    </div>
                    <h5>No Usage Data</h5>
                    <p class="caption">No usage data available for the selected time period.</p>
                    <p class="caption">Try a different date range or start using the AI models to generate usage data.</p>
                    <a href="{{ url_for('index') }}" class="select-button mt-2 w-auto d-inline-block px-4">Try Using Models</a>
                </div>
                {% endif %}
                </div>

                <div id="usage-detailed-tab" class="usage-sub-tab" style="display: none;">
                {% if recent_usage %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th style="min-width: 110px;">Date</th>
                                <th style="min-width: 180px;">Model</th>
                                <th style="min-width: 100px;">Input Tokens</th>
                                <th style="min-width: 100px;">Input Cost</th>
                                <th style="min-width: 100px;">Output Tokens</th>
                                <th style="min-width: 100px;">Output Cost</th>
                                <th style="min-width: 100px;">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usage in recent_usage %}
                            <tr>
                                <td>{{ usage.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ usage.model_id }}</td>
                                <td>{{ usage.prompt_tokens if usage.prompt_tokens else 'N/A' }}</td>
                                <td>
                                    {% if usage.prompt_tokens and usage.model_id %}
                                        {% set input_cost = ((usage.credits_used / 1000) * 0.7)|float %}
                                        ${{ "%.4f"|format(input_cost) }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>{{ usage.completion_tokens if usage.completion_tokens else 'N/A' }}</td>
                                <td>
                                    {% if usage.completion_tokens and usage.model_id %}
                                        {% set output_cost = ((usage.credits_used / 1000) * 0.3)|float %}
                                        ${{ "%.4f"|format(output_cost) }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>${{ "%.4f"|format(usage.credits_used / 1000) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-chart-line fa-3x text-muted"></i>
                    </div>
                    <h5>No Usage Data</h5>
                    <p class="caption">No usage data available for the selected time period.</p>
                    <p class="caption">Try a different date range or start using the AI models to generate usage data.</p>
                    <a href="{{ url_for('index') }}" class="select-button mt-2 w-auto d-inline-block px-4">Try Using Models</a>
                </div>
                {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Pricing Tab -->
        <div id="pricing" class="tab-pane">
            <div class="balance-card p-4">
                <h4 class="mb-3">Model Pricing</h4>
                <p class="caption mb-4">Pricing information for all available AI models. Click on any column header to sort by that attribute.</p>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span id="lastUpdated" class="caption"></span>
                    </div>
                    <div class="d-flex align-items-center">
                        <button id="refreshPricesBtn" class="btn btn-sm btn-primary me-3">
                            <i class="fas fa-sync-alt me-1"></i> Refresh Prices
                        </button>
                        <i class="fas fa-search text-muted me-2"></i>
                        <input type="text" class="form-control custom-amount-input" id="modelSearch" placeholder="Search models...">
                    </div>
                </div>
                
                <div class="mt-3 mb-2">
                    <span class="caption">• Prices are per million tokens • All prices include our platform fee</span>
                </div>
                
                <div class="table-responsive mt-2" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-dark table-hover table-striped" id="pricingTable">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th onclick="sortPricingTable(0)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        Model <i id="sort-icon-0" class="fas fa-sort-up"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(1)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">
                                    <div class="d-flex justify-content-end align-items-center">
                                        Input Cost <i id="sort-icon-1" class="fas fa-sort"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(2)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">
                                    <div class="d-flex justify-content-end align-items-center">
                                        Output Cost <i id="sort-icon-2" class="fas fa-sort"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(3)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">
                                    <div class="d-flex justify-content-end align-items-center">
                                        Context <i id="sort-icon-3" class="fas fa-sort"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(4)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-center py-3">
                                    <div class="d-flex justify-content-center align-items-center">
                                        Multimodal <i id="sort-icon-4" class="fas fa-sort"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(5)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-center py-3">
                                    <div class="d-flex justify-content-center align-items-center">
                                        Cost Band <i id="sort-icon-5" class="fas fa-sort"></i>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="pricingTableBody">
                            <tr>
                                <td colspan="5" class="text-center py-5">
                                    <div class="d-flex flex-column align-items-center">
                                        <div class="spinner-border text-info mb-3" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="caption">Loading pricing data from OpenRouter...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <style>
                /* Additional styles for the pricing table */
                #pricingTable tbody tr {
                    transition: background-color 0.15s ease-in-out;
                }
                
                #pricingTable tbody tr:hover {
                    background-color: rgba(255, 255, 255, 0.1) !important;
                }
                
                #pricingTable td {
                    padding: 0.75rem 1rem;
                    vertical-align: middle;
                }
                
                /* Tooltip styles */
                .tooltip-container {
                    position: relative;
                    display: inline-block;
                }
                
                .tooltip-container .tooltip-text {
                    visibility: hidden;
                    background-color: #333;
                    color: #fff;
                    text-align: center;
                    border-radius: 6px;
                    padding: 8px 12px;
                    position: absolute;
                    z-index: 1;
                    bottom: 125%;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 220px;
                    opacity: 0;
                    transition: opacity 0.3s;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                    font-size: 0.8rem;
                }
                
                .tooltip-container:hover .tooltip-text {
                    visibility: visible;
                    opacity: 1;
                }
                </style>
                
                <!-- Error message removed as requested -->
                
                <div class="mt-3">
                    <p class="caption text-muted"><i class="fas fa-info-circle"></i> The pricing information is fetched directly from OpenRouter and our internal pricing configuration. Prices may vary based on model updates and availability.</p>
                </div>
            </div>
        </div>
        
        <!-- Account Settings Tab -->
        <div id="settings" class="tab-pane">
            <div class="balance-card p-4">
                <h4 class="mb-4">Account Settings</h4>
                
                <form>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control custom-amount-input" id="username" value="{{ user.username }}" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control custom-amount-input" id="email" value="{{ user.email }}" readonly>
                    </div>
                    
                    <hr class="my-4" style="border-color: #3f4246;">
                    
                    <h5>Notification Preferences</h5>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="emailNotifications" checked>
                        <label class="form-check-label" for="emailNotifications">Receive email notifications</label>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="lowBalanceAlerts" checked>
                        <label class="form-check-label" for="lowBalanceAlerts">Low balance alerts</label>
                    </div>
                    
                    <hr class="my-4" style="border-color: #3f4246;">
                    
                    <h5>Danger Zone</h5>
                    <p class="caption">These actions cannot be undone. Please proceed with caution.</p>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="select-button bg-danger">Delete Account</button>
                        <button type="button" class="select-button" style="background-color: #fd7e14;">Export My Data</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Model Pricing Information -->
    <div class="balance-card p-4 mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-3">Popular Model Pricing</h5>
                <p class="caption">Your account balance is used to access premium AI models. Different models have different pricing based on their capabilities.</p>
            </div>
            <button class="tab-button" onclick="openTab('pricing')">View all model prices</button>
        </div>
        
        <div class="table-responsive mt-3">
            <table class="table table-dark table-sm">
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>Band</th>
                        <th>Cost per 1K tokens</th>
                        <th>Approximate usage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>GPT-3.5</td>
                        <td><span class="cost-band-indicator cost-band-$">$</span></td>
                        <td>$0.0003</td>
                        <td>~3,000 messages with $1</td>
                    </tr>
                    <tr>
                        <td>Claude-3 Haiku</td>
                        <td><span class="cost-band-indicator cost-band-$">$</span></td>
                        <td>$0.003</td>
                        <td>~300 messages with $1</td>
                    </tr>
                    <tr>
                        <td>Gemini 1.5 Pro</td>
                        <td><span class="cost-band-indicator cost-band-$">$</span></td>
                        <td>$0.01</td>
                        <td>~100 messages with $1</td>
                    </tr>
                    <tr>
                        <td>Claude-3 Sonnet</td>
                        <td><span class="cost-band-indicator cost-band-$$">$$</span></td>
                        <td>$0.015</td>
                        <td>~70 messages with $1</td>
                    </tr>
                    <tr>
                        <td>Claude-3 Opus</td>
                        <td><span class="cost-band-indicator cost-band-$$">$$</span></td>
                        <td>$0.045</td>
                        <td>~25 messages with $1</td>
                    </tr>
                    <tr>
                        <td>GPT-4</td>
                        <td><span class="cost-band-indicator cost-band-$$">$$</span></td>
                        <td>$0.06</td>
                        <td>~18 messages with $1</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-2">
            <small class="caption">* Actual cost depends on message length and complexity.</small>
            <a href="#" onclick="openTab('pricing'); return false;" class="caption text-info">See full pricing details <i class="fas fa-arrow-right"></i></a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to calculate cost band based on pricing
    function calculateCostBand(inputPrice, outputPrice) {
        // Handle string price inputs (with $ symbol)
        if (typeof inputPrice === 'string') {
            inputPrice = parseFloat(inputPrice.replace('$', '')) || 0;
        }
        if (typeof outputPrice === 'string') {
            outputPrice = parseFloat(outputPrice.replace('$', '')) || 0;
        }
        
        // Determine if this is a free model
        const isFreeModel = (inputPrice === 0 || inputPrice <= 0.001) && 
                           (outputPrice === 0 || outputPrice <= 0.001);
        
        if (isFreeModel) {
            return '';  // Free models don't show a cost band
        }
        
        // Calculate band based on maximum price
        const maxPrice = Math.max(inputPrice, outputPrice);
        
        if (maxPrice >= 100.0) {
            return '$$$$';
        } else if (maxPrice >= 10.0) {
            return '$$$';
        } else if (maxPrice >= 1.0) {
            return '$$';
        } else if (maxPrice >= 0.01) {
            return '$';
        }
        
        return '';  // Default for very low prices
    }
    
    // Stripe integration is complete - custom amount calculator removed
    
    // Debug form submission for purchase buttons
    document.addEventListener('DOMContentLoaded', function() {
        // Select all purchase forms
        const purchaseForms = document.querySelectorAll('form[id^="purchase-form-"]');
        
        // Add event listeners to each form
        purchaseForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                console.log('Purchase form submitted:', form.id);
                // Continue with form submission (do not prevent default)
            });
            
            // Add event listeners to the buttons inside forms
            const button = form.querySelector('button[type="submit"]');
            if (button) {
                button.addEventListener('click', function(e) {
                    console.log('Buy button clicked for form:', form.id);
                    // Let the normal form submission happen
                });
            }
        });
    });
    
    // Initialize tabs
    window.openTab = function(tabName) {
        // Hide all tab panes
        const tabPanes = document.querySelectorAll('.tab-pane');
        tabPanes.forEach(pane => {
            pane.classList.remove('active');
        });
        
        // Deactivate all tab buttons
        const tabButtons = document.querySelectorAll('.tab-navigation .tab-button');
        tabButtons.forEach(button => {
            button.classList.remove('active');
        });
        
        // Activate the selected tab pane
        document.getElementById(tabName).classList.add('active');
        
        // Activate the clicked button
        event.currentTarget.classList.add('active');
        
        // Load pricing data if the pricing tab is selected
        if (tabName === 'pricing') {
            loadPricingData();
        }
    }
    
    // Model Pricing Table functionality
    let pricingData = [];
    let sortColumn = 0;
    let sortDirection = 1; // 1 for ascending, -1 for descending
    
    // Function to load pricing data from API
    function loadPricingData() {
        const pricingTableBody = document.getElementById('pricingTableBody');
        const lastUpdatedElem = document.getElementById('lastUpdated');

        // Show loading state
        pricingTableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-5">
                    <div class="d-flex flex-column align-items-center">
                        <div class="spinner-border text-info mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="caption">Loading pricing data...</p>
                    </div>
                </td>
            </tr>
        `;
        lastUpdatedElem.textContent = 'Loading...';

        // Fetch data from API (Using the endpoint that works with our price_updater module)
        fetch('/api/get_model_prices')
            .then(response => {
                if (!response.ok) {
                    // Try to get error message from response body
                    return response.text().then(text => {
                        throw new Error(`Failed to fetch pricing data. Status: ${response.status}. Message: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log("Received pricing data from API:", data); // Log the received data structure

                // --- Check the structure of the received data ---
                if (typeof data.prices !== 'object' || data.prices === null) {
                    console.error('Invalid pricing data format received:', data);
                    throw new Error('Invalid pricing data format from server.');
                }
                
                // Store the prices object in pricingData
                pricingData = data.prices; // <-- This is the object containing model prices

                // Convert the pricingData object into an array of model objects for table rendering
                pricingData = Object.entries(pricingData).map(([modelId, modelDetails]) => {
                    // Format the model name (use provided name if available, otherwise format the ID)
                    const modelName = modelDetails.model_name || 
                                      modelId.split('/').pop().replace(/-/g, ' ').replace(/(^\w|\s\w)/g, m => m.toUpperCase());
                    
                    // Format prices with appropriate precision
                    // For very small values, show more decimal places
                    let inputPriceStr, outputPriceStr;
                    
                    if (modelDetails.input_price === 0) {
                        inputPriceStr = '$0.00';
                    } else if (modelDetails.input_price < 0.01) {
                        inputPriceStr = `$${modelDetails.input_price.toFixed(4)}`;
                    } else {
                        inputPriceStr = `$${modelDetails.input_price.toFixed(2)}`;
                    }
                    
                    if (modelDetails.output_price === 0) {
                        outputPriceStr = '$0.00';
                    } else if (modelDetails.output_price < 0.01) {
                        outputPriceStr = `$${modelDetails.output_price.toFixed(4)}`;
                    } else {
                        outputPriceStr = `$${modelDetails.output_price.toFixed(2)}`;
                    }
                    
                    return {
                        model_id: modelId,
                        model_name: modelName,
                        input_price: inputPriceStr,
                        output_price: outputPriceStr,
                        context_length: modelDetails.context_length || 'N/A',
                        multimodal: modelDetails.is_multimodal ? 'Yes' : 'No',
                        cost_band: modelDetails.cost_band || ''
                    };
                });

                // Store in localStorage for caching
                try {
                    localStorage.setItem('modelPricingData', JSON.stringify(pricingData));
                    localStorage.setItem('modelPricingTimestamp', new Date().getTime().toString());
                } catch (e) {
                    console.warn('Could not store pricing data in localStorage:', e);
                }
                
                // Remove any existing alert
                const existingAlert = document.querySelector('#pricing .alert');
                if (existingAlert) existingAlert.remove();
                
                // Render the table
                renderPricingTable();
                
                // Update last updated timestamp
                if (data.last_updated) {
                    const lastUpdatedDate = new Date(data.last_updated);
                    lastUpdatedElem.textContent = `Last updated: ${lastUpdatedDate.toLocaleTimeString()} ${lastUpdatedDate.toLocaleDateString()}`;
                } else {
                    const currentTime = new Date();
                    lastUpdatedElem.textContent = `Last updated: ${currentTime.toLocaleTimeString()} ${currentTime.toLocaleDateString()}`;
                }
            })
            .catch(error => {
                console.error('Error loading pricing data:', error);
                
                // Try to use cached data if available
                const cachedData = localStorage.getItem('modelPricingData');
                const cachedTimestamp = localStorage.getItem('modelPricingTimestamp');
                
                if (cachedData) {
                    try {
                        pricingData = JSON.parse(cachedData);
                        renderPricingTable();
                        
                        // Update the last updated timestamp to show it's cached data
                        lastUpdatedElem.textContent = `Last updated: ${new Date(parseInt(cachedTimestamp)).toLocaleString()} (cached)`;
                        
                        // Remove any existing alert
                        const existingAlert = document.querySelector('#pricing .alert');
                        if (existingAlert) existingAlert.remove();
                        
                        // Show warning about using cached data
                        const pricingCard = document.querySelector('#pricing .balance-card');
                        const warningAlert = document.createElement('div');
                        warningAlert.className = 'alert alert-warning mt-3';
                        warningAlert.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i> Could not fetch current pricing data. Using previously cached data.';
                        pricingCard.insertBefore(warningAlert, pricingCard.firstChild);
                        
                        // Auto-hide the warning message after 5 seconds
                        setTimeout(() => {
                            warningAlert.remove();
                        }, 5000);
                        
                        return;
                    } catch (e) {
                        console.error('Failed to use cached data:', e);
                    }
                }
                
                // No cached data or failed to parse it - show empty state
                pricingTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <p class="caption text-danger">No pricing data available. Please try again later.</p>
                            <small class="text-muted">${error.message}</small>
                        </td>
                    </tr>
                `;
                lastUpdatedElem.textContent = 'Update failed';
            });
    }
    
    // Function to render the pricing table
    function renderPricingTable() {
        const pricingTableBody = document.getElementById('pricingTableBody');
        const searchTerm = document.getElementById('modelSearch')?.value.toLowerCase() || '';
        
        // Filter data based on search term
        const filteredData = pricingData.filter(model => 
            model.model_name.toLowerCase().includes(searchTerm) || 
            model.model_id.toLowerCase().includes(searchTerm)
        );
        
        // Sort data
        filteredData.sort((a, b) => {
            let aValue, bValue;
            
            // Check for special cases
            const aIsAutoRouter = a.model_id.toLowerCase().includes('router') || a.model_id.toLowerCase().includes('openrouter');
            const bIsAutoRouter = b.model_id.toLowerCase().includes('router') || b.model_id.toLowerCase().includes('openrouter');
            const aIsFreeModel = a.input_price === '$0.00' && a.output_price === '$0.00';
            const bIsFreeModel = b.input_price === '$0.00' && b.output_price === '$0.00';
            
            // Handle different columns
            switch(sortColumn) {
                case 0: // Model Name
                    aValue = a.model_name.toLowerCase();
                    bValue = b.model_name.toLowerCase();
                    break;
                    
                case 1: // Input Cost
                    // Special handling for pricing sorts
                    if (a.input_price === 'Variable' || aIsAutoRouter) {
                        // For AutoRouter models, sort them between free and paid models
                        aValue = 0.00005; 
                    } else if (a.input_price === 'N/A') {
                        // Treat N/A as $0.00 for sorting
                        aValue = 0;
                    } else {
                        // Parse all prices as numbers for sorting
                        aValue = parseFloat(a.input_price.replace('$', ''));
                        // Make sure $0.00 values are treated as 0 for sorting
                        if (isNaN(aValue)) aValue = 0;
                    }
                    
                    if (b.input_price === 'Variable' || bIsAutoRouter) {
                        bValue = 0.00005;
                    } else if (b.input_price === 'N/A') {
                        // Treat N/A as $0.00 for sorting
                        bValue = 0;
                    } else {
                        bValue = parseFloat(b.input_price.replace('$', ''));
                        // Make sure $0.00 values are treated as 0 for sorting
                        if (isNaN(bValue)) bValue = 0;
                    }
                    break;
                    
                case 2: // Output Cost
                    // Special handling for output cost sorting
                    if (a.output_price === 'Variable' || aIsAutoRouter) {
                        aValue = 0.00005;
                    } else if (a.output_price === 'N/A') {
                        // Treat N/A as $0.00 for sorting
                        aValue = 0;
                    } else {
                        aValue = parseFloat(a.output_price.replace('$', ''));
                        // Make sure $0.00 values are treated as 0 for sorting
                        if (isNaN(aValue)) aValue = 0;
                    }
                    
                    if (b.output_price === 'Variable' || bIsAutoRouter) {
                        bValue = 0.00005;
                    } else if (b.output_price === 'N/A') {
                        // Treat N/A as $0.00 for sorting
                        bValue = 0;
                    } else {
                        bValue = parseFloat(b.output_price.replace('$', ''));
                        // Make sure $0.00 values are treated as 0 for sorting
                        if (isNaN(bValue)) bValue = 0;
                    }
                    break;
                    
                case 3: // Context Length
                    // Context length sorting with proper handling for N/A values
                    aValue = a.context_length === 'N/A' ? 0 : parseInt(a.context_length);
                    bValue = b.context_length === 'N/A' ? 0 : parseInt(b.context_length);
                    break;
                    
                case 4: // Multimodal
                    // Yes comes before No for multimodal sorting
                    aValue = a.multimodal === 'Yes' ? 0 : 1;
                    bValue = b.multimodal === 'Yes' ? 0 : 1;
                    break;
                
                case 5: // Cost Band
                    // Sort by number of $ characters
                    aValue = a.cost_band ? a.cost_band.length : 0;
                    bValue = b.cost_band ? b.cost_band.length : 0;
                    break;
                    
                default:
                    aValue = a.model_name.toLowerCase();
                    bValue = b.model_name.toLowerCase();
            }
            
            // Compare values based on sort direction
            if (aValue < bValue) return -1 * sortDirection;
            if (aValue > bValue) return 1 * sortDirection;
            
            // If values are equal, use model name as secondary sort
            const aName = a.model_name.toLowerCase();
            const bName = b.model_name.toLowerCase();
            if (aName < bName) return -1;
            if (aName > bName) return 1;
            return 0;
        });
        
        // Generate table content
        if (filteredData.length === 0) {
            pricingTableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <p class="caption">No matching models found.</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        pricingTableBody.innerHTML = filteredData.map(model => {
            // Check for special model types
            const isAutoRouter = model.model_id.toLowerCase().includes('router') || model.model_id.toLowerCase().includes('openrouter');
            // Check for free models - looking for $0.00 prices or very low values (for rounding issues)
            const inputPrice = parseFloat(model.input_price?.replace('$', '') || '0');
            const outputPrice = parseFloat(model.output_price?.replace('$', '') || '0');
            const isFreeModel = (model.input_price === '$0.00' || inputPrice === 0 || inputPrice <= 0.001) &&
                               (model.output_price === '$0.00' || outputPrice === 0 || outputPrice <= 0.001);
            const isEmbedding = model.model_id === 'text-embedding-3-large';
            
            // Handle model name display with appropriate styling
            let modelNameClass = '';
            if (isAutoRouter) modelNameClass = 'text-warning';
            else if (isEmbedding) modelNameClass = 'text-warning';
            else if (model.multimodal === 'Yes') modelNameClass = 'text-info';
            
            // Calculate cost band based on pricing data
            let costBand = '';
            let costBandClass = '';
            
            if (isFreeModel) {
                costBand = '';  // Free models don't need a cost band
                costBandClass = 'cost-band-free';
            } else if (isAutoRouter) {
                costBand = '$$$';  // AutoRouter is variable but typically higher end
                costBandClass = 'cost-band-3-warn';
            } else {
                // Extract numeric values from price strings
                const inputPrice = parseFloat(model.input_price.replace('$', '')) || 0;
                const outputPrice = parseFloat(model.output_price.replace('$', '')) || 0;
                const maxPrice = Math.max(inputPrice, outputPrice);
                
                if (maxPrice >= 100.0) {
                    costBand = '$$$$';
                    costBandClass = 'cost-band-4-danger';
                } else if (maxPrice >= 10.0) {
                    costBand = '$$$';
                    costBandClass = 'cost-band-3-warn';
                } else if (maxPrice >= 1.0) {
                    costBand = '$$';
                    costBandClass = 'cost-band-2';
                } else if (maxPrice >= 0.01) {
                    costBand = '$';
                    costBandClass = 'cost-band-1';
                }
            }
            
            // Determine if the model is a good value
            const isGoodValue = !isAutoRouter && !isFreeModel && 
                              model.input_price !== 'N/A' && model.input_price !== 'Variable' &&
                              parseFloat(model.input_price.replace('$', '')) < 10.0;
            
            // Handle price display
            let inputPriceDisplay = model.input_price;
            let outputPriceDisplay = model.output_price;
            
            // Format for AutoRouter with tooltip explanation
            if (isAutoRouter) {
                inputPriceDisplay = `
                    <span class="tooltip-container">
                        <span class="fw-bold text-warning">Variable</span>
                        <span class="tooltip-text">AutoRouter dynamically selects a model based on quality and cost at the time of your request.</span>
                    </span>`;
                outputPriceDisplay = `
                    <span class="tooltip-container">
                        <span class="fw-bold text-warning">Variable</span>
                        <span class="tooltip-text">Costs vary based on the selected model.</span>
                    </span>`;
            }
            
            // Format free models with green color
            if (isFreeModel) {
                inputPriceDisplay = `<span class="text-success">$0.00</span>`;
                outputPriceDisplay = `<span class="text-success">$0.00</span>`;
            }
            
            // Determine if costs should have special color for good value models
            const goodPriceClass = isGoodValue ? 'text-success' : '';
            if (isGoodValue && !isAutoRouter && !isFreeModel) {
                inputPriceDisplay = `<span class="${goodPriceClass}">${model.input_price}</span>`;
            }
            
            // Format context length with K or M suffix
            let contextDisplay = model.context_length;
            if (model.context_length !== 'N/A' && !isNaN(model.context_length)) {
                const contextNum = parseInt(model.context_length);
                contextDisplay = contextNum >= 1000000 
                    ? `${(contextNum / 1000000).toFixed(1)}M` 
                    : `${(contextNum / 1000).toFixed(0)}K`;
            }
            
            // Create multimodal badge/label for the dedicated column
            const multimodalDisplay = model.multimodal === 'Yes' 
                ? '<span class="badge bg-success">Yes</span>' 
                : '<span class="badge bg-secondary">No</span>';
            
            return `
                <tr>
                    <td>
                        <div>
                            <span class="${modelNameClass} fw-medium">${model.model_name}</span>
                            ${costBand ? `<span class="cost-band-indicator ${costBandClass}">${costBand}</span>` : ''}
                        </div>
                        <small class="text-muted d-block text-truncate" style="max-width: 250px;">${model.model_id}</small>
                    </td>
                    <td class="text-end">${inputPriceDisplay}</td>
                    <td class="text-end">${outputPriceDisplay}</td>
                    <td class="text-end">${contextDisplay}</td>
                    <td class="text-center">
                        ${multimodalDisplay}
                    </td>
                    <td class="text-center">
                        ${costBand ? `<span class="cost-band-indicator ${costBandClass}">${costBand}</span>` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    // Function to handle table sorting
    window.sortPricingTable = function(columnIndex) {
        // If clicking the same column, reverse the sort direction
        if (sortColumn === columnIndex) {
            sortDirection *= -1;
        } else {
            sortColumn = columnIndex;
            sortDirection = 1;
        }
        
        // Update the table with new sort order
        renderPricingTable();
        
        // Update sort icons (optional enhancement)
        document.querySelectorAll('#pricingTable th i').forEach((icon, index) => {
            if (index === sortColumn) {
                icon.className = sortDirection === 1 ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else {
                icon.className = 'fas fa-sort';
            }
        });
    };
    
    // Search functionality for pricing table
    if (document.getElementById('modelSearch')) {
        document.getElementById('modelSearch').addEventListener('input', renderPricingTable);
    }
    
    // Set up automatic periodic refresh (every 4 hours)
    const REFRESH_INTERVAL = 4 * 60 * 60 * 1000; // 4 hours in milliseconds
    // Setup refresh price button handler
    document.getElementById('refreshPricesBtn').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...';
        
        // Call the refresh endpoint
        fetch('/api/refresh_model_prices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("Received refreshed pricing data:", data);
                
                // Convert the prices object to the array format used by the table
                const processedPrices = Object.entries(data.prices).map(([modelId, modelDetails]) => {
                    // Format the model name (use provided name if available, otherwise format the ID)
                    const modelName = modelDetails.model_name || 
                                      modelId.split('/').pop().replace(/-/g, ' ').replace(/(^\w|\s\w)/g, m => m.toUpperCase());
                    
                    // Format prices with appropriate precision
                    // For very small values, show more decimal places
                    let inputPriceStr, outputPriceStr;
                    
                    if (modelDetails.input_price === 0) {
                        inputPriceStr = '$0.00';
                    } else if (modelDetails.input_price < 0.01) {
                        inputPriceStr = `$${modelDetails.input_price.toFixed(4)}`;
                    } else {
                        inputPriceStr = `$${modelDetails.input_price.toFixed(2)}`;
                    }
                    
                    if (modelDetails.output_price === 0) {
                        outputPriceStr = '$0.00';
                    } else if (modelDetails.output_price < 0.01) {
                        outputPriceStr = `$${modelDetails.output_price.toFixed(4)}`;
                    } else {
                        outputPriceStr = `$${modelDetails.output_price.toFixed(2)}`;
                    }
                    
                    return {
                        model_id: modelId,
                        model_name: modelName,
                        input_price: inputPriceStr,
                        output_price: outputPriceStr,
                        context_length: modelDetails.context_length || 'N/A',
                        multimodal: modelDetails.is_multimodal ? 'Yes' : 'No',
                        cost_band: modelDetails.cost_band || ''
                    };
                });
                
                // Update the localStorage cache with the new processed data
                localStorage.setItem('modelPricingData', JSON.stringify(processedPrices));
                localStorage.setItem('modelPricingTimestamp', new Date().getTime().toString());
                
                // Update the pricing table
                pricingData = processedPrices;
                renderPricingTable();
                
                // Update the last updated text
                const lastUpdated = document.getElementById('lastUpdated');
                if (data.last_updated) {
                    const lastUpdatedDate = new Date(data.last_updated);
                    lastUpdated.textContent = `Last updated: ${lastUpdatedDate.toLocaleTimeString()} ${lastUpdatedDate.toLocaleDateString()}`;
                } else {
                    const currentTime = new Date();
                    lastUpdated.textContent = `Last updated: ${currentTime.toLocaleTimeString()} ${currentTime.toLocaleDateString()}`;
                }
                
                // Show success message
                const pricingCard = document.querySelector('#pricing .balance-card');
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success mt-3';
                successAlert.innerHTML = '<i class="fas fa-check-circle me-2"></i> Prices have been refreshed successfully from OpenRouter API.';
                pricingCard.insertBefore(successAlert, pricingCard.firstChild);
                
                // Auto-hide the success message after 5 seconds
                setTimeout(() => {
                    successAlert.remove();
                }, 5000);
            } else {
                // Show error message
                console.error('API returned error:', data.error);
                const pricingCard = document.querySelector('#pricing .balance-card');
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-danger mt-3';
                errorAlert.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i> ${data.error || 'Failed to refresh pricing data. Please try again later.'}`;
                pricingCard.insertBefore(errorAlert, pricingCard.firstChild);
            }
        })
        .catch(error => {
            console.error('Error refreshing pricing data:', error);
            // Show error message
            const pricingCard = document.querySelector('#pricing .balance-card');
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger mt-3';
            errorAlert.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i> Failed to refresh pricing data. Please try again later.';
            pricingCard.insertBefore(errorAlert, pricingCard.firstChild);
        })
        .finally(() => {
            // Re-enable the button
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Refresh Prices';
        });
    });
    
    // Periodic auto-refresh
    setInterval(function() {
        console.log('Auto-refreshing pricing data...');
        // Only refresh if the pricing tab is active or if there's no cached data
        const activeTab = document.querySelectorAll('.tab-pane.active')[0]?.id;
        const cachedTimestamp = localStorage.getItem('modelPricingTimestamp');
        if (activeTab === 'pricing' || !cachedTimestamp) {
            loadPricingData();
        }
    }, REFRESH_INTERVAL);
    
    // Function to sort the pricing table
    window.sortPricingTable = function(column) {
        // Toggle sort direction if clicking the same column
        if (sortColumn === column) {
            sortDirection *= -1;
        } else {
            sortColumn = column;
            sortDirection = 1;
        }
        
        // Update sort icons
        for (let i = 0; i < 6; i++) {
            const icon = document.getElementById(`sort-icon-${i}`);
            if (i === column) {
                icon.className = sortDirection === 1 ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else {
                icon.className = 'fas fa-sort';
            }
        }
        
        renderPricingTable();
    };

    // Load pricing data on page load if we're on the pricing tab
    if (window.location.hash === '#pricing') {
        openTab('pricing');
    }
    
    // Initialize the usage analytics sub-tab functionality
    const handleUsageSubTabs = function() {
        const usageTabButtons = document.querySelectorAll('.usage-tab-button');
        const usageSubTabs = document.querySelectorAll('.usage-sub-tab');
        
        usageTabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Deactivate all tab buttons
                usageTabButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Hide all sub-tabs
                usageSubTabs.forEach(tab => {
                    tab.style.display = 'none';
                });
                
                // Activate the clicked button
                button.classList.add('active');
                
                // Show the selected sub-tab
                const tabToShow = button.getAttribute('data-tab');
                document.getElementById(`usage-${tabToShow}-tab`).style.display = 'block';
            });
        });
    };
    
    // CSV Export functionality
    const handleCsvExport = function() {
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        if (exportCsvBtn) {
            exportCsvBtn.addEventListener('click', function() {
                // Force switch to detailed tab before export
                const detailedButton = document.querySelector('.usage-tab-button[data-tab="detailed"]');
                if (detailedButton) {
                    detailedButton.click();
                }
                
                // Get the detailed table data
                const detailedTab = document.getElementById('usage-detailed-tab');
                if (!detailedTab) return;
                
                // Get the table rows from the detailed tab
                const table = detailedTab.querySelector('table');
                if (!table) {
                    alert('No data available to export');
                    return;
                }
                
                // Get all table headers
                const headers = [];
                const headerCells = table.querySelectorAll('thead th');
                headerCells.forEach(cell => {
                    headers.push(cell.textContent.trim());
                });
                
                // Get all table rows
                const rows = [];
                const tableRows = table.querySelectorAll('tbody tr');
                tableRows.forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach(cell => {
                        rowData.push(cell.textContent.trim().replace('$', ''));
                    });
                    rows.push(rowData);
                });
                
                // Create CSV content
                let csvContent = headers.join(',') + '\n';
                rows.forEach(row => {
                    csvContent += row.join(',') + '\n';
                });
                
                // Create a Blob and download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'usage_analytics_detailed.csv');
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }
    };
    
    // Initialize the usage analytics functionality
    handleUsageSubTabs();
    handleCsvExport();
});
</script>
{% endblock %}