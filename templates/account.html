{% extends "base.html" %}

{% block title %}Account Management{% endblock %}

{% block styles %}
{{ super() }}
<style>
    body {
        background-color: #131416;
        color: #e4e6eb;
        /* Ensure page content scrolls vertically if needed */
        min-height: 100vh;
        overflow-y: auto;
    }
    
    .container {
        max-width: 1000px;
        margin: 0 auto; /* Center content */
    }
    
    .account-header {
        margin-bottom: 1.5rem;
        text-align: center; /* Center the header */
    }
    
    .account-header .d-flex {
        justify-content: space-between;
        align-items: center;
    }
    
    .balance-card {
        background-color: #1e2124;
        border: none;
        border-radius: 8px;
        margin-bottom: 2rem;
        text-align: center; /* Center balance display */
    }
    
    .balance-amount {
        font-size: 2.5rem;
        color: #4cd964;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .caption {
        font-size: 0.9rem;
        opacity: 0.7;
    }
    
    .tab-navigation {
        display: flex;
        justify-content: center; /* Center the tab buttons */
        margin-bottom: 1.5rem;
    }
    
    .tab-button {
        background-color: #1e2124;
        color: #e4e6eb;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        margin-right: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .tab-button:hover {
        background-color: #2a2d31;
    }
    
    .tab-button.active {
        background-color: #17a2b8;
        color: white;
    }
    
    .package-card {
        background-color: #1e2124;
        border: 1px solid #2c2f33;
        border-radius: 8px;
        padding: 1.5rem;
        height: 100%;
        transition: all 0.3s ease;
    }
    
    .package-card:hover {
        /* More subtle hover effect instead of jumping/lifting */
        background-color: #23262a;
        border-color: #17a2b8;
        box-shadow: 0 0 8px rgba(23, 162, 184, 0.3);
    }
    
    .package-title {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 0.5rem;
    }
    
    .package-price {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .package-feature {
        font-size: 0.9rem;
        opacity: 0.7;
        margin-bottom: 0.5rem;
    }
    
    .select-button {
        background-color: #17a2b8;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 0;
        width: 100%;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 1rem;
    }
    
    .select-button:hover {
        background-color: #138496;
    }
    
    .custom-amount-card {
        background-color: #1e2124;
        border: 1px solid #2c2f33;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .custom-amount-title {
        font-size: 1.2rem;
        margin-bottom: 1rem;
    }
    
    .custom-amount-input {
        background-color: #2c2f33;
        border: 1px solid #3f4246;
        color: white;
        border-radius: 6px;
    }
    
    .custom-amount-input::placeholder {
        color: #a0a0a0;
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-top: 1px solid #2c2f33;
    }
    
    .back-to-chat {
        background-color: #17a2b8;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .back-to-chat:hover {
        background-color: #138496;
        color: white;
    }
    
    .tab-content {
        margin-top: 1.5rem;
    }
    
    .tab-pane {
        display: none;
    }
    
    .tab-pane.active {
        display: block;
    }
    
    .purchase-button {
        background-color: #17a2b8;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 10px 0;
        width: 100%;
        cursor: pointer;
        transition: all 0.2s ease;
        display: block;
        margin-top: 1rem;
    }
    
    .purchase-button:hover {
        background-color: #138496;
    }
    
    .purchase-button:disabled {
        background-color: #3f4246;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="account-header d-flex justify-content-between align-items-center">
        <div>
            <h1>Account Management</h1>
            <p class="caption">Manage your account, add funds, and view your usage history</p>
        </div>
        <a href="{{ url_for('index') }}" class="back-to-chat">Back to Chat</a>
    </div>

    <!-- Balance Display -->
    <div class="balance-card p-4">
        <h5>Available Balance</h5>
        <div class="balance-amount">${{ "%.2f"|format(user.get_balance_usd()) }}</div>
        <p class="caption"><i class="fas fa-info-circle"></i> Funds are used for AI model access. Different models have different pricing based on their capabilities and token usage.</p>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" onclick="openTab('funds')">Add Funds</button>
        <button class="tab-button" onclick="openTab('history')">Purchase History</button>
        <button class="tab-button" onclick="openTab('usage')">Usage Analytics</button>
        <button class="tab-button" onclick="openTab('pricing')">Pricing</button>
        <button class="tab-button" onclick="openTab('settings')">Account Settings</button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Add Funds Tab -->
        <div id="funds" class="tab-pane active">
            <!-- Packages -->
            <div class="row">
                {% for package in packages %}
                <div class="col-md-4 mb-4">
                    <div class="package-card">
                        <div class="package-title">{{ "$%.2f"|format(package.amount_usd) }} Package</div>
                        <div class="package-price">${{ "%.2f"|format(package.amount_usd) }}</div>
                        <p class="package-feature">Access to ${{ "%.2f"|format(package.amount_usd) }} worth of AI usage</p>
                        <ul class="list-unstyled">
                            <li class="package-feature">✓ Best value</li>
                            <li class="package-feature">✓ No additional fees</li>
                            <li class="package-feature">✓ Instant delivery</li>
                        </ul>
                        <form action="{{ url_for('billing.purchase_package', package_id=package.id) }}" method="post">
                            <button type="submit" class="select-button">Select</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Custom Amount -->
            <div class="custom-amount-card">
                <div class="custom-amount-title">Custom Amount</div>
                <p class="caption">Enter a custom USD amount to add to your account.</p>
                
                <form action="{{ url_for('billing.purchase_custom') }}" method="post">
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount (USD)</label>
                        <p class="caption mb-1"><i class="fas fa-info-circle"></i> Minimum amount: $5</p>
                        <div class="input-group">
                            <span class="input-group-text bg-dark text-light border-secondary">$</span>
                            <input type="number" id="amount" name="amount" class="form-control custom-amount-input" min="5" max="100" step="0.01" placeholder="Enter amount from $5.00">
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                        <label class="form-check-label caption" for="agreeTerms">
                            PayPal transaction fee applies to all purchases.
                        </label>
                    </div>
                    
                    <div class="mt-3">
                        <div class="total-row">
                            <div>Amount:</div>
                            <div id="amount-display">$0.00</div>
                        </div>
                        <div class="total-row">
                            <div>Fee:</div>
                            <div id="fee-display">$0.00</div>
                        </div>
                        <div class="total-row">
                            <div><strong>Total:</strong></div>
                            <div><strong id="total-display">$0.00</strong></div>
                        </div>
                    </div>
                    
                    <button type="submit" class="purchase-button" id="purchaseBtn" disabled>Top Up Custom Amount</button>
                </form>
            </div>
        </div>
        
        <!-- Purchase History Tab -->
        <div id="history" class="tab-pane">
            <div class="balance-card p-4">
                <h4 class="mb-3">Purchase History</h4>
                
                {% if recent_transactions %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Payment Method</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in recent_transactions %}
                            <tr>
                                <td>{{ transaction.created_at.strftime('%Y-%m-%d') }}</td>
                                <td>${{ "%.2f"|format(transaction.amount_usd) }}</td>
                                <td>{{ transaction.payment_method|capitalize }}</td>
                                <td>
                                    {% if transaction.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% elif transaction.status == 'pending' %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    {% else %}
                                        <span class="badge bg-danger">Failed</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-receipt fa-3x text-muted"></i>
                    </div>
                    <h5>No Purchase History</h5>
                    <p class="caption">You haven't made any purchases yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Usage Analytics Tab -->
        <div id="usage" class="tab-pane">
            <div class="balance-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0">Usage Analytics</h4>
                    <div>
                        <button class="tab-button usage-tab-button active btn-sm" data-tab="summary">Summary</button>
                        <button class="tab-button usage-tab-button btn-sm" data-tab="detailed">Detailed</button>
                        <button class="tab-button btn-sm" id="exportCsvBtn">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h6>Date Range</h6>
                    <div>
                        <button class="tab-button date-range-btn btn-sm" data-range="30">Last 30 Days</button>
                        <button class="tab-button date-range-btn btn-sm" data-range="7">Last 7 Days</button>
                        <button class="tab-button date-range-btn active btn-sm" data-range="month">This Month</button>
                    </div>
                </div>
                
                <div id="usage-summary-tab" class="usage-sub-tab active">
                {% if recent_usage %}
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-dark table-hover table-striped" id="usageSummaryTable">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th style="min-width: 110px; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom py-3">Date</th>
                                <th style="min-width: 80px; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom py-3">Type</th>
                                <th style="min-width: 220px; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom py-3">Model</th>
                                <th style="min-width: 80px; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usage in recent_usage %}
                            <tr>
                                <td class="py-3">{{ usage.created_at.strftime('%Y-%m-%d') }}</td>
                                <td class="py-3">{{ usage.usage_type }}</td>
                                <td class="py-3">{{ usage.model_id }}</td>
                                <td class="text-end py-3">${{ "%.4f"|format(usage.credits_used / 1000) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-chart-line fa-3x text-muted"></i>
                    </div>
                    <h5>No Usage Data</h5>
                    <p class="caption">No usage data available for the selected time period.</p>
                    <p class="caption">Try a different date range or start using the AI models to generate usage data.</p>
                    <a href="{{ url_for('index') }}" class="select-button mt-2 w-auto d-inline-block px-4">Try Using Models</a>
                </div>
                {% endif %}
                </div>

                <div id="usage-detailed-tab" class="usage-sub-tab" style="display: none;">
                {% if recent_usage %}
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-dark table-hover table-striped" id="usageDetailedTable">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th style="min-width: 110px; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom py-3">Date</th>
                                <th style="min-width: 220px; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom py-3">Model</th>
                                <th style="min-width: 100px; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">Input Tokens</th>
                                <th style="min-width: 100px; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">Input Cost</th>
                                <th style="min-width: 100px; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">Output Tokens</th>
                                <th style="min-width: 100px; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">Output Cost</th>
                                <th style="min-width: 100px; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usage in recent_usage %}
                            <tr>
                                <td class="py-3">{{ usage.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td class="py-3">{{ usage.model_id }}</td>
                                <td class="text-end py-3">{{ usage.prompt_tokens if usage.prompt_tokens else 'N/A' }}</td>
                                <td class="text-end py-3">
                                    {% if usage.prompt_tokens and usage.model_id %}
                                        {% set input_cost = ((usage.credits_used / 1000) * 0.7)|float %}
                                        ${{ "%.4f"|format(input_cost) }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td class="text-end py-3">{{ usage.completion_tokens if usage.completion_tokens else 'N/A' }}</td>
                                <td class="text-end py-3">
                                    {% if usage.completion_tokens and usage.model_id %}
                                        {% set output_cost = ((usage.credits_used / 1000) * 0.3)|float %}
                                        ${{ "%.4f"|format(output_cost) }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td class="text-end py-3">${{ "%.4f"|format(usage.credits_used / 1000) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-chart-line fa-3x text-muted"></i>
                    </div>
                    <h5>No Usage Data</h5>
                    <p class="caption">No usage data available for the selected time period.</p>
                    <p class="caption">Try a different date range or start using the AI models to generate usage data.</p>
                    <a href="{{ url_for('index') }}" class="select-button mt-2 w-auto d-inline-block px-4">Try Using Models</a>
                </div>
                {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Pricing Tab -->
        <div id="pricing" class="tab-pane">
            <div class="balance-card p-4">
                <h4 class="mb-3">Model Pricing</h4>
                <p class="caption mb-4">Pricing information for all available AI models. Click on any column header to sort by that attribute.</p>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span id="lastUpdated" class="caption"></span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-search text-muted me-2"></i>
                        <input type="text" class="form-control custom-amount-input" id="modelSearch" placeholder="Search models...">
                    </div>
                </div>
                
                <div class="mt-3 mb-2">
                    <span class="caption">• Prices are per million tokens • All prices include our platform fee</span>
                </div>
                
                <div class="table-responsive mt-2" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-dark table-hover table-striped" id="pricingTable">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th onclick="sortPricingTable(0)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        Model <i id="sort-icon-0" class="fas fa-sort-up"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(1)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">
                                    <div class="d-flex justify-content-end align-items-center">
                                        Input Cost <i id="sort-icon-1" class="fas fa-sort"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(2)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">
                                    <div class="d-flex justify-content-end align-items-center">
                                        Output Cost <i id="sort-icon-2" class="fas fa-sort"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(3)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-end py-3">
                                    <div class="d-flex justify-content-end align-items-center">
                                        Context <i id="sort-icon-3" class="fas fa-sort"></i>
                                    </div>
                                </th>
                                <th onclick="sortPricingTable(4)" style="cursor:pointer; position: sticky; top: 0; z-index: 10; background-color: #212529;" class="border-bottom text-center py-3">
                                    <div class="d-flex justify-content-center align-items-center">
                                        Multimodal <i id="sort-icon-4" class="fas fa-sort"></i>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="pricingTableBody">
                            <tr>
                                <td colspan="5" class="text-center py-5">
                                    <div class="d-flex flex-column align-items-center">
                                        <div class="spinner-border text-info mb-3" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="caption">Loading pricing data from OpenRouter...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <style>
                /* Shared table styles for all tables in the account page */
                .table-dark tbody tr {
                    transition: background-color 0.15s ease-in-out;
                }
                
                .table-dark tbody tr:hover {
                    background-color: rgba(255, 255, 255, 0.1) !important;
                }
                
                .table-dark td {
                    padding: 0.75rem 1rem;
                    vertical-align: middle;
                }
                
                /* Specific pricing table styles */
                #pricingTable tbody tr {
                    transition: background-color 0.15s ease-in-out;
                }
                
                #pricingTable tbody tr:hover {
                    background-color: rgba(255, 255, 255, 0.1) !important;
                }
                
                #pricingTable td {
                    padding: 0.75rem 1rem;
                    vertical-align: middle;
                }
                
                /* Usage analytics table styles */
                #usageSummaryTable tbody tr,
                #usageDetailedTable tbody tr {
                    transition: background-color 0.15s ease-in-out;
                }
                
                #usageSummaryTable tbody tr:hover,
                #usageDetailedTable tbody tr:hover {
                    background-color: rgba(255, 255, 255, 0.1) !important;
                }
                
                #usageSummaryTable td,
                #usageDetailedTable td {
                    padding: 0.75rem 1rem;
                    vertical-align: middle;
                }
                
                /* Tooltip styles */
                .tooltip-container {
                    position: relative;
                    display: inline-block;
                }
                
                .tooltip-container .tooltip-text {
                    visibility: hidden;
                    background-color: #333;
                    color: #fff;
                    text-align: center;
                    border-radius: 6px;
                    padding: 8px 12px;
                    position: absolute;
                    z-index: 1;
                    bottom: 125%;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 220px;
                    opacity: 0;
                    transition: opacity 0.3s;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                    font-size: 0.8rem;
                }
                
                .tooltip-container:hover .tooltip-text {
                    visibility: visible;
                    opacity: 1;
                }
                </style>
                
                <!-- Error message removed as requested -->
                
                <div class="mt-3">
                    <p class="caption text-muted"><i class="fas fa-info-circle"></i> The pricing information is fetched directly from OpenRouter and our internal pricing configuration. Prices may vary based on model updates and availability.</p>
                </div>
            </div>
        </div>
        
        <!-- Account Settings Tab -->
        <div id="settings" class="tab-pane">
            <div class="balance-card p-4">
                <h4 class="mb-4">Account Settings</h4>
                
                <form>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control custom-amount-input" id="username" value="{{ user.username }}" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control custom-amount-input" id="email" value="{{ user.email }}" readonly>
                    </div>
                    
                    <hr class="my-4" style="border-color: #3f4246;">
                    
                    <h5>Notification Preferences</h5>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="emailNotifications" checked>
                        <label class="form-check-label" for="emailNotifications">Receive email notifications</label>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="lowBalanceAlerts" checked>
                        <label class="form-check-label" for="lowBalanceAlerts">Low balance alerts</label>
                    </div>
                    
                    <hr class="my-4" style="border-color: #3f4246;">
                    
                    <h5>Model Filter Settings</h5>
                    <p class="caption mb-3">Set maximum cost limits to filter which AI models are displayed in the chat interface.</p>
                    
                    <div class="card p-4 mb-4" style="background-color: #1e2124; border-color: #2c2f33;">
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="maxInputCost" class="form-label h6 mb-0">Max Input Token Cost</label>
                                <span class="caption text-muted">per million tokens</span>
                            </div>
                            
                            <div class="d-flex align-items-center gap-3">
                                <div style="flex-grow: 1;">
                                    <input type="range" class="form-range custom-range" id="maxInputCost" min="0" max="100" value="100" style="height: 16px;">
                                </div>
                                <div class="input-group" style="width: 150px;">
                                    <span class="input-group-text bg-dark text-light border-secondary">$</span>
                                    <input type="number" id="maxInputCostValue" class="form-control custom-amount-input" value="1500" min="0.01" max="1500" step="0.01">
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-1">
                                <span class="caption">$0.01</span>
                                <span class="caption">$1500</span>
                            </div>
                            <div class="mt-2">
                                <p class="caption" id="inputCostExplainer">
                                    Models with input costs above $1500 per million tokens will be disabled in model selection.
                                </p>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="maxOutputCost" class="form-label h6 mb-0">Max Output Token Cost</label>
                                <span class="caption text-muted">per million tokens</span>
                            </div>
                            
                            <div class="d-flex align-items-center gap-3">
                                <div style="flex-grow: 1;">
                                    <input type="range" class="form-range custom-range" id="maxOutputCost" min="0" max="100" value="100" style="height: 16px;">
                                </div>
                                <div class="input-group" style="width: 150px;">
                                    <span class="input-group-text bg-dark text-light border-secondary">$</span>
                                    <input type="number" id="maxOutputCostValue" class="form-control custom-amount-input" value="1500" min="0.01" max="1500" step="0.01">
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-1">
                                <span class="caption">$0.01</span>
                                <span class="caption">$1500</span>
                            </div>
                            <div class="mt-2">
                                <p class="caption" id="outputCostExplainer">
                                    Models with output costs above $1500 per million tokens will be disabled in model selection.
                                </p>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-3 gap-3">
                            <button type="button" class="select-button" id="saveFilterSettingsBtn">
                                <i class="fas fa-save me-2"></i>Save Filter Settings
                            </button>
                            <a href="/?from_settings=true" class="select-button text-center" style="background-color: #6c757d; text-decoration: none;">
                                <i class="fas fa-arrow-left me-2"></i>Return to Chat
                            </a>
                        </div>
                    </div>
                    
                    <!-- Feedback Container -->
                    <div id="filterFeedbackContainer" class="mt-3" style="min-height: 60px;"></div>
                    
                    <hr class="my-4" style="border-color: #3f4246;">
                    
                    <h5>Danger Zone</h5>
                    <p class="caption">These actions cannot be undone. Please proceed with caution.</p>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="select-button bg-danger">Delete Account</button>
                        <button type="button" class="select-button" style="background-color: #fd7e14;">Export My Data</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Model Pricing Information -->
    <div class="balance-card p-4 mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-3">Popular Model Pricing</h5>
                <p class="caption">Your account balance is used to access premium AI models. Different models have different pricing based on their capabilities.</p>
            </div>
            <button class="tab-button" onclick="openTab('pricing')">View all model prices</button>
        </div>
        
        <div class="table-responsive mt-3">
            <table class="table table-dark table-sm">
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>Cost per 1K tokens</th>
                        <th>Approximate usage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>GPT-3.5</td>
                        <td>$0.0003</td>
                        <td>~3,000 messages with $1</td>
                    </tr>
                    <tr>
                        <td>Claude-3 Haiku</td>
                        <td>$0.003</td>
                        <td>~300 messages with $1</td>
                    </tr>
                    <tr>
                        <td>Gemini 1.5 Pro</td>
                        <td>$0.01</td>
                        <td>~100 messages with $1</td>
                    </tr>
                    <tr>
                        <td>Claude-3 Sonnet</td>
                        <td>$0.015</td>
                        <td>~70 messages with $1</td>
                    </tr>
                    <tr>
                        <td>Claude-3 Opus</td>
                        <td>$0.045</td>
                        <td>~25 messages with $1</td>
                    </tr>
                    <tr>
                        <td>GPT-4</td>
                        <td>$0.06</td>
                        <td>~18 messages with $1</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-2">
            <small class="caption">* Actual cost depends on message length and complexity.</small>
            <a href="#" onclick="openTab('pricing'); return false;" class="caption text-info">See full pricing details <i class="fas fa-arrow-right"></i></a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Custom amount calculator
    const amountInput = document.getElementById('amount');
    const amountDisplay = document.getElementById('amount-display');
    const feeDisplay = document.getElementById('fee-display');
    const totalDisplay = document.getElementById('total-display');
    const purchaseBtn = document.getElementById('purchaseBtn');
    const agreeTerms = document.getElementById('agreeTerms');
    
    function updateAmounts() {
        const amount = parseFloat(amountInput.value) || 0;
        const fee = amount > 0 ? Math.max(0.30, amount * 0.029) : 0;
        const total = amount + fee;
        
        amountDisplay.textContent = '$' + amount.toFixed(2);
        feeDisplay.textContent = '$' + fee.toFixed(2);
        totalDisplay.textContent = '$' + total.toFixed(2);
        
        // Disable or enable purchase button based on valid amount (min $5)
        purchaseBtn.disabled = amount < 5 || !agreeTerms.checked;
    }
    
    amountInput.addEventListener('input', updateAmounts);
    agreeTerms.addEventListener('change', updateAmounts);
    updateAmounts();
    
    // Initialize tabs
    window.openTab = function(tabName) {
        // Hide all tab panes
        const tabPanes = document.querySelectorAll('.tab-pane');
        tabPanes.forEach(pane => {
            pane.classList.remove('active');
        });
        
        // Deactivate all tab buttons
        const tabButtons = document.querySelectorAll('.tab-navigation .tab-button');
        tabButtons.forEach(button => {
            button.classList.remove('active');
        });
        
        // Activate the selected tab pane
        document.getElementById(tabName).classList.add('active');
        
        // Activate the clicked button
        event.currentTarget.classList.add('active');
        
        // Load pricing data if the pricing tab is selected
        if (tabName === 'pricing') {
            loadPricingData();
        }
    }
    
    // Model Pricing Table functionality
    let pricingData = [];
    let sortColumn = 0;
    let sortDirection = 1; // 1 for ascending, -1 for descending
    
    // Function to load pricing data from API
    function loadPricingData() {
        const pricingTableBody = document.getElementById('pricingTableBody');
        const lastUpdated = document.getElementById('lastUpdated');
        
        // Show loading state
        pricingTableBody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-5">
                    <div class="d-flex flex-column align-items-center">
                        <div class="spinner-border text-info mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="caption">Loading pricing data from OpenRouter...</p>
                    </div>
                </td>
            </tr>
        `;
        
        // Check for cached data first (localStorage)
        const cachedData = localStorage.getItem('modelPricingData');
        const cachedTimestamp = localStorage.getItem('modelPricingTimestamp');
        const currentTime = new Date().getTime();
        
        // Use cached data if it's less than 4 hours old
        if (cachedData && cachedTimestamp && (currentTime - parseInt(cachedTimestamp)) < 4 * 60 * 60 * 1000) {
            try {
                pricingData = JSON.parse(cachedData);
                lastUpdated.textContent = `Last updated: ${new Date(parseInt(cachedTimestamp)).toLocaleTimeString()}`;
                renderPricingTable();
                return;
            } catch (e) {
                console.error('Error parsing cached pricing data:', e);
                // Continue to fetch from API if parsing fails
            }
        }
        
        // Fetch data from API
        fetch('/api/model-pricing')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch pricing data');
                }
                return response.json();
            })
            .then(data => {
                // Check for API error response
                if (data.error) {
                    console.warn('API returned an error:', data.error);
                    // Log error but don't show any alert to the user
                    
                    // Try to use fallback data if provided in the response
                    if (data.data && data.data.length > 0) {
                        pricingData = data.data;
                        renderPricingTable();
                    } 
                    // Otherwise try to use cached data if available
                    else if (cachedData) {
                        try {
                            pricingData = JSON.parse(cachedData);
                            renderPricingTable();
                            console.log('Using cached data as fallback');
                        } catch (e) {
                            console.error('Failed to parse cached data:', e);
                            // Show empty state instead of error
                            pricingTableBody.innerHTML = `
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <p class="caption">No pricing data available. Please try again later.</p>
                                    </td>
                                </tr>
                            `;
                        }
                    } else {
                        // No data available at all - show empty state
                        pricingTableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center py-5">
                                    <p class="caption">No pricing data available. Please try again later.</p>
                                </td>
                            </tr>
                        `;
                    }
                    return;
                }
                
                // Normal successful response
                pricingData = data.data;
                
                // Store in localStorage for caching
                try {
                    localStorage.setItem('modelPricingData', JSON.stringify(pricingData));
                    localStorage.setItem('modelPricingTimestamp', new Date().getTime().toString());
                } catch (e) {
                    console.warn('Could not store pricing data in localStorage:', e);
                }
                
                // Remove any existing alert
                const existingAlert = document.querySelector('#pricing .alert');
                if (existingAlert) existingAlert.remove();
                
                // Render the table
                renderPricingTable();
                const currentTime = new Date();
                lastUpdated.textContent = `Last updated: ${currentTime.toLocaleTimeString()} ${currentTime.toLocaleDateString()}`;
            })
            .catch(error => {
                console.error('Error loading pricing data:', error);
                
                // Try to use cached data if available
                if (cachedData) {
                    try {
                        pricingData = JSON.parse(cachedData);
                        renderPricingTable();
                        
                        // Update the last updated timestamp to show it's cached data
                        const lastUpdated = document.getElementById('lastUpdated');
                        lastUpdated.textContent = `Last updated: ${new Date(parseInt(cachedTimestamp)).toLocaleString()} (cached)`;
                        
                        // Remove any existing alert
                        const existingAlert = document.querySelector('#pricing .alert');
                        if (existingAlert) existingAlert.remove();
                        return;
                    } catch (e) {
                        console.error('Failed to use cached data:', e);
                    }
                }
                
                // No cached data or failed to parse it - show empty state
                pricingTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <p class="caption">No pricing data available. Please try again later.</p>
                        </td>
                    </tr>
                `;
            });
    }
    
    // Function to render the pricing table
    function renderPricingTable() {
        const pricingTableBody = document.getElementById('pricingTableBody');
        const searchTerm = document.getElementById('modelSearch')?.value.toLowerCase() || '';
        
        // Filter data based on search term
        const filteredData = pricingData.filter(model => 
            model.model_name.toLowerCase().includes(searchTerm) || 
            model.model_id.toLowerCase().includes(searchTerm)
        );
        
        // Sort data
        filteredData.sort((a, b) => {
            let aValue, bValue;
            
            // Check for special cases
            const aIsAutoRouter = a.model_id.toLowerCase().includes('router') || a.model_id.toLowerCase().includes('openrouter');
            const bIsAutoRouter = b.model_id.toLowerCase().includes('router') || b.model_id.toLowerCase().includes('openrouter');
            const aIsFreeModel = a.input_price === '$0.00' && a.output_price === '$0.00';
            const bIsFreeModel = b.input_price === '$0.00' && b.output_price === '$0.00';
            
            // Handle different columns
            switch(sortColumn) {
                case 0: // Model Name
                    aValue = a.model_name.toLowerCase();
                    bValue = b.model_name.toLowerCase();
                    break;
                    
                case 1: // Input Cost
                    // Special handling for pricing sorts
                    if (a.input_price === 'Variable' || aIsAutoRouter) {
                        // For AutoRouter models, sort them between free and paid models
                        aValue = 0.00005; 
                    } else if (a.input_price === 'N/A') {
                        // Treat N/A as $0.00 for sorting
                        aValue = 0;
                    } else {
                        // Parse all prices as numbers for sorting
                        aValue = parseFloat(a.input_price.replace('$', ''));
                        // Make sure $0.00 values are treated as 0 for sorting
                        if (isNaN(aValue)) aValue = 0;
                    }
                    
                    if (b.input_price === 'Variable' || bIsAutoRouter) {
                        bValue = 0.00005;
                    } else if (b.input_price === 'N/A') {
                        // Treat N/A as $0.00 for sorting
                        bValue = 0;
                    } else {
                        bValue = parseFloat(b.input_price.replace('$', ''));
                        // Make sure $0.00 values are treated as 0 for sorting
                        if (isNaN(bValue)) bValue = 0;
                    }
                    break;
                    
                case 2: // Output Cost
                    // Special handling for output cost sorting
                    if (a.output_price === 'Variable' || aIsAutoRouter) {
                        aValue = 0.00005;
                    } else if (a.output_price === 'N/A') {
                        // Treat N/A as $0.00 for sorting
                        aValue = 0;
                    } else {
                        aValue = parseFloat(a.output_price.replace('$', ''));
                        // Make sure $0.00 values are treated as 0 for sorting
                        if (isNaN(aValue)) aValue = 0;
                    }
                    
                    if (b.output_price === 'Variable' || bIsAutoRouter) {
                        bValue = 0.00005;
                    } else if (b.output_price === 'N/A') {
                        // Treat N/A as $0.00 for sorting
                        bValue = 0;
                    } else {
                        bValue = parseFloat(b.output_price.replace('$', ''));
                        // Make sure $0.00 values are treated as 0 for sorting
                        if (isNaN(bValue)) bValue = 0;
                    }
                    break;
                    
                case 3: // Context Length
                    // Context length sorting with proper handling for N/A values
                    aValue = a.context_length === 'N/A' ? 0 : parseInt(a.context_length);
                    bValue = b.context_length === 'N/A' ? 0 : parseInt(b.context_length);
                    break;
                    
                case 4: // Multimodal (previously case 5)
                    // Yes comes before No for multimodal sorting
                    aValue = a.multimodal === 'Yes' ? 0 : 1;
                    bValue = b.multimodal === 'Yes' ? 0 : 1;
                    break;
                    
                default:
                    aValue = a.model_name.toLowerCase();
                    bValue = b.model_name.toLowerCase();
            }
            
            // Compare values based on sort direction
            if (aValue < bValue) return -1 * sortDirection;
            if (aValue > bValue) return 1 * sortDirection;
            
            // If values are equal, use model name as secondary sort
            const aName = a.model_name.toLowerCase();
            const bName = b.model_name.toLowerCase();
            if (aName < bName) return -1;
            if (aName > bName) return 1;
            return 0;
        });
        
        // Generate table content
        if (filteredData.length === 0) {
            pricingTableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <p class="caption">No matching models found.</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        pricingTableBody.innerHTML = filteredData.map(model => {
            // Check for special model types
            const isAutoRouter = model.model_id.toLowerCase().includes('router') || model.model_id.toLowerCase().includes('openrouter');
            // Check for free models - looking for $0.00 prices or very low values (for rounding issues)
            const inputPrice = parseFloat(model.input_price?.replace('$', '') || '0');
            const outputPrice = parseFloat(model.output_price?.replace('$', '') || '0');
            const isFreeModel = (model.input_price === '$0.00' || inputPrice === 0 || inputPrice <= 0.001) &&
                               (model.output_price === '$0.00' || outputPrice === 0 || outputPrice <= 0.001);
            const isEmbedding = model.model_id === 'text-embedding-3-large';
            
            // Handle model name display with appropriate styling
            let modelNameClass = '';
            if (isAutoRouter) modelNameClass = 'text-warning';
            else if (isEmbedding) modelNameClass = 'text-warning';
            else if (model.multimodal === 'Yes') modelNameClass = 'text-info';
            
            // No badges needed for the model display
            const isGoodValue = !isAutoRouter && !isFreeModel && 
                              model.input_price !== 'N/A' && model.input_price !== 'Variable' &&
                              parseFloat(model.input_price.replace('$', '')) < 10.0;
            
            // Handle price display
            let inputPriceDisplay = model.input_price;
            let outputPriceDisplay = model.output_price;
            
            // Format for AutoRouter with tooltip explanation
            if (isAutoRouter) {
                inputPriceDisplay = `
                    <span class="tooltip-container">
                        <span class="fw-bold text-warning">Variable</span>
                        <span class="tooltip-text">AutoRouter dynamically selects a model based on quality and cost at the time of your request.</span>
                    </span>`;
                outputPriceDisplay = `
                    <span class="tooltip-container">
                        <span class="fw-bold text-warning">Variable</span>
                        <span class="tooltip-text">Costs vary based on the selected model.</span>
                    </span>`;
            }
            
            // Format free models with green color
            if (isFreeModel) {
                inputPriceDisplay = `<span class="text-success">$0.00</span>`;
                outputPriceDisplay = `<span class="text-success">$0.00</span>`;
            }
            
            // Determine if costs should have special color for good value models
            const goodPriceClass = isGoodValue ? 'text-success' : '';
            if (isGoodValue && !isAutoRouter && !isFreeModel) {
                inputPriceDisplay = `<span class="${goodPriceClass}">${model.input_price}</span>`;
            }
            
            // Format context length with K or M suffix
            let contextDisplay = model.context_length;
            if (model.context_length !== 'N/A' && !isNaN(model.context_length)) {
                const contextNum = parseInt(model.context_length);
                contextDisplay = contextNum >= 1000000 
                    ? `${(contextNum / 1000000).toFixed(1)}M` 
                    : `${(contextNum / 1000).toFixed(0)}K`;
            }
            
            // Create multimodal badge/label for the dedicated column
            const multimodalDisplay = model.multimodal === 'Yes' 
                ? '<span class="badge bg-success">Yes</span>' 
                : '<span class="badge bg-secondary">No</span>';
            
            return `
                <tr>
                    <td>
                        <div>
                            <span class="${modelNameClass} fw-medium">${model.model_name}</span>
                        </div>
                        <small class="text-muted d-block text-truncate" style="max-width: 250px;">${model.model_id}</small>
                    </td>
                    <td class="text-end">${inputPriceDisplay}</td>
                    <td class="text-end">${outputPriceDisplay}</td>
                    <td class="text-end">${contextDisplay}</td>
                    <td class="text-center">
                        ${multimodalDisplay}
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    // Function to handle table sorting
    window.sortPricingTable = function(columnIndex) {
        // If clicking the same column, reverse the sort direction
        if (sortColumn === columnIndex) {
            sortDirection *= -1;
        } else {
            sortColumn = columnIndex;
            sortDirection = 1;
        }
        
        // Update the table with new sort order
        renderPricingTable();
        
        // Update sort icons (optional enhancement)
        document.querySelectorAll('#pricingTable th i').forEach((icon, index) => {
            if (index === sortColumn) {
                icon.className = sortDirection === 1 ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else {
                icon.className = 'fas fa-sort';
            }
        });
    };
    
    // Search functionality for pricing table
    if (document.getElementById('modelSearch')) {
        document.getElementById('modelSearch').addEventListener('input', renderPricingTable);
    }
    
    // Set up automatic periodic refresh (every 4 hours)
    const REFRESH_INTERVAL = 4 * 60 * 60 * 1000; // 4 hours in milliseconds
    setInterval(function() {
        console.log('Auto-refreshing pricing data...');
        // Only refresh if the pricing tab is active or if there's no cached data
        const activeTab = document.querySelectorAll('.tab-pane.active')[0]?.id;
        const cachedTimestamp = localStorage.getItem('modelPricingTimestamp');
        if (activeTab === 'pricing' || !cachedTimestamp) {
            loadPricingData();
        }
    }, REFRESH_INTERVAL);
    
    // Function to sort the pricing table
    window.sortPricingTable = function(column) {
        // Toggle sort direction if clicking the same column
        if (sortColumn === column) {
            sortDirection *= -1;
        } else {
            sortColumn = column;
            sortDirection = 1;
        }
        
        // Update sort icons
        for (let i = 0; i < 5; i++) {
            const icon = document.getElementById(`sort-icon-${i}`);
            if (i === column) {
                icon.className = sortDirection === 1 ? 'fas fa-sort-up' : 'fas fa-sort-down';
            } else {
                icon.className = 'fas fa-sort';
            }
        }
        
        renderPricingTable();
    };

    // Load pricing data on page load if we're on the pricing tab
    if (window.location.hash === '#pricing') {
        openTab('pricing');
    }
    
    // Initialize the usage analytics sub-tab functionality
    const handleUsageSubTabs = function() {
        const usageTabButtons = document.querySelectorAll('.usage-tab-button');
        const usageSubTabs = document.querySelectorAll('.usage-sub-tab');
        
        usageTabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Deactivate all tab buttons
                usageTabButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Hide all sub-tabs
                usageSubTabs.forEach(tab => {
                    tab.style.display = 'none';
                });
                
                // Activate the clicked button
                button.classList.add('active');
                
                // Show the selected sub-tab
                const tabToShow = button.getAttribute('data-tab');
                document.getElementById(`usage-${tabToShow}-tab`).style.display = 'block';
            });
        });
    };
    
    // CSV Export functionality
    const handleCsvExport = function() {
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        if (exportCsvBtn) {
            exportCsvBtn.addEventListener('click', function() {
                // Force switch to detailed tab before export
                const detailedButton = document.querySelector('.usage-tab-button[data-tab="detailed"]');
                if (detailedButton) {
                    detailedButton.click();
                }
                
                // Get the detailed table data
                const detailedTab = document.getElementById('usage-detailed-tab');
                if (!detailedTab) return;
                
                // Get the table rows from the detailed tab
                const table = detailedTab.querySelector('table');
                if (!table) {
                    alert('No data available to export');
                    return;
                }
                
                // Get all table headers
                const headers = [];
                const headerCells = table.querySelectorAll('thead th');
                headerCells.forEach(cell => {
                    headers.push(cell.textContent.trim());
                });
                
                // Get all table rows
                const rows = [];
                const tableRows = table.querySelectorAll('tbody tr');
                tableRows.forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach(cell => {
                        rowData.push(cell.textContent.trim().replace('$', ''));
                    });
                    rows.push(rowData);
                });
                
                // Create CSV content
                let csvContent = headers.join(',') + '\n';
                rows.forEach(row => {
                    csvContent += row.join(',') + '\n';
                });
                
                // Create a Blob and download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'usage_analytics_detailed.csv');
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }
    };
    
    // Initialize the usage analytics functionality
    handleUsageSubTabs();
    handleCsvExport();
    
    // Model Filter Sliders Functionality
    const handleModelFilterSliders = function() {
        const maxInputCostSlider = document.getElementById('maxInputCost');
        const maxOutputCostSlider = document.getElementById('maxOutputCost');
        const maxInputCostValue = document.getElementById('maxInputCostValue');
        const maxOutputCostValue = document.getElementById('maxOutputCostValue');
        const inputCostExplainer = document.getElementById('inputCostExplainer');
        const outputCostExplainer = document.getElementById('outputCostExplainer');
        const saveFilterSettingsBtn = document.getElementById('saveFilterSettings');
        const filterFeedbackContainer = document.getElementById('filterFeedbackContainer');
        
        // Constants for slider range
        const MIN_COST = 0.01;  // $0.01 per million tokens
        const MAX_INPUT_COST = 1500.0;  // $1500 per million tokens
        const MAX_OUTPUT_COST = 1500.0; // $1500 per million tokens
        
        // Logarithmic scale conversion functions
        const sliderToInputCost = function(sliderValue) {
            // Convert slider value (0-100) to logarithmic scale between MIN_COST and MAX_INPUT_COST
            const minLog = Math.log10(MIN_COST);
            const maxLog = Math.log10(MAX_INPUT_COST);
            const scale = (maxLog - minLog) / 100;
            return Math.pow(10, minLog + scale * sliderValue);
        };
        
        const sliderToOutputCost = function(sliderValue) {
            // Convert slider value (0-100) to logarithmic scale between MIN_COST and MAX_OUTPUT_COST
            const minLog = Math.log10(MIN_COST);
            const maxLog = Math.log10(MAX_OUTPUT_COST);
            const scale = (maxLog - minLog) / 100;
            return Math.pow(10, minLog + scale * sliderValue);
        };
        
        const inputCostToSlider = function(costValue) {
            // Make sure the cost value is within bounds
            costValue = Math.max(MIN_COST, Math.min(MAX_INPUT_COST, costValue));
            
            // Convert cost value to slider position (0-100)
            const minLog = Math.log10(MIN_COST);
            const maxLog = Math.log10(MAX_INPUT_COST);
            const scale = (maxLog - minLog) / 100;
            return (Math.log10(costValue) - minLog) / scale;
        };
        
        const outputCostToSlider = function(costValue) {
            // Make sure the cost value is within bounds
            costValue = Math.max(MIN_COST, Math.min(MAX_OUTPUT_COST, costValue));
            
            // Convert cost value to slider position (0-100)
            const minLog = Math.log10(MIN_COST);
            const maxLog = Math.log10(MAX_OUTPUT_COST);
            const scale = (maxLog - minLog) / 100;
            return (Math.log10(costValue) - minLog) / scale;
        };
        
        // Update values and explanations
        const updateInputCostUI = function(value) {
            if (typeof value === 'string') {
                value = parseFloat(value);
            }
            // Clamp value to valid range
            value = Math.max(MIN_COST, Math.min(MAX_INPUT_COST, value));
            
            // Update numeric input field (to 2 decimal places for display)
            maxInputCostValue.value = value.toFixed(2);
            
            // Update explainer text
            inputCostExplainer.textContent = `Models with input costs above $${value.toFixed(2)} per million tokens will be disabled in model selection.`;
        };
        
        const updateOutputCostUI = function(value) {
            if (typeof value === 'string') {
                value = parseFloat(value);
            }
            // Clamp value to valid range
            value = Math.max(MIN_COST, Math.min(MAX_OUTPUT_COST, value));
            
            // Update numeric input field (to 2 decimal places for display)
            maxOutputCostValue.value = value.toFixed(2);
            
            // Update explainer text
            outputCostExplainer.textContent = `Models with output costs above $${value.toFixed(2)} per million tokens will be disabled in model selection.`;
        };
        
        // Function to show feedback
        const showFeedback = function(message, isSuccess = true) {
            // Clear any existing feedback
            filterFeedbackContainer.innerHTML = '';
            
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'notification-card';
            feedbackDiv.style.animation = 'fadeInAndSlide 0.4s ease-out';
            feedbackDiv.style.backgroundColor = isSuccess ? 'rgba(46, 204, 113, 0.15)' : 'rgba(231, 76, 60, 0.15)';
            feedbackDiv.style.borderLeft = `4px solid ${isSuccess ? '#2ecc71' : '#e74c3c'}`;
            feedbackDiv.style.padding = '15px';
            feedbackDiv.style.paddingRight = '35px'; // Extra space for the close button
            feedbackDiv.style.borderRadius = '6px';
            feedbackDiv.style.marginBottom = '16px';
            feedbackDiv.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
            feedbackDiv.style.display = 'flex';
            feedbackDiv.style.alignItems = 'center';
            feedbackDiv.style.position = 'relative'; // For absolute positioning of close button
            feedbackDiv.style.maxWidth = '95%';
            feedbackDiv.style.transition = 'all 0.2s ease-in-out';
            
            const icon = document.createElement('i');
            icon.className = isSuccess ? 'fas fa-check-circle me-2' : 'fas fa-exclamation-circle me-2';
            icon.style.color = isSuccess ? '#2ecc71' : '#e74c3c';
            icon.style.fontSize = '18px';
            feedbackDiv.appendChild(icon);
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            messageSpan.style.fontWeight = '500';
            feedbackDiv.appendChild(messageSpan);
            
            // Add a close button
            const closeButton = document.createElement('button');
            closeButton.className = 'btn-close btn-close-white';
            closeButton.style.position = 'absolute';
            closeButton.style.right = '10px';
            closeButton.style.top = '10px';
            closeButton.style.fontSize = '0.8rem';
            closeButton.style.opacity = '0.7';
            closeButton.style.background = 'transparent';
            closeButton.style.border = 'none';
            closeButton.style.cursor = 'pointer';
            closeButton.setAttribute('aria-label', 'Close');
            closeButton.onmouseover = function() {
                closeButton.style.opacity = '1';
            };
            closeButton.onmouseout = function() {
                closeButton.style.opacity = '0.7';
            };
            closeButton.onclick = function() { 
                feedbackDiv.style.animation = 'fadeOut 0.3s';
                setTimeout(() => {
                    filterFeedbackContainer.removeChild(feedbackDiv);
                }, 300);
            };
            feedbackDiv.appendChild(closeButton);
            
            filterFeedbackContainer.appendChild(feedbackDiv);
            
            // Add animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInAndSlide {
                    from { opacity: 0; transform: translateY(-10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                @keyframes fadeOut {
                    from { opacity: 1; transform: translateY(0); }
                    to { opacity: 0; transform: translateY(-10px); }
                }
            `;
            document.head.appendChild(style);
            
            // Scroll to make sure feedback is visible
            feedbackDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Auto dismiss after 5 seconds for success messages
            if (isSuccess) {
                setTimeout(() => {
                    if (feedbackDiv.parentNode === filterFeedbackContainer) {
                        feedbackDiv.style.animation = 'fadeOut 0.5s forwards';
                        setTimeout(() => {
                            if (feedbackDiv.parentNode === filterFeedbackContainer) {
                                filterFeedbackContainer.removeChild(feedbackDiv);
                            }
                        }, 500);
                    }
                }, 5000);
            }
        };
        
        // Preview models affected counter
        let previewDebounceTimer;
        const previewContainer = document.createElement('div');
        previewContainer.id = 'filter-preview-container';
        previewContainer.style.marginTop = '10px';
        previewContainer.style.fontSize = '0.9rem';
        previewContainer.style.padding = '8px 12px';
        previewContainer.style.borderRadius = '6px';
        previewContainer.style.backgroundColor = 'rgba(255, 213, 79, 0.1)';
        previewContainer.style.border = '1px solid rgba(255, 213, 79, 0.2)';
        previewContainer.style.display = 'none';
        filterFeedbackContainer.appendChild(previewContainer);
        
        // Function to preview filter impact
        const previewFilterImpact = function(inputCost, outputCost) {
            clearTimeout(previewDebounceTimer);
            
            previewContainer.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Calculating impact...';
            previewContainer.style.display = 'block';
            
            // Debounce the actual API call to prevent too many requests while sliding
            previewDebounceTimer = setTimeout(() => {
                // Call the API to get a count of models that would be filtered with these settings
                fetch(`/api/preview_filter_impact?input_cost=${inputCost}&output_cost=${outputCost}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const hiddenCount = data.hidden_count || 0;
                            const totalCount = data.total_count || 0;
                            
                            previewContainer.innerHTML = `
                                <i class="fas fa-info-circle me-2 text-warning"></i>
                                <span>
                                    With these settings, <strong>${hiddenCount}</strong> of ${totalCount} models 
                                    ${hiddenCount === 1 ? 'would be' : 'would be'} disabled.
                                </span>
                            `;
                            
                            // Hide after 5 seconds of no changes
                            setTimeout(() => {
                                previewContainer.style.display = 'none';
                            }, 5000);
                        } else {
                            previewContainer.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error previewing filter impact:', error);
                        previewContainer.style.display = 'none';
                    });
            }, 500); // 500ms debounce
        };
        
        // Update UI when sliders change
        if (maxInputCostSlider) {
            maxInputCostSlider.addEventListener('input', function() {
                const value = sliderToInputCost(this.value);
                updateInputCostUI(value);
                
                // Preview impact if both values are valid
                const outputValue = parseFloat(maxOutputCostValue.value);
                if (!isNaN(outputValue) && outputValue >= MIN_COST) {
                    previewFilterImpact(value, outputValue);
                }
            });
        }
        
        if (maxOutputCostSlider) {
            maxOutputCostSlider.addEventListener('input', function() {
                const value = sliderToOutputCost(this.value);
                updateOutputCostUI(value);
                
                // Preview impact if both values are valid
                const inputValue = parseFloat(maxInputCostValue.value);
                if (!isNaN(inputValue) && inputValue >= MIN_COST) {
                    previewFilterImpact(inputValue, value);
                }
            });
        }
        
        // Update sliders when input fields change
        if (maxInputCostValue) {
            maxInputCostValue.addEventListener('input', function() {
                const value = parseFloat(this.value);
                if (!isNaN(value) && value >= MIN_COST) {
                    maxInputCostSlider.value = inputCostToSlider(value);
                    updateInputCostUI(value);
                    
                    // Preview impact if both values are valid
                    const outputValue = parseFloat(maxOutputCostValue.value);
                    if (!isNaN(outputValue) && outputValue >= MIN_COST) {
                        previewFilterImpact(value, outputValue);
                    }
                }
            });
        }
        
        if (maxOutputCostValue) {
            maxOutputCostValue.addEventListener('input', function() {
                const value = parseFloat(this.value);
                if (!isNaN(value) && value >= MIN_COST) {
                    maxOutputCostSlider.value = outputCostToSlider(value);
                    updateOutputCostUI(value);
                    
                    // Preview impact if both values are valid
                    const inputValue = parseFloat(maxInputCostValue.value);
                    if (!isNaN(inputValue) && inputValue >= MIN_COST) {
                        previewFilterImpact(inputValue, value);
                    }
                }
            });
        }
        
        // Save filter settings
        if (saveFilterSettingsBtn) {
            saveFilterSettingsBtn.addEventListener('click', function() {
                // Show saving state
                saveFilterSettingsBtn.disabled = true;
                saveFilterSettingsBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
                
                const inputCost = parseFloat(maxInputCostValue.value);
                const outputCost = parseFloat(maxOutputCostValue.value);
                
                fetch('/api/save_model_filters', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        max_input_cost: inputCost,
                        max_output_cost: outputCost
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Reset button state
                    saveFilterSettingsBtn.disabled = false;
                    saveFilterSettingsBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Filter Settings';
                    
                    if (data.success) {
                        showFeedback('Model filter settings saved successfully! Models exceeding your cost limits will appear greyed out in the chat interface. Click "Return to Chat" to see your changes.', true);
                    } else {
                        showFeedback('Error saving model filter settings: ' + (data.error || 'Unable to save your changes. Please try again.'), false);
                    }
                })
                .catch(error => {
                    // Reset button state
                    saveFilterSettingsBtn.disabled = false;
                    saveFilterSettingsBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Filter Settings';
                    
                    showFeedback('Error saving model filter settings: ' + (error.message || 'Unable to connect to server. Please try again.'), false);
                    console.error('Error saving model filter settings:', error);
                });
            });
        }
        
        // Load initial values from server
        fetch('/api/get_model_filters')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Set slider and input field values
                    if (maxInputCostSlider && maxInputCostValue) {
                        const inputCost = data.max_input_cost;
                        maxInputCostSlider.value = inputCostToSlider(inputCost);
                        updateInputCostUI(inputCost);
                    }
                    
                    if (maxOutputCostSlider && maxOutputCostValue) {
                        const outputCost = data.max_output_cost;
                        maxOutputCostSlider.value = outputCostToSlider(outputCost);
                        updateOutputCostUI(outputCost);
                    }
                } else {
                    console.error('Error loading filter settings:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading filter settings:', error);
            });
    };
    
    // Initialize model filter sliders
    handleModelFilterSliders();
});
</script>
{% endblock %}