{% extends "base.html" %} {% block title %}Account Management{% endblock %} {%
block body_class %}account-page{% endblock %} {% block styles %} {{ super() }}
<!-- Custom styles are now in static/css/style.css -->
{% endblock %} {% block head %} {{ super() }}
<!-- Add our affiliate fix script before any other JavaScript -->
<script src="{{ url_for('static', filename='js/affiliate_fix.js') }}"></script>
{% endblock %} {% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div
                        class="d-flex justify-content-between align-items-center"
                    >
                        <div>
                            <h1 class="card-title mb-1">Account Management</h1>
                            <p class="text-muted">
                                Manage your account, add funds, and view your
                                usage history
                            </p>
                        </div>
                        <a
                            href="{{ url_for('index') }}"
                            class="btn btn-primary"
                        >
                            <i class="fas fa-arrow-left me-2"></i>Back to Chat
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Balance Display -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-4">
                    <h5 class="card-title">Available Balance</h5>
                    <div class="balance-amount">
                        ${{ "%.2f"|format(user.get_balance_usd()) }}
                    </div>
                    <p class="text-muted">
                        <i class="fas fa-info-circle"></i> Funds are used for AI
                        model access. Different models have different pricing
                        based on their capabilities and token usage.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation with Mobile-Friendly Layout -->
    <div class="row">
        <div class="col-12">
            <!-- Visible on desktop -->
            <ul
                class="nav nav-tabs d-none d-md-flex"
                id="accountTabs"
                role="tablist"
            >
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link active"
                        id="funds-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#funds"
                        type="button"
                        role="tab"
                        aria-controls="funds"
                        aria-selected="true"
                    >
                        <i class="fas fa-credit-card me-2"></i>Add Credits
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        id="history-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#history"
                        type="button"
                        role="tab"
                        aria-controls="history"
                        aria-selected="false"
                    >
                        <i class="fas fa-receipt me-2"></i>Purchase History
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        id="usage-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#usage"
                        type="button"
                        role="tab"
                        aria-controls="usage"
                        aria-selected="false"
                    >
                        <i class="fas fa-chart-line me-2"></i>Usage Analytics
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        id="pricing-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#pricing"
                        type="button"
                        role="tab"
                        aria-controls="pricing"
                        aria-selected="false"
                    >
                        <i class="fas fa-tag me-2"></i>Pricing
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        id="settings-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#settings"
                        type="button"
                        role="tab"
                        aria-controls="settings"
                        aria-selected="false"
                    >
                        <i class="fas fa-cog me-2"></i>Account Settings
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        id="tellFriend-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#tellFriend"
                        type="button"
                        role="tab"
                        aria-controls="tellFriend"
                        aria-selected="false"
                    >
                        <i class="fas fa-users me-2"></i>Tell a Friend
                    </button>
                </li>
            </ul>

            <!-- Mobile-friendly tab navigation (displayed only on mobile) -->
            <div class="d-md-none mb-3">
                <select
                    class="form-select mobile-tab-selector"
                    aria-label="Account sections"
                >
                    <option value="funds" selected>üí≥ Add Credits</option>
                    <option value="history">üìù Purchase History</option>
                    <option value="usage">üìä Usage Analytics</option>
                    <option value="pricing">üè∑Ô∏è Pricing</option>
                    <option value="settings">‚öôÔ∏è Account Settings</option>
                    <option value="tellFriend">üë• Tell a Friend</option>
                </select>
            </div>

            <!-- Mobile-friendly navigation buttons -->
            <div class="d-md-none mb-3">
                <div class="row g-2">
                    <div class="col-4">
                        <button
                            class="btn btn-outline-primary mobile-tab-btn w-100"
                            data-tab="funds"
                        >
                            <i class="fas fa-credit-card"></i> Credits
                        </button>
                    </div>
                    <div class="col-4">
                        <button
                            class="btn btn-outline-secondary mobile-tab-btn w-100"
                            data-tab="history"
                        >
                            <i class="fas fa-receipt"></i> History
                        </button>
                    </div>
                    <div class="col-4">
                        <button
                            class="btn btn-outline-secondary mobile-tab-btn w-100"
                            data-tab="usage"
                        >
                            <i class="fas fa-chart-line"></i> Usage
                        </button>
                    </div>
                    <div class="col-4">
                        <button
                            class="btn btn-outline-secondary mobile-tab-btn w-100"
                            data-tab="pricing"
                        >
                            <i class="fas fa-tag"></i> Pricing
                        </button>
                    </div>
                    <div class="col-4">
                        <button
                            class="btn btn-outline-secondary mobile-tab-btn w-100"
                            data-tab="settings"
                        >
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </div>
                    <div class="col-4">
                        <button
                            class="btn btn-outline-secondary mobile-tab-btn w-100"
                            data-tab="tellFriend"
                        >
                            <i class="fas fa-users"></i> Refer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content pt-4">
        <!-- Add Funds Tab -->
        <div
            id="funds"
            class="tab-pane fade show active"
            role="tabpanel"
            aria-labelledby="funds-tab"
        >
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Select Credit Package</h5>
                        </div>
                        <div class="card-body">
                            <!-- Packages Grid -->
                            <div class="row">
                                {% for package in packages %} {% set
                                is_starter_package = package.stripe_price_id ==
                                'price_1RKOl0CkgfcNKUGFhI5RljJd' %} {% set
                                has_previous_purchases =
                                recent_transactions|length > 0 %} {% if not
                                (is_starter_package and has_previous_purchases)
                                %}
                                <div class="col-md-3 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            {% if is_starter_package %}
                                            <h5 class="mb-0">
                                                Starter Credit Pack
                                            </h5>
                                            <span class="badge bg-info"
                                                >First-time purchase only</span
                                            >
                                            {% elif package.amount_usd == 10 %}
                                            <h5 class="mb-0">
                                                Small Credit Pack
                                            </h5>
                                            {% elif package.amount_usd == 25 %}
                                            <h5 class="mb-0">
                                                Medium Credit Pack
                                            </h5>
                                            {% elif package.amount_usd == 100 %}
                                            <h5 class="mb-0">
                                                Large Credit Pack
                                            </h5>
                                            {% else %}
                                            <h5 class="mb-0">
                                                {{
                                                "$%.2f"|format(package.amount_usd)
                                                }} Credit Pack
                                            </h5>
                                            {% endif %}
                                        </div>
                                        <div
                                            class="card-body d-flex flex-column"
                                        >
                                            <div class="text-center mb-3">
                                                <span class="display-6"
                                                    >${{
                                                    "%.2f"|format(package.amount_usd)
                                                    }}</span
                                                >
                                            </div>
                                            <p class="text-center">
                                                Pay what you use - no minimums
                                            </p>
                                            <div class="mt-auto">
                                                <ul
                                                    class="list-group list-group-flush mb-3"
                                                >
                                                    <li
                                                        class="list-group-item bg-transparent text-light"
                                                    >
                                                        <i
                                                            class="fas fa-check-circle text-success me-2"
                                                        ></i
                                                        >Access premium models
                                                    </li>
                                                    <li
                                                        class="list-group-item bg-transparent text-light"
                                                    >
                                                        <i
                                                            class="fas fa-check-circle text-success me-2"
                                                        ></i
                                                        >Tax calculated at
                                                        checkout
                                                    </li>
                                                    <li
                                                        class="list-group-item bg-transparent text-light"
                                                    >
                                                        <i
                                                            class="fas fa-check-circle text-success me-2"
                                                        ></i
                                                        >Secure payment via
                                                        Stripe
                                                    </li>
                                                </ul>
                                                <form
                                                    id="purchase-form-{{package.id}}"
                                                    action="{{ url_for('billing.purchase_package', package_id=package.id) }}"
                                                    method="post"
                                                >
                                                    <input
                                                        type="hidden"
                                                        name="csrf_token"
                                                        value="{{ csrf_token() }}"
                                                    />
                                                    <button
                                                        type="submit"
                                                        class="btn btn-primary w-100"
                                                    >
                                                        Buy Now
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %} {% endfor %}
                            </div>

                            <div class="alert alert-info mt-3">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="fas fa-info-circle fa-2x"></i>
                                    </div>
                                    <div>
                                        <h5 class="alert-heading">
                                            Secure Payments
                                        </h5>
                                        <p class="mb-0">
                                            Payments are processed securely by
                                            Stripe. All prices are in USD and
                                            taxes will be calculated at checkout
                                            based on your location.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchase History Tab -->
        <div
            id="history"
            class="tab-pane fade"
            role="tabpanel"
            aria-labelledby="history-tab"
        >
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div
                            class="card-header d-flex justify-content-between align-items-center"
                        >
                            <h5 class="mb-0">Purchase History</h5>
                            <a
                                href="{{ url_for('billing.export_transactions_csv') }}"
                                class="btn btn-sm btn-outline-secondary"
                            >
                                <i class="fas fa-download me-2"></i>Export CSV
                            </a>
                        </div>
                        <div class="card-body">
                            {% if recent_transactions %}
                            <div class="table-responsive">
                                <table
                                    class="table table-dark table-striped table-hover"
                                >
                                    <thead class="table-dark">
                                        <tr>
                                            <th class="text-white">Date</th>
                                            <th class="text-white">Amount</th>
                                            <th class="text-white">
                                                Payment Method
                                            </th>
                                            <th class="text-white">Status</th>
                                            <th class="text-white">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaction in
                                        recent_transactions %}
                                        <tr>
                                            <td class="text-light">
                                                {{
                                                transaction.created_at.strftime('%Y-%m-%d')
                                                }}
                                            </td>
                                            <td class="text-light">
                                                ${{
                                                "%.2f"|format(transaction.amount_usd)
                                                }}
                                            </td>
                                            <td class="text-light">
                                                <span
                                                    class="d-flex align-items-center"
                                                >
                                                    {% if
                                                    transaction.payment_method
                                                    == 'stripe' %}
                                                    <i
                                                        class="fab fa-cc-stripe me-2 text-primary"
                                                    ></i>
                                                    {% else %}
                                                    <i
                                                        class="fas fa-credit-card me-2"
                                                    ></i>
                                                    {% endif %} {{
                                                    transaction.payment_method|capitalize
                                                    }}
                                                </span>
                                            </td>
                                            <td class="text-light">
                                                {% if transaction.status ==
                                                'completed' %}
                                                <span class="badge bg-success"
                                                    >Completed</span
                                                >
                                                {% elif transaction.status ==
                                                'pending' %}
                                                <span
                                                    class="badge bg-warning text-dark"
                                                    >Pending</span
                                                >
                                                {% else %}
                                                <span class="badge bg-danger"
                                                    >Failed</span
                                                >
                                                {% endif %}
                                            </td>
                                            <td class="text-light">
                                                {% if transaction.status ==
                                                'completed' %}
                                                <a
                                                    href="{{ url_for('billing.generate_receipt', transaction_id=transaction.id) }}"
                                                    class="btn btn-sm btn-outline-info"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-placement="top"
                                                    title="Download Receipt"
                                                    target="_blank"
                                                >
                                                    <i
                                                        class="fas fa-receipt"
                                                    ></i>
                                                </a>
                                                {% else %}
                                                <button
                                                    type="button"
                                                    class="btn btn-sm btn-outline-info"
                                                    disabled
                                                    title="Receipt unavailable for pending or failed transactions"
                                                >
                                                    <i
                                                        class="fas fa-receipt"
                                                    ></i>
                                                </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <div class="mb-3">
                                    <i
                                        class="fas fa-receipt fa-3x text-muted"
                                    ></i>
                                </div>
                                <h5>No Purchase History</h5>
                                <p class="text-muted mb-4">
                                    You haven't made any purchases yet.
                                </p>
                                <a
                                    href="#funds"
                                    class="btn btn-primary"
                                    data-bs-toggle="tab"
                                    data-bs-target="#funds"
                                    type="button"
                                    role="tab"
                                    aria-controls="funds"
                                    aria-selected="false"
                                >
                                    <i class="fas fa-credit-card me-2"></i>Add
                                    Credits
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage Analytics Tab -->
        <div
            id="usage"
            class="tab-pane fade"
            role="tabpanel"
            aria-labelledby="usage-tab"
        >
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div
                                class="d-flex justify-content-between align-items-center"
                            >
                                <h5 class="mb-0">Usage Analytics</h5>
                                <div>
                                    <div class="btn-group me-2">
                                        <button
                                            class="btn btn-sm btn-outline-secondary active"
                                            id="summaryViewBtn"
                                            type="button"
                                        >
                                            <i class="fas fa-chart-pie me-1"></i
                                            >Summary
                                        </button>
                                        <button
                                            class="btn btn-sm btn-outline-secondary"
                                            id="detailedViewBtn"
                                            type="button"
                                        >
                                            <i class="fas fa-table me-1"></i
                                            >Detailed
                                        </button>
                                    </div>
                                    <button
                                        class="btn btn-sm btn-outline-secondary"
                                        id="exportCsvBtn"
                                    >
                                        <i class="fas fa-download me-1"></i>
                                        Export CSV
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card-body">
                            <!-- Date Range Selector -->
                            <div class="mb-4">
                                <h6>Date Range</h6>
                                <div class="btn-group">
                                    <button
                                        class="btn btn-sm btn-outline-secondary"
                                        data-range="30"
                                    >
                                        Last 30 Days
                                    </button>
                                    <button
                                        class="btn btn-sm btn-outline-secondary"
                                        data-range="7"
                                    >
                                        Last 7 Days
                                    </button>
                                    <button
                                        class="btn btn-sm btn-outline-secondary active"
                                        data-range="1"
                                    >
                                        Last 24 Hours
                                    </button>
                                    <button
                                        class="btn btn-sm btn-outline-secondary"
                                        data-range="month"
                                    >
                                        This Month
                                    </button>
                                </div>
                            </div>

                            <!-- Usage Analytics Content -->
                            <div class="tab-content">
                                <!-- Summary View -->
                                <div
                                    id="usage-summary-tab"
                                    class="tab-pane fade show active"
                                    role="tabpanel"
                                    aria-labelledby="summaryViewBtn"
                                >
                                    {% if recent_usage %}
                                    <!-- Usage Statistics Cards -->
                                    <div class="row mb-4">
                                        <div class="col-md-4 mb-3">
                                            <div class="card bg-dark h-100">
                                                <div
                                                    class="card-body text-center"
                                                >
                                                    <i
                                                        class="fas fa-calculator fa-2x mb-3 text-primary"
                                                    ></i>
                                                    <h2 class="text-light">
                                                        {% set total_spent =
                                                        namespace(value=0) %} {%
                                                        for usage in
                                                        recent_usage %} {% set
                                                        total_spent.value =
                                                        total_spent.value +
                                                        (usage.credits_used /
                                                        100000) %} {% endfor %}
                                                        ${{
                                                        "%.2f"|format(total_spent.value)
                                                        }}
                                                    </h2>
                                                    <p class="text-muted">
                                                        Total Spent
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="card bg-dark h-100">
                                                <div
                                                    class="card-body text-center"
                                                >
                                                    <i
                                                        class="fas fa-tag fa-2x mb-3 text-success"
                                                    ></i>
                                                    <h2 class="text-light">
                                                        {% set total_tokens =
                                                        namespace(value=0) %} {%
                                                        for usage in
                                                        recent_usage %} {% if
                                                        usage.prompt_tokens %}
                                                        {% set
                                                        total_tokens.value =
                                                        total_tokens.value +
                                                        usage.prompt_tokens %}
                                                        {% endif %} {% if
                                                        usage.completion_tokens
                                                        %} {% set
                                                        total_tokens.value =
                                                        total_tokens.value +
                                                        usage.completion_tokens
                                                        %} {% endif %} {% endfor
                                                        %} {{ total_tokens.value
                                                        }}
                                                    </h2>
                                                    <p class="text-muted">
                                                        Total Tokens
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="card bg-dark h-100">
                                                <div
                                                    class="card-body text-center"
                                                >
                                                    <i
                                                        class="fas fa-bolt fa-2x mb-3 text-warning"
                                                    ></i>
                                                    <h2 class="text-light">
                                                        {{ recent_usage|length
                                                        }}
                                                    </h2>
                                                    <p class="text-muted">
                                                        API Requests
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="table-responsive">
                                        <table
                                            class="table table-dark table-striped table-hover"
                                        >
                                            <thead class="table-dark">
                                                <tr>
                                                    <th
                                                        style="min-width: 110px"
                                                        class="text-white"
                                                    >
                                                        Date
                                                    </th>
                                                    <th
                                                        style="min-width: 80px"
                                                        class="text-white"
                                                    >
                                                        Type
                                                    </th>
                                                    <th
                                                        style="min-width: 180px"
                                                        class="text-white"
                                                    >
                                                        Model
                                                    </th>
                                                    <th
                                                        style="min-width: 80px"
                                                        class="text-white"
                                                    >
                                                        Cost
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for usage in recent_usage %}
                                                <tr>
                                                    <td class="text-light">
                                                        {{
                                                        usage.created_at.strftime('%Y-%m-%d')
                                                        }}
                                                    </td>
                                                    <td class="text-light">
                                                        <span
                                                            class="badge {% if usage.usage_type == 'chat' %}bg-info{% elif usage.usage_type == 'embedding' %}bg-warning text-dark{% else %}bg-secondary{% endif %}"
                                                        >
                                                            {{
                                                            usage.usage_type|capitalize
                                                            }}
                                                        </span>
                                                    </td>
                                                    <td class="text-light">
                                                        {{ usage.model_id }}
                                                    </td>
                                                    <td class="text-light">
                                                        ${{
                                                        "%.4f"|format(usage.credits_used
                                                        / 100000) }}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <div class="mb-3">
                                            <i
                                                class="fas fa-chart-line fa-3x text-muted"
                                            ></i>
                                        </div>
                                        <h5>No Usage Data</h5>
                                        <p class="text-muted mb-4">
                                            No usage data available for the
                                            selected time period.
                                        </p>
                                        <div
                                            class="d-flex justify-content-center gap-3"
                                        >
                                            <button
                                                class="btn btn-outline-secondary"
                                            >
                                                <i
                                                    class="fas fa-calendar-alt me-2"
                                                ></i
                                                >Change Date Range
                                            </button>
                                            <a
                                                href="{{ url_for('index') }}"
                                                class="btn btn-primary"
                                            >
                                                <i class="fas fa-robot me-2"></i
                                                >Try Using Models
                                            </a>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Detailed View -->
                                <div
                                    id="usage-detailed-tab"
                                    class="tab-pane fade"
                                    role="tabpanel"
                                    aria-labelledby="detailedViewBtn"
                                >
                                    {% if recent_usage %}
                                    <div class="table-responsive">
                                        <table
                                            class="table table-dark table-striped table-hover"
                                        >
                                            <thead class="table-dark">
                                                <tr>
                                                    <th
                                                        style="min-width: 110px"
                                                        class="text-white"
                                                    >
                                                        Date
                                                    </th>
                                                    <th
                                                        style="min-width: 180px"
                                                        class="text-white"
                                                    >
                                                        Model
                                                    </th>
                                                    <th
                                                        style="min-width: 100px"
                                                        class="text-white"
                                                    >
                                                        Input Tokens
                                                    </th>
                                                    <th
                                                        style="min-width: 100px"
                                                        class="text-white"
                                                    >
                                                        Input Cost
                                                    </th>
                                                    <th
                                                        style="min-width: 100px"
                                                        class="text-white"
                                                    >
                                                        Output Tokens
                                                    </th>
                                                    <th
                                                        style="min-width: 100px"
                                                        class="text-white"
                                                    >
                                                        Output Cost
                                                    </th>
                                                    <th
                                                        style="min-width: 100px"
                                                        class="text-white"
                                                    >
                                                        Total Cost
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for usage in recent_usage %}
                                                <tr>
                                                    <td class="text-light">
                                                        {{
                                                        usage.created_at.strftime('%Y-%m-%d
                                                        %H:%M') }}
                                                    </td>
                                                    <td class="text-light">
                                                        {{ usage.model_id }}
                                                    </td>
                                                    <td class="text-light">
                                                        {{ usage.prompt_tokens
                                                        if usage.prompt_tokens
                                                        else 'N/A' }}
                                                    </td>
                                                    <td class="text-light">
                                                        {% if
                                                        usage.prompt_tokens and
                                                        usage.model_id %} {% set
                                                        input_cost =
                                                        ((usage.credits_used /
                                                        100000) * 0.7)|float %}
                                                        ${{
                                                        "%.4f"|format(input_cost)
                                                        }} {% else %} N/A {%
                                                        endif %}
                                                    </td>
                                                    <td class="text-light">
                                                        {{
                                                        usage.completion_tokens
                                                        if
                                                        usage.completion_tokens
                                                        else 'N/A' }}
                                                    </td>
                                                    <td class="text-light">
                                                        {% if
                                                        usage.completion_tokens
                                                        and usage.model_id %} {%
                                                        set output_cost =
                                                        ((usage.credits_used /
                                                        100000) * 0.3)|float %}
                                                        ${{
                                                        "%.4f"|format(output_cost)
                                                        }} {% else %} N/A {%
                                                        endif %}
                                                    </td>
                                                    <td class="text-light">
                                                        ${{
                                                        "%.4f"|format(usage.credits_used
                                                        / 100000) }}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <div class="mb-3">
                                            <i
                                                class="fas fa-chart-line fa-3x text-muted"
                                            ></i>
                                        </div>
                                        <h5>No Usage Data</h5>
                                        <p class="text-muted mb-4">
                                            No usage data available for the
                                            selected time period.
                                        </p>
                                        <div
                                            class="d-flex justify-content-center gap-3"
                                        >
                                            <button
                                                class="btn btn-outline-secondary"
                                            >
                                                <i
                                                    class="fas fa-calendar-alt me-2"
                                                ></i
                                                >Change Date Range
                                            </button>
                                            <a
                                                href="{{ url_for('index') }}"
                                                class="btn btn-primary"
                                            >
                                                <i class="fas fa-robot me-2"></i
                                                >Try Using Models
                                            </a>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pricing Tab -->
        <div
            id="pricing"
            class="tab-pane fade"
            role="tabpanel"
            aria-labelledby="pricing-tab"
        >
            <div class="balance-card p-4">
                <h4 class="mb-3">Model Pricing</h4>
                <p class="caption mb-4">
                    Pricing information for all available AI models. Click on
                    any column header to sort by that attribute.
                </p>

                <div
                    class="d-flex justify-content-between align-items-center mb-3"
                >
                    <div>
                        <span id="lastUpdated" class="caption"></span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-search text-muted me-2"></i>
                        <input
                            type="text"
                            class="form-control custom-amount-input"
                            id="modelSearch"
                            placeholder="Search models..."
                        />
                    </div>
                </div>

                <div class="mt-3 mb-2">
                    <span class="caption"
                        >‚Ä¢ Prices are per million tokens ‚Ä¢ All prices include
                        our platform fee</span
                    >
                </div>

                <div
                    class="table-responsive mt-2"
                    style="max-height: 600px; overflow-y: auto"
                >
                    <table
                        class="table table-dark table-hover table-striped"
                        id="pricingTable"
                    >
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th
                                    onclick="sortPricingTable(0)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom py-3"
                                >
                                    <div
                                        class="d-flex justify-content-between align-items-center"
                                    >
                                        Model
                                        <i
                                            id="sort-icon-0"
                                            class="fas fa-sort-up"
                                        ></i>
                                    </div>
                                </th>
                                <th
                                    onclick="sortPricingTable(1)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom text-end py-3"
                                >
                                    <div
                                        class="d-flex justify-content-end align-items-center"
                                    >
                                        Input Cost
                                        <i
                                            id="sort-icon-1"
                                            class="fas fa-sort"
                                        ></i>
                                    </div>
                                </th>
                                <th
                                    onclick="sortPricingTable(2)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom text-end py-3"
                                >
                                    <div
                                        class="d-flex justify-content-end align-items-center"
                                    >
                                        Output Cost
                                        <i
                                            id="sort-icon-2"
                                            class="fas fa-sort"
                                        ></i>
                                    </div>
                                </th>
                                <th
                                    onclick="sortPricingTable(3)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom text-end py-3"
                                >
                                    <div
                                        class="d-flex justify-content-end align-items-center"
                                    >
                                        Context
                                        <i
                                            id="sort-icon-3"
                                            class="fas fa-sort"
                                        ></i>
                                    </div>
                                </th>
                                <th
                                    onclick="sortPricingTable(4)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom text-center py-3"
                                >
                                    <div
                                        class="d-flex justify-content-center align-items-center"
                                    >
                                        Multimodal
                                        <i
                                            id="sort-icon-4"
                                            class="fas fa-sort"
                                        ></i>
                                    </div>
                                </th>
                                <th
                                    onclick="sortPricingTable(5)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom text-center py-3"
                                >
                                    <div
                                        class="d-flex justify-content-center align-items-center"
                                    >
                                        PDFs
                                        <i
                                            id="sort-icon-5"
                                            class="fas fa-sort"
                                        ></i>
                                    </div>
                                </th>
                                <th
                                    onclick="sortPricingTable(6)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom text-center py-3"
                                >
                                    <div
                                        class="d-flex justify-content-center align-items-center"
                                    >
                                        Cost Band
                                        <i
                                            id="sort-icon-6"
                                            class="fas fa-sort"
                                        ></i>
                                    </div>
                                </th>
                                <th
                                    onclick="sortPricingTable(7)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom text-center py-3"
                                >
                                    <div
                                        class="d-flex justify-content-center align-items-center"
                                    >
                                        ELO
                                        <i
                                            id="sort-icon-7"
                                            class="fas fa-sort"
                                        ></i>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="pricingTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <div
                                        class="d-flex flex-column align-items-center"
                                    >
                                        <div
                                            class="spinner-border text-info mb-3"
                                            role="status"
                                        >
                                            <span class="visually-hidden"
                                                >Loading...</span
                                            >
                                        </div>
                                        <p class="caption">
                                            Loading pricing data from
                                            OpenRouter...
                                        </p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pricing table styles moved to static/css/style.css -->

                <!-- Error message removed as requested -->

                <div class="mt-3">
                    <p class="caption text-muted">
                        <i class="fas fa-info-circle"></i> The pricing
                        information is fetched directly from OpenRouter and our
                        internal pricing configuration. Prices may vary based on
                        model updates and availability.
                    </p>
                </div>
            </div>
        </div>

        <!-- Account Settings Tab -->
        <div
            id="settings"
            class="tab-pane fade"
            role="tabpanel"
            aria-labelledby="settings-tab"
        >
            <div class="balance-card p-4">
                <h4 class="mb-4">Account Settings</h4>

                <form>
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <p class="p-2 bg-dark rounded">{{ user.username }}</p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email Address</label>
                        <p class="p-2 bg-dark rounded">{{ user.email }}</p>
                    </div>

                    <hr class="my-4" style="border-color: #3f4246" />

                    <h5>Chat Preferences</h5>
                    <div class="mb-3 form-check">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enableMemory"
                            {%
                            if
                            user.enable_memory
                            %}checked{%
                            endif
                            %}
                        />
                        <label class="form-check-label" for="enableMemory"
                            >Enable chat memory across sessions</label
                        >
                        <small class="form-text text-muted d-block mt-1">
                            When enabled, the AI can remember and reference
                            information from your previous conversations.
                            Disabling this may reduce token usage for new chats.
                        </small>
                    </div>

                    <div class="mb-3 form-check">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enableModelFallback"
                            {%
                            if
                            user.enable_model_fallback
                            %}checked{%
                            endif
                            %}
                        />
                        <label
                            class="form-check-label"
                            for="enableModelFallback"
                            >Enable model fallback</label
                        >
                        <small class="form-text text-muted d-block mt-1">
                            When enabled, if your chosen model is unavailable,
                            the system will automatically use a similar
                            alternative. When disabled, you'll be notified if
                            your selected model can't be reached.
                        </small>
                    </div>

                    <!-- Advanced Chat Preferences Section -->
                    <div class="mt-4">
                        <h5 class="d-flex align-items-center">
                            <span>Advanced Chat Preferences</span>
                            <button
                                id="toggleAdvancedPrefs"
                                class="btn btn-sm btn-outline-secondary ms-2"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#advancedChatPrefs"
                                aria-expanded="false"
                                aria-controls="advancedChatPrefs"
                            >
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h5>
                        <small class="form-text text-muted d-block mb-3">
                            Fine-tune how AI models respond to your prompts.
                            Leave settings at default unless you need specific
                            behavior.
                        </small>

                        <div class="collapse" id="advancedChatPrefs">
                            <div
                                class="card card-body bg-dark border-secondary"
                            >
                                <div class="d-flex justify-content-end mb-3">
                                    <button
                                        type="button"
                                        id="resetAllDefaults"
                                        class="btn btn-sm btn-outline-warning"
                                    >
                                        <i class="fas fa-undo me-1"></i> Reset
                                        All to Defaults
                                    </button>
                                </div>

                                <!-- Temperature -->
                                <div class="mb-4">
                                    <label
                                        for="temperature"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Temperature</span>
                                        <span
                                            class="badge bg-secondary"
                                            id="temperatureValue"
                                            >Default</span
                                        >
                                    </label>
                                    <div
                                        class="d-flex align-items-center gap-2"
                                    >
                                        <input
                                            type="range"
                                            class="form-range flex-grow-1"
                                            id="temperatureSlider"
                                            min="0"
                                            max="2"
                                            step="0.01"
                                        />
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="temperature"
                                            style="width: 70px"
                                            min="0"
                                            max="2"
                                            step="0.01"
                                        />
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="temperature"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Controls randomness in responses. Lower
                                        values are more deterministic, higher
                                        values more creative.
                                    </small>
                                </div>

                                <!-- Top P -->
                                <div class="mb-4">
                                    <label
                                        for="topP"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Top P (Nucleus Sampling)</span>
                                        <span
                                            class="badge bg-secondary"
                                            id="topPValue"
                                            >Default</span
                                        >
                                    </label>
                                    <div
                                        class="d-flex align-items-center gap-2"
                                    >
                                        <input
                                            type="range"
                                            class="form-range flex-grow-1"
                                            id="topPSlider"
                                            min="0"
                                            max="1"
                                            step="0.01"
                                        />
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="topP"
                                            style="width: 70px"
                                            min="0"
                                            max="1"
                                            step="0.01"
                                        />
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="topP"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Controls diversity in word choices.
                                        Higher values increase variety.
                                    </small>
                                </div>

                                <!-- Max Tokens -->
                                <div class="mb-4">
                                    <label
                                        for="maxTokens"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Max Tokens</span>
                                        <span
                                            class="badge bg-secondary"
                                            id="maxTokensValue"
                                            >Default (Max)</span
                                        >
                                    </label>
                                    <div class="mb-2">
                                        <div
                                            class="form-check form-check-inline"
                                        >
                                            <input
                                                class="form-check-input"
                                                type="radio"
                                                name="maxTokensOption"
                                                id="maxTokensMax"
                                                value="max"
                                                checked
                                            />
                                            <label
                                                class="form-check-label"
                                                for="maxTokensMax"
                                                >Max (Default)</label
                                            >
                                        </div>
                                        <div
                                            class="form-check form-check-inline"
                                        >
                                            <input
                                                class="form-check-input"
                                                type="radio"
                                                name="maxTokensOption"
                                                id="maxTokensSpecific"
                                                value="specific"
                                            />
                                            <label
                                                class="form-check-label"
                                                for="maxTokensSpecific"
                                                >Specific value</label
                                            >
                                        </div>
                                    </div>
                                    <div
                                        class="d-flex align-items-center gap-2"
                                        id="maxTokensInputGroup"
                                    >
                                        <input
                                            type="range"
                                            class="form-range flex-grow-1"
                                            id="maxTokensSlider"
                                            min="1"
                                            max="8000"
                                            step="1"
                                            disabled
                                        />
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="maxTokens"
                                            style="width: 90px"
                                            min="1"
                                            max="8000"
                                            step="1"
                                            disabled
                                        />
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="maxTokens"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Maximum response length. Note: Will be
                                        automatically capped based on model
                                        limits.
                                    </small>
                                </div>

                                <!-- Frequency Penalty -->
                                <div class="mb-4">
                                    <label
                                        for="frequencyPenalty"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Frequency Penalty</span>
                                        <span
                                            class="badge bg-secondary"
                                            id="frequencyPenaltyValue"
                                            >Default</span
                                        >
                                    </label>
                                    <div
                                        class="d-flex align-items-center gap-2"
                                    >
                                        <input
                                            type="range"
                                            class="form-range flex-grow-1"
                                            id="frequencyPenaltySlider"
                                            min="-2"
                                            max="2"
                                            step="0.01"
                                        />
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="frequencyPenalty"
                                            style="width: 70px"
                                            min="-2"
                                            max="2"
                                            step="0.01"
                                        />
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="frequencyPenalty"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Reduces repetition of frequent tokens.
                                        Higher values reduce word repetition.
                                    </small>
                                </div>

                                <!-- Presence Penalty -->
                                <div class="mb-4">
                                    <label
                                        for="presencePenalty"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Presence Penalty</span>
                                        <span
                                            class="badge bg-secondary"
                                            id="presencePenaltyValue"
                                            >Default</span
                                        >
                                    </label>
                                    <div
                                        class="d-flex align-items-center gap-2"
                                    >
                                        <input
                                            type="range"
                                            class="form-range flex-grow-1"
                                            id="presencePenaltySlider"
                                            min="-2"
                                            max="2"
                                            step="0.01"
                                        />
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="presencePenalty"
                                            style="width: 70px"
                                            min="-2"
                                            max="2"
                                            step="0.01"
                                        />
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="presencePenalty"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Reduces repetition of topics. Higher
                                        values encourage exploring new topics.
                                    </small>
                                </div>

                                <!-- Top K -->
                                <div class="mb-4">
                                    <label
                                        for="topK"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Top K</span>
                                        <span
                                            class="badge bg-secondary"
                                            id="topKValue"
                                            >Default</span
                                        >
                                    </label>
                                    <div
                                        class="d-flex align-items-center gap-2"
                                    >
                                        <input
                                            type="range"
                                            class="form-range flex-grow-1"
                                            id="topKSlider"
                                            min="0"
                                            max="100"
                                            step="1"
                                        />
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="topK"
                                            style="width: 70px"
                                            min="0"
                                            max="100"
                                            step="1"
                                        />
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="topK"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Limits vocabulary to most likely
                                        options. Lower values make responses
                                        more focused.
                                    </small>
                                </div>

                                <!-- Stop Sequences -->
                                <div class="mb-4">
                                    <label
                                        for="stopSequences"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Stop Sequences</span>
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="stopSequences"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </label>
                                    <div class="mb-2">
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="stopSequences"
                                            placeholder="Enter sequence and press Enter"
                                        />
                                    </div>
                                    <div
                                        id="stopSequencesList"
                                        class="d-flex flex-wrap gap-2"
                                    >
                                        <!-- Stop sequences will be added here dynamically -->
                                    </div>
                                    <small class="form-text text-muted">
                                        Sequences where the AI will stop
                                        generating further tokens. Add multiple
                                        by pressing Enter after each.
                                    </small>
                                </div>

                                <!-- Response Format -->
                                <div class="mb-4">
                                    <label class="form-label"
                                        >Response Format</label
                                    >
                                    <div class="d-flex align-items-center mb-2">
                                        <div
                                            class="form-check form-check-inline"
                                        >
                                            <input
                                                class="form-check-input"
                                                type="radio"
                                                name="responseFormat"
                                                id="responseFormatText"
                                                value="text"
                                                checked
                                            />
                                            <label
                                                class="form-check-label"
                                                for="responseFormatText"
                                                >Natural Text (Default)</label
                                            >
                                        </div>
                                        <div
                                            class="form-check form-check-inline"
                                        >
                                            <input
                                                class="form-check-input"
                                                type="radio"
                                                name="responseFormat"
                                                id="responseFormatJson"
                                                value="json"
                                            />
                                            <label
                                                class="form-check-label"
                                                for="responseFormatJson"
                                                >JSON Structure</label
                                            >
                                        </div>
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary ms-2 reset-param"
                                            data-param="responseFormat"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Format for AI responses. JSON format is
                                        useful for structured data.
                                    </small>
                                </div>

                                <div class="d-grid">
                                    <button
                                        type="button"
                                        id="saveAdvancedPrefs"
                                        class="btn btn-primary"
                                    >
                                        <i class="fas fa-save me-1"></i> Save
                                        Advanced Preferences
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4" style="border-color: #3f4246" />

                    <h5>Notification Preferences</h5>
                    <div class="mb-3 form-check">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="emailNotifications"
                            checked
                        />
                        <label class="form-check-label" for="emailNotifications"
                            >Receive email notifications</label
                        >
                    </div>
                    <div class="mb-3 form-check">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="lowBalanceAlerts"
                            checked
                        />
                        <label class="form-check-label" for="lowBalanceAlerts"
                            >Low balance alerts</label
                        >
                    </div>

                    <hr class="my-4" style="border-color: #3f4246" />

                    <h5>Danger Zone</h5>
                    <p class="caption">
                        These actions cannot be undone. Please proceed with
                        caution.
                    </p>

                    <div class="mt-3 mb-4">
                        <button
                            id="clear-conversations-btn-account"
                            class="btn btn-danger"
                        >
                            <i class="fa-regular fa-trash-can me-2"></i> Clear
                            All Conversations
                        </button>
                        <p class="text-muted mt-2 small">
                            <i class="fas fa-info-circle me-1"></i> This action
                            will permanently delete all your conversation
                            history.
                        </p>
                    </div>

                    <div class="d-flex justify-content-center">
                        <button type="button" class="select-button bg-danger">
                            Delete Account
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tell a Friend Tab (Direct Implementation) -->
        <div
            id="tellFriend"
            class="tab-pane fade"
            role="tabpanel"
            aria-labelledby="tellFriend-tab"
        >
            <!-- Debug functionality moved to debug-utilities.js -->

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-dark">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Your Affiliate Dashboard</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-8 mb-4 mb-md-0">
                                    <div class="mb-4">
                                        <h5 class="mb-3">Your Referral Link</h5>
                                        <div
                                            style="
                                                display: flex;
                                                width: 100%;
                                                margin-bottom: 10px;
                                            "
                                        >
                                            <div
                                                class="form-control"
                                                id="referralLink"
                                                style="
                                                    flex: 1;
                                                    padding: 10px;
                                                    background-color: #2c2f33;
                                                    color: #e4e6eb;
                                                    border-color: #3f4246;
                                                    overflow: hidden;
                                                    text-overflow: ellipsis;
                                                    white-space: nowrap;
                                                    cursor: text;
                                                "
                                            >
                                                {{ request.host_url }}?ref={{
                                                current_user.referral_code }}
                                            </div>
                                            <button
                                                class="btn btn-outline-primary"
                                                type="button"
                                                id="copyReferralLink"
                                                style="
                                                    flex-shrink: 0;
                                                    margin-left: 5px;
                                                "
                                            >
                                                <i class="fas fa-copy"></i> Copy
                                            </button>
                                        </div>
                                        <p class="form-text mt-2">
                                            Share this link to earn commissions
                                            on your friends' purchases.
                                        </p>
                                    </div>

                                    <div class="alert alert-info mb-4">
                                        <div class="d-flex">
                                            <div class="me-3">
                                                <i
                                                    class="fas fa-lightbulb fa-2x text-warning"
                                                ></i>
                                            </div>
                                            <div>
                                                <h5 class="alert-heading">
                                                    Quick Tip
                                                </h5>
                                                <p class="mb-0">
                                                    Want to share a specific
                                                    page or chat? Just add
                                                    <code
                                                        >?ref={{
                                                        current_user.referral_code
                                                        }}</code
                                                    >
                                                    to the end of any
                                                    GloriaMundo URL!
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <!-- QR Code for Mobile Sharing -->
                                    <div class="card h-100 border-primary">
                                        <div
                                            class="card-header bg-primary text-white"
                                        >
                                            <h5 class="mb-0">
                                                Share via QR Code
                                            </h5>
                                        </div>
                                        <div class="card-body text-center">
                                            <img
                                                src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data={{ request.host_url|urlencode }}?ref={{ current_user.referral_code }}"
                                                alt="Your Referral QR Code"
                                                class="img-fluid mb-2"
                                                style="
                                                    max-width: 100%;
                                                    height: auto;
                                                "
                                            />
                                            <p class="mb-0 small">
                                                Scan with a smartphone camera to
                                                quickly share your link
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <div class="card border-0 mb-4">
                                        <div
                                            class="card-header bg-dark text-white"
                                        >
                                            <h5 class="mb-0">
                                                PayPal Email for Payouts
                                            </h5>
                                        </div>
                                        <div class="card-body bg-dark">
                                            <div class="mb-4">
                                                <div
                                                    class="d-flex align-items-center mb-3"
                                                    style="gap: 10px"
                                                    id="current-paypal-email"
                                                >
                                                    <!-- Current email display -->
                                                    <div
                                                        class="border rounded p-3 bg-dark flex-grow-1"
                                                        style="
                                                            word-break: break-all;
                                                        "
                                                    >
                                                        <i
                                                            class="fab fa-paypal text-primary me-2"
                                                        ></i>
                                                        <span
                                                            id="currentPaypalEmail"
                                                            >{{
                                                            current_user.paypal_email
                                                            or 'Not set'
                                                            }}</span
                                                        >
                                                    </div>
                                                    <button
                                                        class="btn btn-outline-primary"
                                                        type="button"
                                                        id="editPaypalBtn"
                                                        style="flex-shrink: 0"
                                                    >
                                                        <i
                                                            class="fas fa-edit"
                                                        ></i>
                                                        Edit
                                                    </button>
                                                </div>
                                                <form
                                                    id="paypalEmailForm"
                                                    style="
                                                        display: none;
                                                        margin-top: 15px;
                                                        width: 100%;
                                                    "
                                                >
                                                    <input
                                                        type="hidden"
                                                        name="csrf_token"
                                                        value="{{ csrf_token() }}"
                                                        id="paypal_csrf_token"
                                                    />
                                                    <input
                                                        type="hidden"
                                                        id="paypal_update_endpoint"
                                                        value="/update_paypal"
                                                    />
                                                    <div class="mb-3">
                                                        <label
                                                            for="paypal_email"
                                                            class="form-label"
                                                            >PayPal Email
                                                            Address</label
                                                        >
                                                        <input
                                                            type="email"
                                                            class="form-control form-control-lg"
                                                            id="paypal_email"
                                                            name="paypal_email"
                                                            placeholder="Enter your PayPal email"
                                                            value="{{ current_user.paypal_email or '' }}"
                                                            required
                                                            style="
                                                                min-width: 300px;
                                                                width: 100%;
                                                                font-size: 16px;
                                                                padding: 10px;
                                                            "
                                                        />
                                                    </div>
                                                    <div
                                                        class="d-flex gap-2 mb-2"
                                                    >
                                                        <button
                                                            class="btn btn-primary"
                                                            type="button"
                                                            id="savePaypalBtn"
                                                        >
                                                            Save Changes
                                                        </button>
                                                        <button
                                                            class="btn btn-outline-secondary"
                                                            type="button"
                                                            id="cancelEditBtn"
                                                        >
                                                            Cancel
                                                        </button>
                                                    </div>
                                                    <div
                                                        class="alert alert-success d-none"
                                                        id="paypalSuccessAlert"
                                                    >
                                                        PayPal email updated
                                                        successfully!
                                                    </div>
                                                    <div
                                                        class="alert alert-danger d-none"
                                                        id="paypalErrorAlert"
                                                    >
                                                        Error updating PayPal
                                                        email.
                                                    </div>
                                                    <div class="form-text">
                                                        We use this email to
                                                        send your affiliate
                                                        commission payments.
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PayPal email editor functionality moved to paypal_email_updater.js -->
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    console.log(
                        "New affiliate template loaded directly in account.html",
                    );

                    // Copy referral link functionality
                    const copyBtn = document.getElementById("copyReferralLink");
                    const referralLinkEl =
                        document.getElementById("referralLink");

                    if (copyBtn && referralLinkEl) {
                        copyBtn.addEventListener("click", function () {
                            // Get the text to copy
                            const textToCopy = referralLinkEl.textContent;

                            // Copy to clipboard
                            navigator.clipboard
                                .writeText(textToCopy)
                                .then(() => {
                                    const originalText = copyBtn.innerHTML;
                                    copyBtn.innerHTML =
                                        '<i class="fas fa-check"></i> Copied!';

                                    setTimeout(function () {
                                        copyBtn.innerHTML = originalText;
                                    }, 2000);
                                })
                                .catch((err) => {
                                    console.error("Error copying text: ", err);
                                });
                        });
                    }
                });
            </script>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/advanced_chat_preferences.js') }}"></script>
<script src="{{ url_for('static', filename='js/paypal_email_updater.js') }}"></script>

<!-- Modular JavaScript Files - Clean and Separated -->
<script type="module" src="{{ url_for('static', filename='js/account-utilities.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/account-tabs.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/affiliate-functionality.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/usage-analytics.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/pricing-table.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/account-settings.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/account-main.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/debug-utilities.js') }}"></script>
{% endblock %}
