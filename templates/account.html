{% extends "base.html" %} {% block title %}Account Management{% endblock %} {%
block body_class %}account-page{% endblock %} {% block styles %} {{ super() }}
<!-- Custom styles are now in static/css/style.css -->
{% endblock %} {% block head %} {{ super() }}
<!-- Add our affiliate fix script before any other JavaScript -->
<script src="{{ url_for('static', filename='js/affiliate_fix.js') }}"></script>
{% endblock %} {% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div
                        class="d-flex justify-content-between align-items-center"
                    >
                        <div>
                            <h1 class="card-title mb-1">Account Management</h1>
                            <p class="text-muted">
                                Manage your account, add funds, and view your
                                usage history
                            </p>
                        </div>
                        <a
                            href="{{ url_for('index') }}"
                            class="btn btn-primary"
                        >
                            <i class="fas fa-arrow-left me-2"></i>Back to Chat
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Balance Display -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-4">
                    <h5 class="card-title">Available Balance</h5>
                    <div class="balance-amount">
                        ${{ "%.2f"|format(user.get_balance_usd()) }}
                    </div>
                    <p class="text-muted">
                        <i class="fas fa-info-circle"></i> Funds are used for AI
                        model access. Different models have different pricing
                        based on their capabilities and token usage.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation with Mobile-Friendly Layout -->
    <div class="row">
        <div class="col-12">
            <!-- Visible on desktop -->
            <ul
                class="nav nav-tabs d-none d-md-flex"
                id="accountTabs"
                role="tablist"
            >
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link active"
                        id="funds-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#funds"
                        type="button"
                        role="tab"
                        aria-controls="funds"
                        aria-selected="true"
                    >
                        <i class="fas fa-credit-card me-2"></i>Add Credits
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        id="history-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#history"
                        type="button"
                        role="tab"
                        aria-controls="history"
                        aria-selected="false"
                    >
                        <i class="fas fa-receipt me-2"></i>Purchase History
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        id="usage-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#usage"
                        type="button"
                        role="tab"
                        aria-controls="usage"
                        aria-selected="false"
                    >
                        <i class="fas fa-chart-line me-2"></i>Usage Analytics
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        id="pricing-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#pricing"
                        type="button"
                        role="tab"
                        aria-controls="pricing"
                        aria-selected="false"
                    >
                        <i class="fas fa-tag me-2"></i>Pricing
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        id="settings-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#settings"
                        type="button"
                        role="tab"
                        aria-controls="settings"
                        aria-selected="false"
                    >
                        <i class="fas fa-cog me-2"></i>Account Settings
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                        class="nav-link"
                        id="tellFriend-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#tellFriend"
                        type="button"
                        role="tab"
                        aria-controls="tellFriend"
                        aria-selected="false"
                    >
                        <i class="fas fa-users me-2"></i>Tell a Friend
                    </button>
                </li>
            </ul>

            <!-- Mobile-friendly tab navigation (displayed only on mobile) -->
            <div class="d-md-none mb-3">
                <select
                    class="form-select mobile-tab-selector"
                    aria-label="Account sections"
                >
                    <option value="funds" selected>üí≥ Add Credits</option>
                    <option value="history">üìù Purchase History</option>
                    <option value="usage">üìä Usage Analytics</option>
                    <option value="pricing">üè∑Ô∏è Pricing</option>
                    <option value="settings">‚öôÔ∏è Account Settings</option>
                    <option value="tellFriend">üë• Tell a Friend</option>
                </select>
            </div>

            <!-- Mobile-friendly navigation buttons -->
            <div class="d-md-none mb-3">
                <div class="row g-2">
                    <div class="col-4">
                        <button
                            class="btn btn-outline-primary mobile-tab-btn w-100"
                            data-tab="funds"
                        >
                            <i class="fas fa-credit-card"></i> Credits
                        </button>
                    </div>
                    <div class="col-4">
                        <button
                            class="btn btn-outline-secondary mobile-tab-btn w-100"
                            data-tab="history"
                        >
                            <i class="fas fa-receipt"></i> History
                        </button>
                    </div>
                    <div class="col-4">
                        <button
                            class="btn btn-outline-secondary mobile-tab-btn w-100"
                            data-tab="usage"
                        >
                            <i class="fas fa-chart-line"></i> Usage
                        </button>
                    </div>
                    <div class="col-4">
                        <button
                            class="btn btn-outline-secondary mobile-tab-btn w-100"
                            data-tab="pricing"
                        >
                            <i class="fas fa-tag"></i> Pricing
                        </button>
                    </div>
                    <div class="col-4">
                        <button
                            class="btn btn-outline-secondary mobile-tab-btn w-100"
                            data-tab="settings"
                        >
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </div>
                    <div class="col-4">
                        <button
                            class="btn btn-outline-secondary mobile-tab-btn w-100"
                            data-tab="tellFriend"
                        >
                            <i class="fas fa-users"></i> Refer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content pt-4">
        <!-- Add Funds Tab -->
        <div
            id="funds"
            class="tab-pane fade show active"
            role="tabpanel"
            aria-labelledby="funds-tab"
        >
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Select Credit Package</h5>
                        </div>
                        <div class="card-body">
                            <!-- Packages Grid -->
                            <div class="row">
                                {% for package in packages %} {% set
                                is_starter_package = package.stripe_price_id ==
                                'price_1RKOl0CkgfcNKUGFhI5RljJd' %} {% set
                                has_previous_purchases =
                                recent_transactions|length > 0 %} {% if not
                                (is_starter_package and has_previous_purchases)
                                %}
                                <div class="col-md-3 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            {% if is_starter_package %}
                                            <h5 class="mb-0">
                                                Starter Credit Pack
                                            </h5>
                                            <span class="badge bg-info"
                                                >First-time purchase only</span
                                            >
                                            {% elif package.amount_usd == 10 %}
                                            <h5 class="mb-0">
                                                Small Credit Pack
                                            </h5>
                                            {% elif package.amount_usd == 25 %}
                                            <h5 class="mb-0">
                                                Medium Credit Pack
                                            </h5>
                                            {% elif package.amount_usd == 100 %}
                                            <h5 class="mb-0">
                                                Large Credit Pack
                                            </h5>
                                            {% else %}
                                            <h5 class="mb-0">
                                                {{
                                                "$%.2f"|format(package.amount_usd)
                                                }} Credit Pack
                                            </h5>
                                            {% endif %}
                                        </div>
                                        <div
                                            class="card-body d-flex flex-column"
                                        >
                                            <div class="text-center mb-3">
                                                <span class="display-6"
                                                    >${{
                                                    "%.2f"|format(package.amount_usd)
                                                    }}</span
                                                >
                                            </div>
                                            <p class="text-center">
                                                Pay what you use - no minimums
                                            </p>
                                            <div class="mt-auto">
                                                <ul
                                                    class="list-group list-group-flush mb-3"
                                                >
                                                    <li
                                                        class="list-group-item bg-transparent text-light"
                                                    >
                                                        <i
                                                            class="fas fa-check-circle text-success me-2"
                                                        ></i
                                                        >Access premium models
                                                    </li>
                                                    <li
                                                        class="list-group-item bg-transparent text-light"
                                                    >
                                                        <i
                                                            class="fas fa-check-circle text-success me-2"
                                                        ></i
                                                        >Tax calculated at
                                                        checkout
                                                    </li>
                                                    <li
                                                        class="list-group-item bg-transparent text-light"
                                                    >
                                                        <i
                                                            class="fas fa-check-circle text-success me-2"
                                                        ></i
                                                        >Secure payment via
                                                        Stripe
                                                    </li>
                                                </ul>
                                                <form
                                                    id="purchase-form-{{package.id}}"
                                                    action="{{ url_for('billing.purchase_package', package_id=package.id) }}"
                                                    method="post"
                                                >
                                                    <input
                                                        type="hidden"
                                                        name="csrf_token"
                                                        value="{{ csrf_token() }}"
                                                    />
                                                    <button
                                                        type="submit"
                                                        class="btn btn-primary w-100"
                                                    >
                                                        Buy Now
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %} {% endfor %}
                            </div>

                            <div class="alert alert-info mt-3">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="fas fa-info-circle fa-2x"></i>
                                    </div>
                                    <div>
                                        <h5 class="alert-heading">
                                            Secure Payments
                                        </h5>
                                        <p class="mb-0">
                                            Payments are processed securely by
                                            Stripe. All prices are in USD and
                                            taxes will be calculated at checkout
                                            based on your location.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchase History Tab -->
        <div
            id="history"
            class="tab-pane fade"
            role="tabpanel"
            aria-labelledby="history-tab"
        >
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div
                            class="card-header d-flex justify-content-between align-items-center"
                        >
                            <h5 class="mb-0">Purchase History</h5>
                            <a
                                href="{{ url_for('billing.export_transactions_csv') }}"
                                class="btn btn-sm btn-outline-secondary"
                            >
                                <i class="fas fa-download me-2"></i>Export CSV
                            </a>
                        </div>
                        <div class="card-body">
                            {% if recent_transactions %}
                            <div class="table-responsive">
                                <table
                                    class="table table-dark table-striped table-hover"
                                >
                                    <thead class="table-dark">
                                        <tr>
                                            <th class="text-white">Date</th>
                                            <th class="text-white">Amount</th>
                                            <th class="text-white">
                                                Payment Method
                                            </th>
                                            <th class="text-white">Status</th>
                                            <th class="text-white">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaction in
                                        recent_transactions %}
                                        <tr>
                                            <td class="text-light">
                                                {{
                                                transaction.created_at.strftime('%Y-%m-%d')
                                                }}
                                            </td>
                                            <td class="text-light">
                                                ${{
                                                "%.2f"|format(transaction.amount_usd)
                                                }}
                                            </td>
                                            <td class="text-light">
                                                <span
                                                    class="d-flex align-items-center"
                                                >
                                                    {% if
                                                    transaction.payment_method
                                                    == 'stripe' %}
                                                    <i
                                                        class="fab fa-cc-stripe me-2 text-primary"
                                                    ></i>
                                                    {% else %}
                                                    <i
                                                        class="fas fa-credit-card me-2"
                                                    ></i>
                                                    {% endif %} {{
                                                    transaction.payment_method|capitalize
                                                    }}
                                                </span>
                                            </td>
                                            <td class="text-light">
                                                {% if transaction.status ==
                                                'completed' %}
                                                <span class="badge bg-success"
                                                    >Completed</span
                                                >
                                                {% elif transaction.status ==
                                                'pending' %}
                                                <span
                                                    class="badge bg-warning text-dark"
                                                    >Pending</span
                                                >
                                                {% else %}
                                                <span class="badge bg-danger"
                                                    >Failed</span
                                                >
                                                {% endif %}
                                            </td>
                                            <td class="text-light">
                                                {% if transaction.status ==
                                                'completed' %}
                                                <a
                                                    href="{{ url_for('billing.generate_receipt', transaction_id=transaction.id) }}"
                                                    class="btn btn-sm btn-outline-info"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-placement="top"
                                                    title="Download Receipt"
                                                    target="_blank"
                                                >
                                                    <i
                                                        class="fas fa-receipt"
                                                    ></i>
                                                </a>
                                                {% else %}
                                                <button
                                                    type="button"
                                                    class="btn btn-sm btn-outline-info"
                                                    disabled
                                                    title="Receipt unavailable for pending or failed transactions"
                                                >
                                                    <i
                                                        class="fas fa-receipt"
                                                    ></i>
                                                </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <div class="mb-3">
                                    <i
                                        class="fas fa-receipt fa-3x text-muted"
                                    ></i>
                                </div>
                                <h5>No Purchase History</h5>
                                <p class="text-muted mb-4">
                                    You haven't made any purchases yet.
                                </p>
                                <a
                                    href="#funds"
                                    class="btn btn-primary"
                                    data-bs-toggle="tab"
                                    data-bs-target="#funds"
                                    type="button"
                                    role="tab"
                                    aria-controls="funds"
                                    aria-selected="false"
                                >
                                    <i class="fas fa-credit-card me-2"></i>Add
                                    Credits
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage Analytics Tab -->
        <div
            id="usage"
            class="tab-pane fade"
            role="tabpanel"
            aria-labelledby="usage-tab"
        >
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div
                                class="d-flex justify-content-between align-items-center"
                            >
                                <h5 class="mb-0">Usage Analytics</h5>
                                <div>
                                    <div class="btn-group me-2">
                                        <button
                                            class="btn btn-sm btn-outline-secondary active"
                                            id="summaryViewBtn"
                                            data-bs-toggle="tab"
                                            data-bs-target="#usage-summary-tab"
                                        >
                                            <i class="fas fa-chart-pie me-1"></i
                                            >Summary
                                        </button>
                                        <button
                                            class="btn btn-sm btn-outline-secondary"
                                            id="detailedViewBtn"
                                            data-bs-toggle="tab"
                                            data-bs-target="#usage-detailed-tab"
                                        >
                                            <i class="fas fa-table me-1"></i
                                            >Detailed
                                        </button>
                                    </div>
                                    <button
                                        class="btn btn-sm btn-outline-secondary"
                                        id="exportCsvBtn"
                                    >
                                        <i class="fas fa-download me-1"></i>
                                        Export CSV
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card-body">
                            <!-- Date Range Selector -->
                            <div class="mb-4">
                                <h6>Date Range</h6>
                                <div class="btn-group">
                                    <button
                                        class="btn btn-sm btn-outline-secondary"
                                        data-range="30"
                                    >
                                        Last 30 Days
                                    </button>
                                    <button
                                        class="btn btn-sm btn-outline-secondary"
                                        data-range="7"
                                    >
                                        Last 7 Days
                                    </button>
                                    <button
                                        class="btn btn-sm btn-outline-secondary active"
                                        data-range="1"
                                    >
                                        Last 24 Hours
                                    </button>
                                    <button
                                        class="btn btn-sm btn-outline-secondary"
                                        data-range="month"
                                    >
                                        This Month
                                    </button>
                                </div>
                            </div>

                            <!-- Usage Analytics Content -->
                            <div class="tab-content">
                                <!-- Summary View -->
                                <div
                                    id="usage-summary-tab"
                                    class="tab-pane fade show active"
                                    role="tabpanel"
                                    aria-labelledby="summaryViewBtn"
                                >
                                    {% if recent_usage %}
                                    <!-- Usage Statistics Cards -->
                                    <div class="row mb-4">
                                        <div class="col-md-4 mb-3">
                                            <div class="card bg-dark h-100">
                                                <div
                                                    class="card-body text-center"
                                                >
                                                    <i
                                                        class="fas fa-calculator fa-2x mb-3 text-primary"
                                                    ></i>
                                                    <h2 class="text-light">
                                                        {% set total_spent =
                                                        namespace(value=0) %} {%
                                                        for usage in
                                                        recent_usage %} {% set
                                                        total_spent.value =
                                                        total_spent.value +
                                                        (usage.credits_used /
                                                        100000) %} {% endfor %}
                                                        ${{
                                                        "%.2f"|format(total_spent.value)
                                                        }}
                                                    </h2>
                                                    <p class="text-muted">
                                                        Total Spent
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="card bg-dark h-100">
                                                <div
                                                    class="card-body text-center"
                                                >
                                                    <i
                                                        class="fas fa-tag fa-2x mb-3 text-success"
                                                    ></i>
                                                    <h2 class="text-light">
                                                        {% set total_tokens =
                                                        namespace(value=0) %} {%
                                                        for usage in
                                                        recent_usage %} {% if
                                                        usage.prompt_tokens %}
                                                        {% set
                                                        total_tokens.value =
                                                        total_tokens.value +
                                                        usage.prompt_tokens %}
                                                        {% endif %} {% if
                                                        usage.completion_tokens
                                                        %} {% set
                                                        total_tokens.value =
                                                        total_tokens.value +
                                                        usage.completion_tokens
                                                        %} {% endif %} {% endfor
                                                        %} {{ total_tokens.value
                                                        }}
                                                    </h2>
                                                    <p class="text-muted">
                                                        Total Tokens
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="card bg-dark h-100">
                                                <div
                                                    class="card-body text-center"
                                                >
                                                    <i
                                                        class="fas fa-bolt fa-2x mb-3 text-warning"
                                                    ></i>
                                                    <h2 class="text-light">
                                                        {{ recent_usage|length
                                                        }}
                                                    </h2>
                                                    <p class="text-muted">
                                                        API Requests
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="table-responsive">
                                        <table
                                            class="table table-dark table-striped table-hover"
                                        >
                                            <thead class="table-dark">
                                                <tr>
                                                    <th
                                                        style="min-width: 110px"
                                                        class="text-white"
                                                    >
                                                        Date
                                                    </th>
                                                    <th
                                                        style="min-width: 80px"
                                                        class="text-white"
                                                    >
                                                        Type
                                                    </th>
                                                    <th
                                                        style="min-width: 180px"
                                                        class="text-white"
                                                    >
                                                        Model
                                                    </th>
                                                    <th
                                                        style="min-width: 80px"
                                                        class="text-white"
                                                    >
                                                        Cost
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for usage in recent_usage %}
                                                <tr>
                                                    <td class="text-light">
                                                        {{
                                                        usage.created_at.strftime('%Y-%m-%d')
                                                        }}
                                                    </td>
                                                    <td class="text-light">
                                                        <span
                                                            class="badge {% if usage.usage_type == 'chat' %}bg-info{% elif usage.usage_type == 'embedding' %}bg-warning text-dark{% else %}bg-secondary{% endif %}"
                                                        >
                                                            {{
                                                            usage.usage_type|capitalize
                                                            }}
                                                        </span>
                                                    </td>
                                                    <td class="text-light">
                                                        {{ usage.model_id }}
                                                    </td>
                                                    <td class="text-light">
                                                        ${{
                                                        "%.4f"|format(usage.credits_used
                                                        / 100000) }}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <div class="mb-3">
                                            <i
                                                class="fas fa-chart-line fa-3x text-muted"
                                            ></i>
                                        </div>
                                        <h5>No Usage Data</h5>
                                        <p class="text-muted mb-4">
                                            No usage data available for the
                                            selected time period.
                                        </p>
                                        <div
                                            class="d-flex justify-content-center gap-3"
                                        >
                                            <button
                                                class="btn btn-outline-secondary"
                                            >
                                                <i
                                                    class="fas fa-calendar-alt me-2"
                                                ></i
                                                >Change Date Range
                                            </button>
                                            <a
                                                href="{{ url_for('index') }}"
                                                class="btn btn-primary"
                                            >
                                                <i class="fas fa-robot me-2"></i
                                                >Try Using Models
                                            </a>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Detailed View -->
                                <div
                                    id="usage-detailed-tab"
                                    class="tab-pane fade"
                                    role="tabpanel"
                                    aria-labelledby="detailedViewBtn"
                                >
                                    {% if recent_usage %}
                                    <div class="table-responsive">
                                        <table
                                            class="table table-dark table-striped table-hover"
                                        >
                                            <thead class="table-dark">
                                                <tr>
                                                    <th
                                                        style="min-width: 110px"
                                                        class="text-white"
                                                    >
                                                        Date
                                                    </th>
                                                    <th
                                                        style="min-width: 180px"
                                                        class="text-white"
                                                    >
                                                        Model
                                                    </th>
                                                    <th
                                                        style="min-width: 100px"
                                                        class="text-white"
                                                    >
                                                        Input Tokens
                                                    </th>
                                                    <th
                                                        style="min-width: 100px"
                                                        class="text-white"
                                                    >
                                                        Input Cost
                                                    </th>
                                                    <th
                                                        style="min-width: 100px"
                                                        class="text-white"
                                                    >
                                                        Output Tokens
                                                    </th>
                                                    <th
                                                        style="min-width: 100px"
                                                        class="text-white"
                                                    >
                                                        Output Cost
                                                    </th>
                                                    <th
                                                        style="min-width: 100px"
                                                        class="text-white"
                                                    >
                                                        Total Cost
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for usage in recent_usage %}
                                                <tr>
                                                    <td class="text-light">
                                                        {{
                                                        usage.created_at.strftime('%Y-%m-%d
                                                        %H:%M') }}
                                                    </td>
                                                    <td class="text-light">
                                                        {{ usage.model_id }}
                                                    </td>
                                                    <td class="text-light">
                                                        {{ usage.prompt_tokens
                                                        if usage.prompt_tokens
                                                        else 'N/A' }}
                                                    </td>
                                                    <td class="text-light">
                                                        {% if
                                                        usage.prompt_tokens and
                                                        usage.model_id %} {% set
                                                        input_cost =
                                                        ((usage.credits_used /
                                                        100000) * 0.7)|float %}
                                                        ${{
                                                        "%.4f"|format(input_cost)
                                                        }} {% else %} N/A {%
                                                        endif %}
                                                    </td>
                                                    <td class="text-light">
                                                        {{
                                                        usage.completion_tokens
                                                        if
                                                        usage.completion_tokens
                                                        else 'N/A' }}
                                                    </td>
                                                    <td class="text-light">
                                                        {% if
                                                        usage.completion_tokens
                                                        and usage.model_id %} {%
                                                        set output_cost =
                                                        ((usage.credits_used /
                                                        100000) * 0.3)|float %}
                                                        ${{
                                                        "%.4f"|format(output_cost)
                                                        }} {% else %} N/A {%
                                                        endif %}
                                                    </td>
                                                    <td class="text-light">
                                                        ${{
                                                        "%.4f"|format(usage.credits_used
                                                        / 100000) }}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <div class="mb-3">
                                            <i
                                                class="fas fa-chart-line fa-3x text-muted"
                                            ></i>
                                        </div>
                                        <h5>No Usage Data</h5>
                                        <p class="text-muted mb-4">
                                            No usage data available for the
                                            selected time period.
                                        </p>
                                        <div
                                            class="d-flex justify-content-center gap-3"
                                        >
                                            <button
                                                class="btn btn-outline-secondary"
                                            >
                                                <i
                                                    class="fas fa-calendar-alt me-2"
                                                ></i
                                                >Change Date Range
                                            </button>
                                            <a
                                                href="{{ url_for('index') }}"
                                                class="btn btn-primary"
                                            >
                                                <i class="fas fa-robot me-2"></i
                                                >Try Using Models
                                            </a>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pricing Tab -->
        <div
            id="pricing"
            class="tab-pane fade"
            role="tabpanel"
            aria-labelledby="pricing-tab"
        >
            <div class="balance-card p-4">
                <h4 class="mb-3">Model Pricing</h4>
                <p class="caption mb-4">
                    Pricing information for all available AI models. Click on
                    any column header to sort by that attribute.
                </p>

                <div
                    class="d-flex justify-content-between align-items-center mb-3"
                >
                    <div>
                        <span id="lastUpdated" class="caption"></span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-search text-muted me-2"></i>
                        <input
                            type="text"
                            class="form-control custom-amount-input"
                            id="modelSearch"
                            placeholder="Search models..."
                        />
                    </div>
                </div>

                <div class="mt-3 mb-2">
                    <span class="caption"
                        >‚Ä¢ Prices are per million tokens ‚Ä¢ All prices include
                        our platform fee</span
                    >
                </div>

                <div
                    class="table-responsive mt-2"
                    style="max-height: 600px; overflow-y: auto"
                >
                    <table
                        class="table table-dark table-hover table-striped"
                        id="pricingTable"
                    >
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th
                                    onclick="sortPricingTable(0)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom py-3"
                                >
                                    <div
                                        class="d-flex justify-content-between align-items-center"
                                    >
                                        Model
                                        <i
                                            id="sort-icon-0"
                                            class="fas fa-sort-up"
                                        ></i>
                                    </div>
                                </th>
                                <th
                                    onclick="sortPricingTable(1)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom text-end py-3"
                                >
                                    <div
                                        class="d-flex justify-content-end align-items-center"
                                    >
                                        Input Cost
                                        <i
                                            id="sort-icon-1"
                                            class="fas fa-sort"
                                        ></i>
                                    </div>
                                </th>
                                <th
                                    onclick="sortPricingTable(2)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom text-end py-3"
                                >
                                    <div
                                        class="d-flex justify-content-end align-items-center"
                                    >
                                        Output Cost
                                        <i
                                            id="sort-icon-2"
                                            class="fas fa-sort"
                                        ></i>
                                    </div>
                                </th>
                                <th
                                    onclick="sortPricingTable(3)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom text-end py-3"
                                >
                                    <div
                                        class="d-flex justify-content-end align-items-center"
                                    >
                                        Context
                                        <i
                                            id="sort-icon-3"
                                            class="fas fa-sort"
                                        ></i>
                                    </div>
                                </th>
                                <th
                                    onclick="sortPricingTable(4)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom text-center py-3"
                                >
                                    <div
                                        class="d-flex justify-content-center align-items-center"
                                    >
                                        Multimodal
                                        <i
                                            id="sort-icon-4"
                                            class="fas fa-sort"
                                        ></i>
                                    </div>
                                </th>
                                <th
                                    onclick="sortPricingTable(5)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom text-center py-3"
                                >
                                    <div
                                        class="d-flex justify-content-center align-items-center"
                                    >
                                        PDFs
                                        <i
                                            id="sort-icon-5"
                                            class="fas fa-sort"
                                        ></i>
                                    </div>
                                </th>
                                <th
                                    onclick="sortPricingTable(6)"
                                    style="
                                        cursor: pointer;
                                        position: sticky;
                                        top: 0;
                                        z-index: 10;
                                        background-color: #212529;
                                    "
                                    class="border-bottom text-center py-3"
                                >
                                    <div
                                        class="d-flex justify-content-center align-items-center"
                                    >
                                        Cost Band
                                        <i
                                            id="sort-icon-6"
                                            class="fas fa-sort"
                                        ></i>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="pricingTableBody">
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <div
                                        class="d-flex flex-column align-items-center"
                                    >
                                        <div
                                            class="spinner-border text-info mb-3"
                                            role="status"
                                        >
                                            <span class="visually-hidden"
                                                >Loading...</span
                                            >
                                        </div>
                                        <p class="caption">
                                            Loading pricing data from
                                            OpenRouter...
                                        </p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pricing table styles moved to static/css/style.css -->

                <!-- Error message removed as requested -->

                <div class="mt-3">
                    <p class="caption text-muted">
                        <i class="fas fa-info-circle"></i> The pricing
                        information is fetched directly from OpenRouter and our
                        internal pricing configuration. Prices may vary based on
                        model updates and availability.
                    </p>
                </div>
            </div>
        </div>

        <!-- Account Settings Tab -->
        <div
            id="settings"
            class="tab-pane fade"
            role="tabpanel"
            aria-labelledby="settings-tab"
        >
            <div class="balance-card p-4">
                <h4 class="mb-4">Account Settings</h4>

                <form>
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <p class="p-2 bg-dark rounded">{{ user.username }}</p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email Address</label>
                        <p class="p-2 bg-dark rounded">{{ user.email }}</p>
                    </div>

                    <hr class="my-4" style="border-color: #3f4246" />

                    <h5>Chat Preferences</h5>
                    <div class="mb-3 form-check">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enableMemory"
                            {%
                            if
                            user.enable_memory
                            %}checked{%
                            endif
                            %}
                        />
                        <label class="form-check-label" for="enableMemory"
                            >Enable chat memory across sessions</label
                        >
                        <small class="form-text text-muted d-block mt-1">
                            When enabled, the AI can remember and reference
                            information from your previous conversations.
                            Disabling this may reduce token usage for new chats.
                        </small>
                    </div>

                    <div class="mb-3 form-check">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enableModelFallback"
                            {%
                            if
                            user.enable_model_fallback
                            %}checked{%
                            endif
                            %}
                        />
                        <label
                            class="form-check-label"
                            for="enableModelFallback"
                            >Enable model fallback</label
                        >
                        <small class="form-text text-muted d-block mt-1">
                            When enabled, if your chosen model is unavailable,
                            the system will automatically use a similar
                            alternative. When disabled, you'll be notified if
                            your selected model can't be reached.
                        </small>
                    </div>

                    <!-- Advanced Chat Preferences Section -->
                    <div class="mt-4">
                        <h5 class="d-flex align-items-center">
                            <span>Advanced Chat Preferences</span>
                            <button
                                id="toggleAdvancedPrefs"
                                class="btn btn-sm btn-outline-secondary ms-2"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#advancedChatPrefs"
                                aria-expanded="false"
                                aria-controls="advancedChatPrefs"
                            >
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h5>
                        <small class="form-text text-muted d-block mb-3">
                            Fine-tune how AI models respond to your prompts.
                            Leave settings at default unless you need specific
                            behavior.
                        </small>

                        <div class="collapse" id="advancedChatPrefs">
                            <div
                                class="card card-body bg-dark border-secondary"
                            >
                                <div class="d-flex justify-content-end mb-3">
                                    <button
                                        type="button"
                                        id="resetAllDefaults"
                                        class="btn btn-sm btn-outline-warning"
                                    >
                                        <i class="fas fa-undo me-1"></i> Reset
                                        All to Defaults
                                    </button>
                                </div>

                                <!-- Temperature -->
                                <div class="mb-4">
                                    <label
                                        for="temperature"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Temperature</span>
                                        <span
                                            class="badge bg-secondary"
                                            id="temperatureValue"
                                            >Default</span
                                        >
                                    </label>
                                    <div
                                        class="d-flex align-items-center gap-2"
                                    >
                                        <input
                                            type="range"
                                            class="form-range flex-grow-1"
                                            id="temperatureSlider"
                                            min="0"
                                            max="2"
                                            step="0.01"
                                        />
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="temperature"
                                            style="width: 70px"
                                            min="0"
                                            max="2"
                                            step="0.01"
                                        />
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="temperature"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Controls randomness in responses. Lower
                                        values are more deterministic, higher
                                        values more creative.
                                    </small>
                                </div>

                                <!-- Top P -->
                                <div class="mb-4">
                                    <label
                                        for="topP"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Top P (Nucleus Sampling)</span>
                                        <span
                                            class="badge bg-secondary"
                                            id="topPValue"
                                            >Default</span
                                        >
                                    </label>
                                    <div
                                        class="d-flex align-items-center gap-2"
                                    >
                                        <input
                                            type="range"
                                            class="form-range flex-grow-1"
                                            id="topPSlider"
                                            min="0"
                                            max="1"
                                            step="0.01"
                                        />
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="topP"
                                            style="width: 70px"
                                            min="0"
                                            max="1"
                                            step="0.01"
                                        />
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="topP"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Controls diversity in word choices.
                                        Higher values increase variety.
                                    </small>
                                </div>

                                <!-- Max Tokens -->
                                <div class="mb-4">
                                    <label
                                        for="maxTokens"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Max Tokens</span>
                                        <span
                                            class="badge bg-secondary"
                                            id="maxTokensValue"
                                            >Default (Max)</span
                                        >
                                    </label>
                                    <div class="mb-2">
                                        <div
                                            class="form-check form-check-inline"
                                        >
                                            <input
                                                class="form-check-input"
                                                type="radio"
                                                name="maxTokensOption"
                                                id="maxTokensMax"
                                                value="max"
                                                checked
                                            />
                                            <label
                                                class="form-check-label"
                                                for="maxTokensMax"
                                                >Max (Default)</label
                                            >
                                        </div>
                                        <div
                                            class="form-check form-check-inline"
                                        >
                                            <input
                                                class="form-check-input"
                                                type="radio"
                                                name="maxTokensOption"
                                                id="maxTokensSpecific"
                                                value="specific"
                                            />
                                            <label
                                                class="form-check-label"
                                                for="maxTokensSpecific"
                                                >Specific value</label
                                            >
                                        </div>
                                    </div>
                                    <div
                                        class="d-flex align-items-center gap-2"
                                        id="maxTokensInputGroup"
                                    >
                                        <input
                                            type="range"
                                            class="form-range flex-grow-1"
                                            id="maxTokensSlider"
                                            min="1"
                                            max="8000"
                                            step="1"
                                            disabled
                                        />
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="maxTokens"
                                            style="width: 90px"
                                            min="1"
                                            max="8000"
                                            step="1"
                                            disabled
                                        />
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="maxTokens"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Maximum response length. Note: Will be
                                        automatically capped based on model
                                        limits.
                                    </small>
                                </div>

                                <!-- Frequency Penalty -->
                                <div class="mb-4">
                                    <label
                                        for="frequencyPenalty"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Frequency Penalty</span>
                                        <span
                                            class="badge bg-secondary"
                                            id="frequencyPenaltyValue"
                                            >Default</span
                                        >
                                    </label>
                                    <div
                                        class="d-flex align-items-center gap-2"
                                    >
                                        <input
                                            type="range"
                                            class="form-range flex-grow-1"
                                            id="frequencyPenaltySlider"
                                            min="-2"
                                            max="2"
                                            step="0.01"
                                        />
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="frequencyPenalty"
                                            style="width: 70px"
                                            min="-2"
                                            max="2"
                                            step="0.01"
                                        />
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="frequencyPenalty"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Reduces repetition of frequent tokens.
                                        Higher values reduce word repetition.
                                    </small>
                                </div>

                                <!-- Presence Penalty -->
                                <div class="mb-4">
                                    <label
                                        for="presencePenalty"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Presence Penalty</span>
                                        <span
                                            class="badge bg-secondary"
                                            id="presencePenaltyValue"
                                            >Default</span
                                        >
                                    </label>
                                    <div
                                        class="d-flex align-items-center gap-2"
                                    >
                                        <input
                                            type="range"
                                            class="form-range flex-grow-1"
                                            id="presencePenaltySlider"
                                            min="-2"
                                            max="2"
                                            step="0.01"
                                        />
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="presencePenalty"
                                            style="width: 70px"
                                            min="-2"
                                            max="2"
                                            step="0.01"
                                        />
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="presencePenalty"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Reduces repetition of topics. Higher
                                        values encourage exploring new topics.
                                    </small>
                                </div>

                                <!-- Top K -->
                                <div class="mb-4">
                                    <label
                                        for="topK"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Top K</span>
                                        <span
                                            class="badge bg-secondary"
                                            id="topKValue"
                                            >Default</span
                                        >
                                    </label>
                                    <div
                                        class="d-flex align-items-center gap-2"
                                    >
                                        <input
                                            type="range"
                                            class="form-range flex-grow-1"
                                            id="topKSlider"
                                            min="0"
                                            max="100"
                                            step="1"
                                        />
                                        <input
                                            type="number"
                                            class="form-control form-control-sm"
                                            id="topK"
                                            style="width: 70px"
                                            min="0"
                                            max="100"
                                            step="1"
                                        />
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="topK"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Limits vocabulary to most likely
                                        options. Lower values make responses
                                        more focused.
                                    </small>
                                </div>

                                <!-- Stop Sequences -->
                                <div class="mb-4">
                                    <label
                                        for="stopSequences"
                                        class="form-label d-flex justify-content-between"
                                    >
                                        <span>Stop Sequences</span>
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary reset-param"
                                            data-param="stopSequences"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </label>
                                    <div class="mb-2">
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="stopSequences"
                                            placeholder="Enter sequence and press Enter"
                                        />
                                    </div>
                                    <div
                                        id="stopSequencesList"
                                        class="d-flex flex-wrap gap-2"
                                    >
                                        <!-- Stop sequences will be added here dynamically -->
                                    </div>
                                    <small class="form-text text-muted">
                                        Sequences where the AI will stop
                                        generating further tokens. Add multiple
                                        by pressing Enter after each.
                                    </small>
                                </div>

                                <!-- Response Format -->
                                <div class="mb-4">
                                    <label class="form-label"
                                        >Response Format</label
                                    >
                                    <div class="d-flex align-items-center mb-2">
                                        <div
                                            class="form-check form-check-inline"
                                        >
                                            <input
                                                class="form-check-input"
                                                type="radio"
                                                name="responseFormat"
                                                id="responseFormatText"
                                                value="text"
                                                checked
                                            />
                                            <label
                                                class="form-check-label"
                                                for="responseFormatText"
                                                >Natural Text (Default)</label
                                            >
                                        </div>
                                        <div
                                            class="form-check form-check-inline"
                                        >
                                            <input
                                                class="form-check-input"
                                                type="radio"
                                                name="responseFormat"
                                                id="responseFormatJson"
                                                value="json"
                                            />
                                            <label
                                                class="form-check-label"
                                                for="responseFormatJson"
                                                >JSON Structure</label
                                            >
                                        </div>
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary ms-2 reset-param"
                                            data-param="responseFormat"
                                        >
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Format for AI responses. JSON format is
                                        useful for structured data.
                                    </small>
                                </div>

                                <div class="d-grid">
                                    <button
                                        type="button"
                                        id="saveAdvancedPrefs"
                                        class="btn btn-primary"
                                    >
                                        <i class="fas fa-save me-1"></i> Save
                                        Advanced Preferences
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4" style="border-color: #3f4246" />

                    <h5>Notification Preferences</h5>
                    <div class="mb-3 form-check">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="emailNotifications"
                            checked
                        />
                        <label class="form-check-label" for="emailNotifications"
                            >Receive email notifications</label
                        >
                    </div>
                    <div class="mb-3 form-check">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="lowBalanceAlerts"
                            checked
                        />
                        <label class="form-check-label" for="lowBalanceAlerts"
                            >Low balance alerts</label
                        >
                    </div>

                    <hr class="my-4" style="border-color: #3f4246" />

                    <h5>Danger Zone</h5>
                    <p class="caption">
                        These actions cannot be undone. Please proceed with
                        caution.
                    </p>

                    <div class="mt-3 mb-4">
                        <button
                            id="clear-conversations-btn-account"
                            class="btn btn-danger"
                        >
                            <i class="fa-regular fa-trash-can me-2"></i> Clear
                            All Conversations
                        </button>
                        <p class="text-muted mt-2 small">
                            <i class="fas fa-info-circle me-1"></i> This action
                            will permanently delete all your conversation
                            history.
                        </p>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="select-button bg-danger">
                            Delete Account
                        </button>
                        <button
                            type="button"
                            class="select-button"
                            style="background-color: #fd7e14"
                        >
                            Export My Data
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tell a Friend Tab (Direct Implementation) -->
        <div
            id="tellFriend"
            class="tab-pane fade"
            role="tabpanel"
            aria-labelledby="tellFriend-tab"
        >
            <!-- Debug Script for Almost Ready Message -->
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    console.log(
                        'üîç Searching DOM for "Almost Ready" message...',
                    );

                    // Search all text nodes in the document for "Almost Ready" text
                    let found = false;
                    const searchText = function (element) {
                        if (element.nodeType === Node.TEXT_NODE) {
                            if (element.textContent.includes("Almost Ready")) {
                                console.log(
                                    'üéØ Found "Almost Ready" text in:',
                                    element,
                                );
                                console.log(
                                    "üìå Parent element:",
                                    element.parentNode,
                                );
                                found = true;
                            }
                        } else {
                            for (
                                let i = 0;
                                i < element.childNodes.length;
                                i++
                            ) {
                                searchText(element.childNodes[i]);
                            }
                        }
                    };

                    // Give a slight delay for all content to load, including any dynamically added content
                    setTimeout(function () {
                        searchText(document.body);
                        if (!found) {
                            console.log(
                                '‚ùå No "Almost Ready" text found in the DOM.',
                            );
                        }
                    }, 1000);
                });
            </script>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-dark">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Your Affiliate Dashboard</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-8 mb-4 mb-md-0">
                                    <div class="mb-4">
                                        <h5 class="mb-3">Your Referral Link</h5>
                                        <div
                                            style="
                                                display: flex;
                                                width: 100%;
                                                margin-bottom: 10px;
                                            "
                                        >
                                            <div
                                                class="form-control"
                                                id="referralLink"
                                                style="
                                                    flex: 1;
                                                    padding: 10px;
                                                    background-color: #2c2f33;
                                                    color: #e4e6eb;
                                                    border-color: #3f4246;
                                                    overflow: hidden;
                                                    text-overflow: ellipsis;
                                                    white-space: nowrap;
                                                    cursor: text;
                                                "
                                            >
                                                {{ request.host_url }}?ref={{
                                                current_user.referral_code }}
                                            </div>
                                            <button
                                                class="btn btn-outline-primary"
                                                type="button"
                                                id="copyReferralLink"
                                                style="
                                                    flex-shrink: 0;
                                                    margin-left: 5px;
                                                "
                                            >
                                                <i class="fas fa-copy"></i> Copy
                                            </button>
                                        </div>
                                        <p class="form-text mt-2">
                                            Share this link to earn commissions
                                            on your friends' purchases.
                                        </p>
                                    </div>

                                    <div class="alert alert-info mb-4">
                                        <div class="d-flex">
                                            <div class="me-3">
                                                <i
                                                    class="fas fa-lightbulb fa-2x text-warning"
                                                ></i>
                                            </div>
                                            <div>
                                                <h5 class="alert-heading">
                                                    Quick Tip
                                                </h5>
                                                <p class="mb-0">
                                                    Want to share a specific
                                                    page or chat? Just add
                                                    <code
                                                        >?ref={{
                                                        current_user.referral_code
                                                        }}</code
                                                    >
                                                    to the end of any
                                                    GloriaMundo URL!
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <!-- QR Code for Mobile Sharing -->
                                    <div class="card h-100 border-primary">
                                        <div
                                            class="card-header bg-primary text-white"
                                        >
                                            <h5 class="mb-0">
                                                Share via QR Code
                                            </h5>
                                        </div>
                                        <div class="card-body text-center">
                                            <img
                                                src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data={{ request.host_url|urlencode }}?ref={{ current_user.referral_code }}"
                                                alt="Your Referral QR Code"
                                                class="img-fluid mb-2"
                                                style="
                                                    max-width: 100%;
                                                    height: auto;
                                                "
                                            />
                                            <p class="mb-0 small">
                                                Scan with a smartphone camera to
                                                quickly share your link
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <div class="card border-0 mb-4">
                                        <div
                                            class="card-header bg-dark text-white"
                                        >
                                            <h5 class="mb-0">
                                                PayPal Email for Payouts
                                            </h5>
                                        </div>
                                        <div class="card-body bg-dark">
                                            <div class="mb-4">
                                                <div
                                                    class="d-flex align-items-center mb-3"
                                                    style="gap: 10px"
                                                    id="current-paypal-email"
                                                >
                                                    <!-- Current email display -->
                                                    <div
                                                        class="border rounded p-3 bg-dark flex-grow-1"
                                                        style="
                                                            word-break: break-all;
                                                        "
                                                    >
                                                        <i
                                                            class="fab fa-paypal text-primary me-2"
                                                        ></i>
                                                        <span
                                                            id="currentPaypalEmail"
                                                            >{{
                                                            current_user.paypal_email
                                                            or 'Not set'
                                                            }}</span
                                                        >
                                                    </div>
                                                    <button
                                                        class="btn btn-outline-primary"
                                                        type="button"
                                                        id="editPaypalBtn"
                                                        style="flex-shrink: 0"
                                                    >
                                                        <i
                                                            class="fas fa-edit"
                                                        ></i>
                                                        Edit
                                                    </button>
                                                </div>
                                                <form
                                                    id="paypalEmailForm"
                                                    style="
                                                        display: none;
                                                        margin-top: 15px;
                                                        width: 100%;
                                                    "
                                                >
                                                    <input
                                                        type="hidden"
                                                        name="csrf_token"
                                                        value="{{ csrf_token() }}"
                                                        id="paypal_csrf_token"
                                                    />
                                                    <input
                                                        type="hidden"
                                                        id="paypal_update_endpoint"
                                                        value="{{ url_for('affiliate.update_paypal_email') }}"
                                                    />
                                                    <div class="mb-3">
                                                        <label
                                                            for="paypal_email"
                                                            class="form-label"
                                                            >PayPal Email
                                                            Address</label
                                                        >
                                                        <input
                                                            type="email"
                                                            class="form-control form-control-lg"
                                                            id="paypal_email"
                                                            name="paypal_email"
                                                            placeholder="Enter your PayPal email"
                                                            value="{{ current_user.paypal_email or '' }}"
                                                            required
                                                            style="
                                                                min-width: 300px;
                                                                width: 100%;
                                                                font-size: 16px;
                                                                padding: 10px;
                                                            "
                                                        />
                                                    </div>
                                                    <div
                                                        class="d-flex gap-2 mb-2"
                                                    >
                                                        <button
                                                            class="btn btn-primary"
                                                            type="button"
                                                            id="savePaypalBtn"
                                                        >
                                                            Save Changes
                                                        </button>
                                                        <button
                                                            class="btn btn-outline-secondary"
                                                            type="button"
                                                            id="cancelEditBtn"
                                                        >
                                                            Cancel
                                                        </button>
                                                    </div>
                                                    <div
                                                        class="alert alert-success d-none"
                                                        id="paypalSuccessAlert"
                                                    >
                                                        PayPal email updated
                                                        successfully!
                                                    </div>
                                                    <div
                                                        class="alert alert-danger d-none"
                                                        id="paypalErrorAlert"
                                                    >
                                                        Error updating PayPal
                                                        email.
                                                    </div>
                                                    <div class="form-text">
                                                        We use this email to
                                                        send your affiliate
                                                        commission payments.
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PayPal email editor functionality moved to paypal_email_updater.js -->
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    console.log(
                        "New affiliate template loaded directly in account.html",
                    );

                    // Copy referral link functionality
                    const copyBtn = document.getElementById("copyReferralLink");
                    const referralLinkEl =
                        document.getElementById("referralLink");

                    if (copyBtn && referralLinkEl) {
                        copyBtn.addEventListener("click", function () {
                            // Get the text to copy
                            const textToCopy = referralLinkEl.textContent;

                            // Copy to clipboard
                            navigator.clipboard
                                .writeText(textToCopy)
                                .then(() => {
                                    const originalText = copyBtn.innerHTML;
                                    copyBtn.innerHTML =
                                        '<i class="fas fa-check"></i> Copied!';

                                    setTimeout(function () {
                                        copyBtn.innerHTML = originalText;
                                    }, 2000);
                                })
                                .catch((err) => {
                                    console.error("Error copying text: ", err);
                                });
                        });
                    }
                });
            </script>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/advanced_chat_preferences.js') }}"></script>
<script src="{{ url_for('static', filename='js/paypal_email_updater.js') }}"></script>
<script>
    /*
     * Simplified affiliate functions - specifically created to fix
     * the "Almost Ready!" message problem by replacing the old
     * affiliate initialization code with simplified version
     */
    function initializeSimplifiedAffiliateFunctions() {
        console.log('Initializing simplified affiliate functions');

        // PayPal email functionality moved to dedicated file: static/js/paypal_email_updater.js

        // Copy referral link functionality
        const copyBtn = document.getElementById('copyReferralLink');
        const referralLinkInput = document.getElementById('referralLink');

        if (copyBtn && referralLinkInput) {
            copyBtn.addEventListener('click', function() {
                // Get the text to copy
                const textToCopy = referralLinkInput.textContent;

                // Use modern Clipboard API with fallback
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => {
                            console.log('Text copied to clipboard successfully');
                            // Show feedback
                            const originalText = copyBtn.innerHTML;
                            copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';

                            // Reset button text after 2 seconds
                            setTimeout(() => {
                                copyBtn.innerHTML = originalText;
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Error copying text: ', err);
                        });
                } else {
                    // Fallback for older browsers
                    console.log('Using fallback clipboard method');

                    // Create a temporary input element
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;

                    // Make the textarea out of viewport
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);

                    // Focus and select the text
                    textArea.focus();
                    textArea.select();

                    // Copy the text
                    let success = false;
                    try {
                        success = document.execCommand('copy');
                    } catch (err) {
                        console.error('Failed to copy: ', err);
                    }

                    // Remove the temporary element
                    document.body.removeChild(textArea);

                    // Provide feedback
                    if (success) {
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';

                        // Reset button text after 2 seconds
                        setTimeout(() => {
                            copyBtn.innerHTML = originalText;
                        }, 2000);
                    } else {
                        copyBtn.innerHTML = '<i class="fas fa-times"></i> Failed';
                        setTimeout(() => {
                            copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
                        }, 2000);
                    }
                }
            });
        }
    }

    // Override the original problem functions that cause "Almost Ready!" message
    window.initializeTellFriendTabContent = function() {
        console.log('Original initializeTellFriendTabContent called - redirected to simplified version');
        initializeSimplifiedAffiliateFunctions();
    };

    window.initializeTellFriendTab = function() {
        console.log('Original initializeTellFriendTab called - redirected to simplified version');
        initializeSimplifiedAffiliateFunctions();
    };

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded event fired - Initializing account page functions');

        // Initialize mobile tab navigation
        initMobileTabNavigation();

        // Function to initialize mobile tab navigation
        function initMobileTabNavigation() {
            // Handle dropdown selector for mobile
            const mobileTabSelector = document.querySelector('.mobile-tab-selector');
            if (mobileTabSelector) {
                mobileTabSelector.addEventListener('change', function(e) {
                    const selectedTab = e.target.value;
                    console.log('Mobile tab selector changed to:', selectedTab);

                    // Update active button states
                    document.querySelectorAll('.mobile-tab-btn').forEach(btn => {
                        if (btn.dataset.tab === selectedTab) {
                            btn.classList.remove('btn-outline-secondary');
                            btn.classList.add('btn-outline-primary');
                        } else {
                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-outline-secondary');
                        }
                    });

                    // Find the Bootstrap tab trigger and activate it
                    const tabTrigger = document.querySelector(`[data-bs-target="#${selectedTab}"]`);
                    if (tabTrigger) {
                        const bsTab = new bootstrap.Tab(tabTrigger);
                        bsTab.show();
                    }
                });
            }

            // Handle mobile tab buttons
            document.querySelectorAll('.mobile-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    console.log('Mobile tab button clicked:', tabName);

                    // Update dropdown value
                    if (mobileTabSelector) {
                        mobileTabSelector.value = tabName;
                    }

                    // Update active button states
                    document.querySelectorAll('.mobile-tab-btn').forEach(btn => {
                        if (btn.dataset.tab === tabName) {
                            btn.classList.remove('btn-outline-secondary');
                            btn.classList.add('btn-outline-primary');
                        } else {
                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-outline-secondary');
                        }
                    });

                    // Find the Bootstrap tab trigger and activate it
                    const tabTrigger = document.querySelector(`[data-bs-target="#${tabName}"]`);
                    if (tabTrigger) {
                        const bsTab = new bootstrap.Tab(tabTrigger);
                        bsTab.show();
                    }
                });
            });

            // Check URL for tab parameter
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            if (tabParam) {
                // Update mobile UI if on mobile
                if (window.innerWidth < 768) {
                    // Update dropdown value
                    if (mobileTabSelector) {
                        mobileTabSelector.value = tabParam;
                    }

                    // Update active button states
                    document.querySelectorAll('.mobile-tab-btn').forEach(btn => {
                        if (btn.dataset.tab === tabParam) {
                            btn.classList.remove('btn-outline-secondary');
                            btn.classList.add('btn-outline-primary');
                        } else {
                            btn.classList.remove('btn-outline-primary');
                            btn.classList.add('btn-outline-secondary');
                        }
                    });
                }

                // Find the Bootstrap tab trigger and activate it
                const tabTrigger = document.querySelector(`[data-bs-target="#${tabParam}"]`);
                if (tabTrigger) {
                    const bsTab = new bootstrap.Tab(tabTrigger);
                    bsTab.show();
                }
            }
        }

        // Utility function for toast notifications
        function showToast(type, message) {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
                toastContainer.style.zIndex = '1050';
                document.body.appendChild(toastContainer);
            }

            // Create a unique ID for this toast
            const toastId = 'toast-' + Date.now();

            // Set color class based on type
            let colorClass = 'bg-primary';
            if (type === 'success') colorClass = 'bg-success';
            else if (type === 'error') colorClass = 'bg-danger';
            else if (type === 'warning') colorClass = 'bg-warning text-dark';

            // Create toast HTML
            const toastHtml = `
                <div id="${toastId}" class="toast ${colorClass} text-white" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header ${colorClass} text-white">
                        <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;

            // Add toast to container
            toastContainer.innerHTML += toastHtml;

            // Initialize and show the toast
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
            toast.show();

            // Remove toast after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Usage Analytics sub-tab functionality
        const summaryViewBtn = document.getElementById('summaryViewBtn');
        const detailedViewBtn = document.getElementById('detailedViewBtn');
        const summaryTab = document.getElementById('usage-summary-tab');
        const detailedTab = document.getElementById('usage-detailed-tab');

        if (summaryViewBtn && detailedViewBtn && summaryTab && detailedTab) {
            summaryViewBtn.addEventListener('click', function() {
                summaryViewBtn.classList.add('active');
                detailedViewBtn.classList.remove('active');

                summaryTab.classList.add('show', 'active');
                detailedTab.classList.remove('show', 'active');
            });

            detailedViewBtn.addEventListener('click', function() {
                detailedViewBtn.classList.add('active');
                summaryViewBtn.classList.remove('active');

                detailedTab.classList.add('show', 'active');
                summaryTab.classList.remove('show', 'active');
            });
        }

        // Initialize date range selection buttons
        const dateRangeButtons = document.querySelectorAll('.btn-group .btn[data-range]');

        // Function to update usage data based on selected date range
        function updateUsageData(dateRange) {
            // Show loading indicator
            const summaryTab = document.getElementById('usage-summary-tab');
            const detailedTab = document.getElementById('usage-detailed-tab');

            if (summaryTab) {
                summaryTab.innerHTML = '<div class="text-center py-3"><i class="fas fa-circle-notch fa-spin fa-2x"></i><p class="mt-2">Loading usage data...</p></div>';
            }

            // Fetch data from API
            fetch(`/billing/get-usage-by-range?range=${dateRange}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update tabs with new data
                        updateSummaryTab(data);
                        updateDetailedTab(data);
                    } else {
                        // Show error
                        if (summaryTab) {
                            summaryTab.innerHTML = `<div class="text-center py-5"><div class="mb-3"><i class="fas fa-exclamation-circle fa-3x text-danger"></i></div><h5>Error Loading Data</h5><p class="text-muted mb-4">${data.message}</p></div>`;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching usage data:', error);
                    if (summaryTab) {
                        summaryTab.innerHTML = '<div class="text-center py-5"><div class="mb-3"><i class="fas fa-exclamation-circle fa-3x text-danger"></i></div><h5>Error Loading Data</h5><p class="text-muted mb-4">Failed to load usage data. Please try again later.</p></div>';
                    }
                });
        }

        // Function to create stats boxes that appear in both tabs
        function createStatsBoxes(data) {
            return `
                <div class="row mb-4">
                    <div class="col-md-4 mb-3">
                        <div class="card bg-dark h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-bolt fa-2x mb-3 text-warning"></i>
                                <h2 class="text-light">${data.total_requests}</h2>
                                <p class="text-muted">API Requests</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-dark h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-dollar-sign fa-2x mb-3 text-success"></i>
                                <h2 class="text-light">$${(data.total_credits / 100000).toFixed(2)}</h2>
                                <p class="text-muted">Total Cost</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-dark h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-calculator fa-2x mb-3 text-info"></i>
                                <h2 class="text-light">$${data.total_requests > 0 ? (data.total_credits / 100000 / data.total_requests).toFixed(3) : "0.000"}</h2>
                                <p class="text-muted">Avg. Cost per Request</p>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // Function to create "no data" message
        function createNoDataMessage(btnId) {
            return `
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-chart-line fa-3x text-muted"></i>
                    </div>
                    <h5>No Usage Data</h5>
                    <p class="text-muted mb-4">No usage data available for the selected time period.</p>
                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-outline-secondary" id="${btnId}">
                            <i class="fas fa-calendar-alt me-2"></i>Change Date Range
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-primary">
                            <i class="fas fa-robot me-2"></i>Try Using Models
                        </a>
                    </div>
                </div>`;
        }

        // Function to update summary tab
        function updateSummaryTab(data) {
            const summaryTab = document.getElementById('usage-summary-tab');
            if (!summaryTab) return;

            if (data.usage.length === 0) {
                // No data for this range
                summaryTab.innerHTML = createNoDataMessage('changeDateRangeBtn');

                // Re-attach event listener to change date range button
                const changeDateBtn = document.getElementById('changeDateRangeBtn');
                if (changeDateBtn) {
                    changeDateBtn.addEventListener('click', function() {
                        document.querySelector('.btn-group .btn[data-range="1"]').click();
                    });
                }
                return;
            }

            // We have data, start with the stats boxes
            let summaryHtml = createStatsBoxes(data);

            // Add the summary table (similar to the detailed view but with fewer columns)
            let tableRows = '';
            data.usage.forEach(usage => {
                tableRows += `
                    <tr>
                        <td class="text-light">${usage.created_at}</td>
                        <td class="text-light">
                            ${usage.usage_type === 'chat' ?
                                '<span class="badge badge-sm bg-primary">Chat</span>' :
                                '<span class="badge badge-sm bg-info">Embedding</span>'}
                        </td>
                        <td class="text-light">${usage.model_id ? usage.model_id.split('/').pop() : 'Unknown'}</td>
                        <td class="text-light">$${(usage.credits_used / 100000).toFixed(5)}</td>
                    </tr>`;
            });

            summaryHtml += `
                <h5 class="mb-3">Chat Summary</h5>
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th style="min-width: 110px;" class="text-white">Date</th>
                                <th style="min-width: 80px;" class="text-white">Type</th>
                                <th style="min-width: 180px;" class="text-white">Model</th>
                                <th style="min-width: 80px;" class="text-white">Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <small class="text-muted">Showing ${data.usage.length} records</small>
                </div>`;

            // Set the HTML content
            summaryTab.innerHTML = summaryHtml;
        }

        // Function to update detailed tab
        function updateDetailedTab(data) {
            const detailedTab = document.getElementById('usage-detailed-tab');
            if (!detailedTab) return;

            if (data.usage.length === 0) {
                // No data for this range
                detailedTab.innerHTML = createNoDataMessage('changeDateRangeBtn2');

                // Re-attach event listener to change date range button
                const changeDateBtn = document.getElementById('changeDateRangeBtn2');
                if (changeDateBtn) {
                    changeDateBtn.addEventListener('click', function() {
                        document.querySelector('.btn-group .btn[data-range="1"]').click();
                    });
                }
                return;
            }

            // We have data, start with the stats boxes
            let detailedHtml = createStatsBoxes(data);

            // Add the detailed table with additional columns
            let tableRows = '';
            data.usage.forEach(usage => {
                // Calculate input and output costs - assume a standard ratio if not available
                const inputTokens = usage.prompt_tokens || 0;
                const outputTokens = usage.completion_tokens || 0;

                // Estimate input/output costs (this is a simplification)
                // In reality, different models have different input/output pricing
                const totalCost = usage.credits_used / 100000; // convert to dollars
                let inputCost, outputCost;

                if (inputTokens === 0 && outputTokens === 0) {
                    // If we don't have token counts, show full cost as output
                    inputCost = 0;
                    outputCost = totalCost;
                } else {
                    // Simple approximation: input tokens are ~1/3 the cost of output tokens for most models
                    const inputCostRatio = 0.25; // input is 25% of total cost
                    const outputCostRatio = 0.75; // output is 75% of total cost

                    // Distribute cost by these ratios
                    inputCost = totalCost * inputCostRatio;
                    outputCost = totalCost * outputCostRatio;
                }

                tableRows += `
                    <tr>
                        <td class="text-light">${usage.created_at}</td>
                        <td class="text-light">
                            ${usage.usage_type === 'chat' ?
                                '<span class="badge badge-sm bg-primary">Chat</span>' :
                                '<span class="badge badge-sm bg-info">Embedding</span>'}
                        </td>
                        <td class="text-light">${usage.model_id ? usage.model_id.split('/').pop() : 'Unknown'}</td>
                        <td class="text-light">${inputTokens.toLocaleString()}</td>
                        <td class="text-light">$${inputCost.toFixed(5)}</td>
                        <td class="text-light">${outputTokens.toLocaleString()}</td>
                        <td class="text-light">$${outputCost.toFixed(5)}</td>
                        <td class="text-light">$${totalCost.toFixed(5)}</td>
                    </tr>`;
            });

            detailedHtml += `
                <h5 class="mb-3">Detailed Usage Analysis</h5>
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th style="min-width: 110px;" class="text-white">Date</th>
                                <th style="min-width: 80px;" class="text-white">Type</th>
                                <th style="min-width: 180px;" class="text-white">Model</th>
                                <th style="min-width: 80px;" class="text-white">Input Tokens</th>
                                <th style="min-width: 80px;" class="text-white">Input Cost</th>
                                <th style="min-width: 80px;" class="text-white">Output Tokens</th>
                                <th style="min-width: 80px;" class="text-white">Output Cost</th>
                                <th style="min-width: 80px;" class="text-white">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <small class="text-muted">Showing ${data.usage.length} records</small>
                </div>`;

            // Set the HTML content
            detailedTab.innerHTML = detailedHtml;
        }

        // Add event listeners to date range buttons
        dateRangeButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                dateRangeButtons.forEach(function(btn) {
                    btn.classList.remove('active');
                });

                // Add active class to clicked button
                this.classList.add('active');

                // Get date range value
                const dateRange = this.getAttribute('data-range');

                // Update usage data
                updateUsageData(dateRange);
            });
        });

        // Load initial data with default range (Last 24 Hours)
        if (document.querySelector('#usage-tab.active') || document.querySelector('#usage.active')) {
            // Only load data if we're on the usage tab
            updateUsageData('1');
        }

        // Enable/disable activation button based on checkbox
        // The old affiliate activation code has been removed since all users are now automatically affiliates

        // Copy referral link functionality
        const copyBtn = document.getElementById('copyReferralLink');
        const referralLinkInput = document.getElementById('referralLink');

        if (copyBtn && referralLinkInput) {
            copyBtn.addEventListener('click', function() {
                referralLinkInput.select();
                document.execCommand('copy');

                // Show feedback
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';

                setTimeout(function() {
                    copyBtn.innerHTML = originalText;
                }, 2000);
            });
        }

        // Function to calculate cost band based on pricing
        function calculateCostBand(inputPrice, outputPrice) {
            // Handle string price inputs (with $ symbol)
            if (typeof inputPrice === 'string') {
                inputPrice = parseFloat(inputPrice.replace('$', '')) || 0;
            }
            if (typeof outputPrice === 'string') {
                outputPrice = parseFloat(outputPrice.replace('$', '')) || 0;
            }

            // Determine if this is a free model
            const isFreeModel = (inputPrice === 0 || inputPrice <= 0.001) &&
                               (outputPrice === 0 || outputPrice <= 0.001);

            if (isFreeModel) {
                return '';  // Free models don't show a cost band
            }

            // Calculate band based on maximum price
            const maxPrice = Math.max(inputPrice, outputPrice);

            if (maxPrice >= 100.0) {
                return '$$$$';
            } else if (maxPrice >= 10.0) {
                return '$$$';
            } else if (maxPrice >= 1.0) {
                return '$$';
            } else if (maxPrice >= 0.01) {
                return '$';
            }

            return '';  // Default for very low prices
        }

        // Stripe integration is complete - custom amount calculator removed

        // Debug form submission for purchase buttons
        // Select all purchase forms
        const purchaseForms = document.querySelectorAll('form[id^="purchase-form-"]');

        // Add event listeners to each form
        purchaseForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                console.log('Purchase form submitted:', form.id);
                // Continue with form submission (do not prevent default)
            });

            // Add event listeners to the buttons inside forms
            const button = form.querySelector('button[type="submit"]');
            if (button) {
                button.addEventListener('click', function(e) {
                    console.log('Buy button clicked for form:', form.id);
                    // Let the normal form submission happen
                });
            }
        });

        // Clear conversations button functionality
        const clearConversationsBtn = document.getElementById('clear-conversations-btn-account');
        if (clearConversationsBtn) {
            clearConversationsBtn.addEventListener('click', function() {
                // Show confirmation dialog
                if (confirm('Are you sure you want to delete all conversations? This action cannot be undone.')) {
                    // User confirmed, send request to clear conversations
                    fetch('/clear-conversations', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('All conversations have been cleared successfully.');
                        } else {
                            alert('Error clearing conversations: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error clearing conversations:', error);
                        alert('Error clearing conversations. Please try again later.');
                    });
                }
            });
        }

        // Initialize Bootstrap tab functionality
        var triggerTabList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tab"]'));
        triggerTabList.forEach(function (triggerEl) {
            triggerEl.addEventListener('shown.bs.tab', function (event) {
                console.log(`Tab shown: ${event.target.getAttribute('data-bs-target')}`);

                // Get the tab name from data-bs-target attribute (removing the # symbol)
                const tabName = event.target.getAttribute('data-bs-target').substring(1);

                // Special handling when switching to usage tab
                if (tabName === 'usage') {
                    // Get currently selected date range, or default to '1' (Last 24 Hours)
                    const activeRange = document.querySelector('.btn-group .btn[data-range].active');
                    const dateRange = activeRange ? activeRange.getAttribute('data-range') : '1';

                    // Load usage data for the selected range
                    updateUsageData(dateRange);
                }

                // Tab-specific logic
                if (tabName === 'pricing') {
                    loadPricingData();
                } else if (tabName === 'tellFriend') {
                    console.log('Tell a Friend tab shown - initializing content');
                    // Ensure we initialize the tell friend tab even if the window function isn't available yet
                    if (typeof window.initializeTellFriendTabContent === 'function') {
                        window.initializeTellFriendTabContent();
                    } else {
                        // If the function isn't available yet, try to initialize directly
                        setTimeout(function() {
                            console.log('Delayed initialization of Tell a Friend tab');
                            const initFn = document.querySelector('#tellFriend script');
                            if (initFn && typeof window.initializeTellFriendTab === 'function') {
                                window.initializeTellFriendTab();
                            }
                        }, 500);
                    }
                }
            });
        });

        // Legacy openTab function for backward compatibility
        window.openTab = function(tabName, clickEvent) {
            console.log(`Opening tab with Bootstrap 5: ${tabName}`);

            // Find the corresponding tab trigger element
            const tabTrigger = document.querySelector(`[data-bs-target="#${tabName}"]`);

            if (tabTrigger) {
                // Use Bootstrap's tab API to show the tab
                const bsTab = new bootstrap.Tab(tabTrigger);
                bsTab.show();
            } else {
                console.error(`Tab trigger not found for: #${tabName}`);
            }

            // Tab-specific logic
            if (tabName === 'pricing') {
                loadPricingData();
            } else if (tabName === 'tellFriend') {
                console.log('Loading Tell a Friend tab content - SIMPLIFIED VERSION');
                // No need to set inline style - the .active class will handle this
                const tellFriendTab = document.getElementById('tellFriend');

                // Initialize the "Tell a Friend" tab with simplified functionality
                // This directly implements the needed functionality without relying on old functions
                initializeSimplifiedAffiliateFunctions();

                /*
                // Old initialization method - DISABLED to fix "Almost Ready!" issue
                if (tellFriendTab && typeof window.initializeTellFriendTabContent === 'function') {
                    // Call the initialization function
                    window.initializeTellFriendTabContent();
                } else {
                    // If the function isn't available yet, try to initialize directly
                    setTimeout(function() {
                        console.log('Delayed initialization of Tell a Friend tab');
                        if (typeof window.initializeTellFriendTab === 'function') {
                            window.initializeTellFriendTab();
                        }
                    }, 500);
                }
                */
                            try {
                                const scriptContent = document.querySelector('#tellFriend script');
                                if (scriptContent) {
                                    console.log('Found script content, attempting to initialize directly');
                                    // Manually initialize
                                    const copyBtn = document.getElementById('copyReferralLink');
                                    const referralLinkInput = document.getElementById('referralLink');

                                    if (copyBtn && referralLinkInput) {
                                        console.log('Manually setting up copy button');
                                        // Connect event directly
                                        copyBtn.addEventListener('click', function() {
                                            if (navigator.clipboard && window.isSecureContext) {
                                                navigator.clipboard.writeText(referralLinkInput.value)
                                                    .then(() => {
                                                        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                                                        setTimeout(() => {
                                                            copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
                                                        }, 2000);
                                                    });
                                            }
                                        });
                                    }
                                }
                            } catch (e) {
                                console.error('Error in manual initialization:', e);
                            }
                        }
                    }, 500);
                }
            }
        }

        // Model Pricing Table functionality
        var pricingData = [];
        var sortColumn = 0;
        var sortDirection = 1; // 1 for ascending, -1 for descending
        var previousSorts = []; // Track previous sort criteria for multi-level sorting

        // Function to load pricing data from API
        function loadPricingData() {
            const pricingTableBody = document.getElementById('pricingTableBody');
            const lastUpdatedElem = document.getElementById('lastUpdated');

            // Show loading state
            pricingTableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <div class="d-flex flex-column align-items-center">
                            <div class="spinner-border text-info mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="caption">Loading pricing data...</p>
                        </div>
                    </td>
                </tr>
            `;
            lastUpdatedElem.textContent = 'Loading...';

            // Fetch data from API (Using the endpoint that works with our price_updater module)
            fetch('/api/get_model_prices')
                .then(response => {
                    if (!response.ok) {
                        // Try to get error message from response body
                        return response.text().then(text => {
                            throw new Error(`Failed to fetch pricing data. Status: ${response.status}. Message: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Received pricing data from API:", data); // Log the received data structure

                    // --- Check the structure of the received data ---
                    if (typeof data.prices !== 'object' || data.prices === null) {
                        console.error('Invalid pricing data format received:', data);
                        throw new Error('Invalid pricing data format from server.');
                    }

                    // Store the prices object in pricingData
                    pricingData = data.prices; // <-- This is the object containing model prices

                    // Convert the pricingData object into an array of model objects for table rendering
                    pricingData = Object.entries(pricingData).map(([modelId, modelDetails]) => {
                        // Format the model name (use provided name if available, otherwise format the ID)
                        const modelName = modelDetails.model_name ||
                                          modelId.split('/').pop().replace(/-/g, ' ').replace(/(^\w|\s\w)/g, m => m.toUpperCase());

                        // Format prices with appropriate precision
                        // For very small values, show more decimal places
                        let inputPriceStr, outputPriceStr;

                        if (modelDetails.input_price === 0) {
                            inputPriceStr = '$0.00';
                        } else if (modelDetails.input_price < 0.01) {
                            inputPriceStr = `$${modelDetails.input_price.toFixed(4)}`;
                        } else {
                            inputPriceStr = `$${modelDetails.input_price.toFixed(2)}`;
                        }

                        if (modelDetails.output_price === 0) {
                            outputPriceStr = '$0.00';
                        } else if (modelDetails.output_price < 0.01) {
                            outputPriceStr = `$${modelDetails.output_price.toFixed(4)}`;
                        } else {
                            outputPriceStr = `$${modelDetails.output_price.toFixed(2)}`;
                        }

                        return {
                            model_id: modelId,
                            model_name: modelName,
                            input_price: inputPriceStr,
                            output_price: outputPriceStr,
                            context_length: modelDetails.context_length || 'N/A',
                            multimodal: modelDetails.is_multimodal ? 'Yes' : 'No',
                            pdfs: modelDetails.supports_pdf ? 'Yes' : 'No',
                            cost_band: modelDetails.cost_band || ''
                        };
                    });

                    // Store in localStorage for caching
                    try {
                        localStorage.setItem('modelPricingData', JSON.stringify(pricingData));
                        localStorage.setItem('modelPricingTimestamp', new Date().getTime().toString());
                    } catch (e) {
                        console.warn('Could not store pricing data in localStorage:', e);
                    }

                    // Remove any existing alert
                    const existingAlert = document.querySelector('#pricing .alert');
                    if (existingAlert) existingAlert.remove();

                    // Render the table
                    renderPricingTable();

                    // Update last updated timestamp
                    if (data.last_updated) {
                        const lastUpdatedDate = new Date(data.last_updated);
                        lastUpdatedElem.textContent = `Last updated: ${lastUpdatedDate.toLocaleTimeString()} ${lastUpdatedDate.toLocaleDateString()}`;
                    } else {
                        const currentTime = new Date();
                        lastUpdatedElem.textContent = `Last updated: ${currentTime.toLocaleTimeString()} ${currentTime.toLocaleDateString()}`;
                    }
                })
                .catch(error => {
                    console.error('Error loading pricing data:', error);

                    // Try to use cached data if available
                    const cachedData = localStorage.getItem('modelPricingData');
                    const cachedTimestamp = localStorage.getItem('modelPricingTimestamp');

                    if (cachedData) {
                        try {
                            pricingData = JSON.parse(cachedData);
                            renderPricingTable();

                            // Update the last updated timestamp to show it's cached data
                            lastUpdatedElem.textContent = `Last updated: ${new Date(parseInt(cachedTimestamp)).toLocaleString()} (cached)`;

                            // Remove any existing alert
                            const existingAlert = document.querySelector('#pricing .alert');
                            if (existingAlert) existingAlert.remove();

                            // Show warning about using cached data
                            const pricingCard = document.querySelector('#pricing .balance-card');
                            const warningAlert = document.createElement('div');
                            warningAlert.className = 'alert alert-warning mt-3';
                            warningAlert.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i> Could not fetch current pricing data. Using previously cached data.';
                            pricingCard.insertBefore(warningAlert, pricingCard.firstChild);

                            // Auto-hide the warning message after 5 seconds
                            setTimeout(() => {
                                warningAlert.remove();
                            }, 5000);

                            return;
                        } catch (e) {
                            console.error('Failed to use cached data:', e);
                        }
                    }

                    // No cached data or failed to parse it - show empty state
                    pricingTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <p class="caption text-danger">No pricing data available. Please try again later.</p>
                                <small class="text-muted">${error.message}</small>
                            </td>
                        </tr>
                    `;
                    lastUpdatedElem.textContent = 'Update failed';
                });
        }

        // Function to render the pricing table
        function renderPricingTable() {
            const pricingTableBody = document.getElementById('pricingTableBody');
            const searchTerm = document.getElementById('modelSearch')?.value.toLowerCase() || '';

            // Filter data based on search term
            const filteredData = pricingData.filter(model =>
                model.model_name.toLowerCase().includes(searchTerm) ||
                model.model_id.toLowerCase().includes(searchTerm)
            );

            // Sort data with multi-level sorting support
            filteredData.sort((a, b) => {
                // Create a function to get values for any column
                function getColumnValues(item, colIndex) {
                    // Check for special cases
                    const isAutoRouter = item.model_id.toLowerCase().includes('router') || item.model_id.toLowerCase().includes('openrouter');
                    const isFreeModel = item.input_price === '$0.00' && item.output_price === '$0.00';

                    let value;

                    switch(colIndex) {
                        case 0: // Model Name
                            value = item.model_name.toLowerCase();
                            break;

                        case 1: // Input Cost
                            if (item.input_price === 'Variable' || isAutoRouter) {
                                value = 0.00005;
                            } else if (item.input_price === 'N/A') {
                                value = 0;
                            } else {
                                value = parseFloat(item.input_price.replace('$', ''));
                                if (isNaN(value)) value = 0;
                            }
                            break;

                        case 2: // Output Cost
                            if (item.output_price === 'Variable' || isAutoRouter) {
                                value = 0.00005;
                            } else if (item.output_price === 'N/A') {
                                value = 0;
                            } else {
                                value = parseFloat(item.output_price.replace('$', ''));
                                if (isNaN(value)) value = 0;
                            }
                            break;

                        case 3: // Context Length
                            value = item.context_length === 'N/A' ? 0 : parseInt(item.context_length);
                            break;

                        case 4: // Multimodal
                            value = item.multimodal === 'Yes' ? 0 : 1;
                            break;

                        case 5: // PDFs
                            value = item.pdfs === 'Yes' ? 0 : 1;
                            break;

                        case 6: // Cost Band
                            value = item.cost_band ? item.cost_band.length : 0;
                            break;

                        default:
                            value = item.model_name.toLowerCase();
                    }

                    return value;
                }

                // First compare by primary sort column
                const aValue = getColumnValues(a, sortColumn);
                const bValue = getColumnValues(b, sortColumn);

                // Compare values based on sort direction
                if (aValue < bValue) return -1 * sortDirection;
                if (aValue > bValue) return 1 * sortDirection;

                // If values are equal, check secondary sort criteria
                for (const prevSort of previousSorts) {
                    const prevAValue = getColumnValues(a, prevSort.column);
                    const prevBValue = getColumnValues(b, prevSort.column);

                    if (prevAValue < prevBValue) return -1 * prevSort.direction;
                    if (prevAValue > prevBValue) return 1 * prevSort.direction;
                }

                // If everything is equal, use model name as final tiebreaker
                const aName = a.model_name.toLowerCase();
                const bName = b.model_name.toLowerCase();
                if (aName < bName) return -1;
                if (aName > bName) return 1;
                return 0;
            });

            // Generate table content
            if (filteredData.length === 0) {
                pricingTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <p class="caption">No matching models found.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            pricingTableBody.innerHTML = filteredData.map(model => {
                // Check for special model types
                const isAutoRouter = model.model_id.toLowerCase().includes('router') || model.model_id.toLowerCase().includes('openrouter');
                // Check for free models - looking for $0.00 prices or very low values (for rounding issues)
                const initialInputPrice = parseFloat(model.input_price?.replace('$', '') || '0');
                const initialOutputPrice = parseFloat(model.output_price?.replace('$', '') || '0');
                const isFreeModel = (model.input_price === '$0.00' || initialInputPrice === 0 || initialInputPrice <= 0.001) &&
                                   (model.output_price === '$0.00' || initialOutputPrice === 0 || initialOutputPrice <= 0.001);
                const isEmbedding = model.model_id === 'text-embedding-3-large';

                // Handle model name display (no special styling for model names - all will use default color)
                let modelNameClass = '';
                // Removed special styling for models to ensure consistent colors

                // Calculate cost band based on pricing data
                let costBand = '';
                let costBandClass = '';

                if (isFreeModel) {
                    costBand = '';  // Free models don't need a cost band
                    costBandClass = 'cost-band-free';
                } else if (isAutoRouter) {
                    costBand = '$$$';  // AutoRouter is variable but typically higher end
                    costBandClass = 'cost-band-3-warn';
                } else {
                    // Extract numeric values from price strings
                    const costInputPrice = parseFloat(model.input_price.replace('$', '')) || 0;
                    const costOutputPrice = parseFloat(model.output_price.replace('$', '')) || 0;
                    const maxPrice = Math.max(costInputPrice, costOutputPrice);

                    if (maxPrice >= 100.0) {
                        costBand = '$$$$';
                        costBandClass = 'cost-band-4-danger';
                    } else if (maxPrice >= 10.0) {
                        costBand = '$$$';
                        costBandClass = 'cost-band-3-warn';
                    } else if (maxPrice >= 1.0) {
                        costBand = '$$';
                        costBandClass = 'cost-band-2';
                    } else if (maxPrice >= 0.01) {
                        costBand = '$';
                        costBandClass = 'cost-band-1';
                    }
                }

                // Determine if the model is a good value
                const isGoodValue = !isAutoRouter && !isFreeModel &&
                                  model.input_price !== 'N/A' && model.input_price !== 'Variable' &&
                                  costInputPrice < 10.0;

                // Handle price display
                let inputPriceDisplay = model.input_price;
                let outputPriceDisplay = model.output_price;

                // Format for AutoRouter with tooltip explanation
                if (isAutoRouter) {
                    inputPriceDisplay = `
                        <span class="tooltip-container">
                            <span class="fw-bold text-warning">Variable</span>
                            <span class="tooltip-text">AutoRouter dynamically selects a model based on quality and cost at the time of your request.</span>
                        </span>`;
                    outputPriceDisplay = `
                        <span class="tooltip-container">
                            <span class="fw-bold text-warning">Variable</span>
                            <span class="tooltip-text">Costs vary based on the selected model.</span>
                        </span>`;
                }

                // Format free models with consistent color (no special color)
                if (isFreeModel) {
                    inputPriceDisplay = `$0.00`;
                    outputPriceDisplay = `$0.00`;
                }

                // Remove special color for "good value" models to make all pricing consistent
                // No special highlighting for any price values

                // Format context length with K or M suffix
                let contextDisplay = model.context_length;
                if (model.context_length !== 'N/A' && !isNaN(model.context_length)) {
                    const contextNum = parseInt(model.context_length);
                    if (contextNum >= 1000000) {
                        contextDisplay = `${(contextNum / 1000000).toFixed(1)}M`;
                    } else {
                        contextDisplay = `${(contextNum / 1000).toFixed(0)}K`;
                    }
                }

                // Create multimodal badge/label for the dedicated column
                var multimodalDisplay = '';
                if (model.multimodal === 'Yes') {
                    multimodalDisplay = '<span class="badge bg-success">Yes</span>';
                } else {
                    multimodalDisplay = '<span class="badge bg-secondary">No</span>';
                }

                return `
                    <tr>
                        <td>
                            <div>
                                <span class="${modelNameClass} fw-medium">${model.model_name}</span>
                                ${costBand ? `<span class="cost-band-indicator ${costBandClass}">${costBand}</span>` : ''}
                            </div>
                            <small class="text-muted d-block text-truncate" style="max-width: 250px;">${model.model_id}</small>
                        </td>
                        <td class="text-end">${inputPriceDisplay}</td>
                        <td class="text-end">${outputPriceDisplay}</td>
                        <td class="text-end">${contextDisplay}</td>
                        <td class="text-center">
                            ${multimodalDisplay}
                        </td>
                        <td class="text-center">
                            ${model.pdfs === 'Yes'
                                ? '<span class="badge bg-success">Yes</span>'
                                : '<span class="badge bg-secondary">No</span>'}
                        </td>
                        <td class="text-center">
                            ${costBand ? `<span class="cost-band-indicator ${costBandClass}">${costBand}</span>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Function to handle table sorting with multi-level sort support
        window.sortPricingTable = function(columnIndex) {
            // If clicking the same column, reverse the sort direction
            if (sortColumn === columnIndex) {
                sortDirection *= -1;
            } else {
                // Save the previous sort criteria before changing
                if (sortColumn !== columnIndex) {
                    // Only keep the most recent sort in history
                    if (previousSorts.length > 0) {
                        // If the current column is already in previousSorts, remove it
                        previousSorts = previousSorts.filter(sort => sort.column !== columnIndex);
                    }

                    // Add the current sort to history before changing
                    previousSorts.unshift({
                        column: sortColumn,
                        direction: sortDirection
                    });

                    // Limit history to 2 levels for simplicity
                    if (previousSorts.length > 2) {
                        previousSorts.pop();
                    }
                }

                // Set new primary sort
                sortColumn = columnIndex;
                sortDirection = 1;
            }

            // Update the table with new sort order
            renderPricingTable();

            // Update sort icons to show primary and secondary sorts
            document.querySelectorAll('#pricingTable th i').forEach((icon, index) => {
                if (index === sortColumn) {
                    // Primary sort (current)
                    icon.className = sortDirection === 1 ? 'fas fa-sort-up' : 'fas fa-sort-down';
                } else if (previousSorts.some(sort => sort.column === index)) {
                    // Secondary sort (previous)
                    const prevSort = previousSorts.find(sort => sort.column === index);
                    icon.className = prevSort.direction === 1 ? 'fas fa-sort-up text-muted' : 'fas fa-sort-down text-muted';
                } else {
                    // Not sorted
                    icon.className = 'fas fa-sort';
                }
            });
        };

        // Search functionality for pricing table
        if (document.getElementById('modelSearch')) {
            document.getElementById('modelSearch').addEventListener('input', renderPricingTable);
        }

        // Set up automatic periodic refresh (every 4 hours)
        const REFRESH_INTERVAL = 4 * 60 * 60 * 1000; // 4 hours in milliseconds

        // Periodic auto-refresh
        setInterval(function() {
            console.log('Auto-refreshing pricing data...');
            // Only refresh if the pricing tab is active or if there's no cached data
            const activeTab = document.querySelectorAll('.tab-pane.active')[0]?.id;
            const cachedTimestamp = localStorage.getItem('modelPricingTimestamp');
            if (activeTab === 'pricing' || !cachedTimestamp) {
                loadPricingData();
            }
        }, REFRESH_INTERVAL);

        // Duplicate sortPricingTable function removed - using the more advanced version above

        // Load pricing data on page load if we're on the pricing tab
        if (window.location.hash === '#pricing') {
            openTab('pricing', null);
        }

        // Initialize the usage analytics sub-tab functionality
        const handleUsageSubTabs = function() {
            const usageTabButtons = document.querySelectorAll('.usage-tab-button');
            const usageSubTabs = document.querySelectorAll('.usage-sub-tab');

            usageTabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Deactivate all tab buttons
                    usageTabButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });

                    // Hide all sub-tabs
                    usageSubTabs.forEach(tab => {
                        tab.style.display = 'none';
                    });

                    // Activate the clicked button
                    button.classList.add('active');

                    // Show the selected sub-tab
                    const tabToShow = button.getAttribute('data-tab');
                    document.getElementById(`usage-${tabToShow}-tab`).style.display = 'block';
                });
            });
        };

        // CSV Export functionality
        const handleCsvExport = function() {
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', function() {
                    // Force switch to detailed tab before export
                    const detailedButton = document.querySelector('.usage-tab-button[data-tab="detailed"]');
                    if (detailedButton) {
                        detailedButton.click();
                    }

                    // Get the detailed table data
                    const detailedTab = document.getElementById('usage-detailed-tab');
                    if (!detailedTab) return;

                    // Get the table rows from the detailed tab
                    const table = detailedTab.querySelector('table');
                    if (!table) {
                        alert('No data available to export');
                        return;
                    }

                    // Get all table headers
                    const headers = [];
                    const headerCells = table.querySelectorAll('thead th');
                    headerCells.forEach(cell => {
                        headers.push(cell.textContent.trim());
                    });

                    // Get all table rows
                    const rows = [];
                    const tableRows = table.querySelectorAll('tbody tr');
                    tableRows.forEach(row => {
                        const rowData = [];
                        row.querySelectorAll('td').forEach(cell => {
                            rowData.push(cell.textContent.trim().replace('$', ''));
                        });
                        rows.push(rowData);
                    });

                    // Create CSV content
                    let csvContent = headers.join(',') + '\n';
                    rows.forEach(row => {
                        csvContent += row.join(',') + '\n';
                    });

                    // Create a Blob and download link
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'usage_analytics_detailed.csv');
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            }
        };

        // Initialize the usage analytics functionality
        handleUsageSubTabs();
        handleCsvExport();

        // Initialize affiliate functions
        initializeSimplifiedAffiliateFunctions();

        // Memory preference toggle handler
        const enableMemoryToggle = document.getElementById('enableMemory');
        if (enableMemoryToggle) {
            enableMemoryToggle.addEventListener('change', function() {
                const enableMemory = this.checked;

                // Show toggle indicator
                const toggleStatus = enableMemory ? 'enabled' : 'disabled';
                const toastMessage = `Memory across sessions ${toggleStatus}`;

                // Call API to update preference
                fetch('/billing/update-memory-preference', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ enable_memory: enableMemory })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success notification using existing toast system
                        showToast('success', toastMessage);
                    } else {
                        // Show error and revert toggle
                        showToast('error', 'Failed to update preference: ' + data.message);
                        enableMemoryToggle.checked = !enableMemory;
                    }
                })
                .catch(error => {
                    console.error('Error updating memory preference:', error);
                    showToast('error', 'An error occurred while saving your preference');
                    enableMemoryToggle.checked = !enableMemory;
                });
            });
        }

        // Model fallback preference toggle handler
        const enableModelFallbackToggle = document.getElementById('enableModelFallback');
        if (enableModelFallbackToggle) {
            enableModelFallbackToggle.addEventListener('change', function() {
                const enableModelFallback = this.checked;

                // Show toggle indicator
                const toggleStatus = enableModelFallback ? 'enabled' : 'disabled';
                const toastMessage = `Model fallback ${toggleStatus}`;

                // Call API to update preference
                fetch('/billing/update-fallback-preference', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ enable_model_fallback: enableModelFallback })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success notification using existing toast system
                        showToast('success', toastMessage);
                    } else {
                        // Show error and revert toggle
                        showToast('error', 'Failed to update preference: ' + (data.message || 'Unknown error'));
                        enableModelFallbackToggle.checked = !enableModelFallback;
                    }
                })
                .catch(error => {
                    console.error('Error updating model fallback preference:', error);
                    showToast('error', 'An error occurred while saving your preference');
                    enableModelFallbackToggle.checked = !enableModelFallback;
                });
            });
        }
    });
</script>
{% endblock %}
