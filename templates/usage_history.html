{% extends "base.html" %}

{% block title %}Usage Analytics{% endblock %}

{% block styles %}
{{ super() }}
<style>
    body {
        background-color: #131416;
        color: #e4e6eb;
    }
    
    .container {
        max-width: 1000px;
    }
    
    .account-header {
        margin-bottom: 1.5rem;
    }
    
    .caption {
        font-size: 0.9rem;
        opacity: 0.7;
    }
    
    .card-dark {
        background-color: #1e2124;
        border: none;
        border-radius: 8px;
        margin-bottom: 2rem;
    }
    
    .back-button {
        background-color: #17a2b8;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .back-button:hover {
        background-color: #138496;
        color: white;
    }
    
    .tab-button {
        background-color: #2c2f33;
        color: #e4e6eb;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        margin-right: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
    }
    
    .tab-button:hover {
        background-color: #3f4246;
    }
    
    .tab-button.active {
        background-color: #17a2b8;
        color: white;
    }
    
    .stat-card {
        background-color: #242628;
        border: none;
        border-radius: 8px;
        padding: 1rem;
        height: 100%;
    }
    
    .stat-title {
        font-size: 0.9rem;
        color: #a0a0a0;
        margin-bottom: 0.5rem;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: white;
        margin-bottom: 0.5rem;
    }
    
    .stat-caption {
        font-size: 0.8rem;
        color: #a0a0a0;
    }
    
    .progress-dark {
        background-color: #2c2f33;
        border-radius: 8px;
        overflow: hidden;
        height: 10px;
    }
    
    .progress-bar-dark-primary {
        background-color: #17a2b8;
    }
    
    .progress-bar-dark-info {
        background-color: #0e6d98;
    }
    
    .progress-bar-dark-secondary {
        background-color: #495057;
    }
    
    .table-dark {
        color: #e4e6eb;
        background-color: transparent;
        border-color: #2c2f33;
    }
    
    .table-dark th {
        border-bottom: 1px solid #2c2f33;
        background-color: #242628;
        color: #e4e6eb;
        padding: 10px;
    }
    
    .table-dark td {
        border-bottom: 1px solid #2c2f33;
        padding: 10px;
    }
    
    .table-dark tr.usage-row:hover {
        background-color: #2c2f33;
        transition: background-color 0.2s ease;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .badge-dark-primary {
        background-color: #17a2b8;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    
    .badge-dark-info {
        background-color: #0e6d98;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    
    .badge-dark-secondary {
        background-color: #495057;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    
    .list-item-dark {
        background-color: #242628;
        border: none;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .action-button {
        background-color: #17a2b8;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .action-button:hover {
        background-color: #138496;
        color: white;
    }
    
    .pagination-dark .page-link {
        background-color: #2c2f33;
        border-color: #3f4246;
        color: #e4e6eb;
    }
    
    .pagination-dark .page-item.active .page-link {
        background-color: #17a2b8;
        border-color: #17a2b8;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="account-header d-flex justify-content-between align-items-center">
        <div>
            <h1>Usage Analytics</h1>
            <p class="caption">Track your AI model usage and spending patterns</p>
        </div>
        <a href="{{ url_for('billing.account_management') }}" class="back-button">
            <i class="fas fa-arrow-left me-1"></i> Back to Account
        </a>
    </div>
    
    <div class="card-dark p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Usage Analytics</h4>
            <div>
                <button class="tab-button active" id="tab-summary" onclick="switchTab('summary')">Summary</button>
                <button class="tab-button" id="tab-detailed" onclick="switchTab('detailed')">Detailed</button>
                <button class="tab-button" id="btn-export-csv" onclick="exportCSV()">
                    <i class="fas fa-download me-1"></i> Export CSV
                </button>
            </div>
        </div>
        
        <div class="mb-4">
            <h6 class="mb-2">Date Range</h6>
            <div>
                <button class="tab-button" onclick="setDateRange('30days')">Last 30 Days</button>
                <button class="tab-button" onclick="setDateRange('7days')">Last 7 Days</button>
                <button class="tab-button active" onclick="setDateRange('month')">This Month</button>
            </div>
        </div>
        
        {% if usage_list %}
            <!-- Calculate totals -->
            {% set total_credits = namespace(value=0) %}
            {% set total_tokens = namespace(value=0) %}
            {% set chat_credits = namespace(value=0) %}
            {% set embedding_credits = namespace(value=0) %}
            {% set other_credits = namespace(value=0) %}
            {% set token_count = namespace(value=0) %}
            
            {% for usage in usage_list %}
                {% set total_credits.value = total_credits.value + usage.credits_used %}
                {% if usage.prompt_tokens and usage.completion_tokens %}
                    {% set total_tokens.value = total_tokens.value + usage.prompt_tokens + usage.completion_tokens %}
                    {% set token_count.value = token_count.value + 1 %}
                {% endif %}
                
                {% if usage.usage_type == 'chat' %}
                    {% set chat_credits.value = chat_credits.value + usage.credits_used %}
                {% elif usage.usage_type == 'embedding' %}
                    {% set embedding_credits.value = embedding_credits.value + usage.credits_used %}
                {% else %}
                    {% set other_credits.value = other_credits.value + usage.credits_used %}
                {% endif %}
            {% endfor %}
            
            <!-- Stat Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-title">Total Cost</div>
                        <div class="stat-value">${{ "%.2f"|format(total_credits.value / 1000) }}</div>
                        <div class="stat-caption">This period</div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-title">Total Tokens</div>
                        <div class="stat-value">{{ total_tokens.value|default(0) }}</div>
                        <div class="stat-caption">Processed</div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-title">API Calls</div>
                        <div class="stat-value">{{ usage_list|length }}</div>
                        <div class="stat-caption">Total requests</div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="stat-title">Avg. Cost/Call</div>
                        <div class="stat-value">${{ "%.4f"|format(total_credits.value / (usage_list|length) / 1000) if usage_list|length > 0 else "0.00" }}</div>
                        <div class="stat-caption">Per request</div>
                    </div>
                </div>
            </div>
            
            <!-- Usage Details -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <div class="card-dark p-3 h-100">
                        <h5 class="mb-3">Usage by Type</h5>
                        
                        {% set chat_percent = (chat_credits.value / total_credits.value * 100)|int if total_credits.value > 0 else 0 %}
                        {% set embedding_percent = (embedding_credits.value / total_credits.value * 100)|int if total_credits.value > 0 else 0 %}
                        {% set other_percent = (other_credits.value / total_credits.value * 100)|int if total_credits.value > 0 else 0 %}
                        
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Chat</span>
                            <div>
                                <span class="me-2">${{ "%.2f"|format(chat_credits.value / 1000) }}</span>
                                <span class="badge-dark-primary">{{ chat_percent }}%</span>
                            </div>
                        </div>
                        <div class="progress-dark mb-3">
                            <div class="progress-bar-dark-primary" style="width: {{ chat_percent }}%; height: 10px;"></div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Embedding</span>
                            <div>
                                <span class="me-2">${{ "%.2f"|format(embedding_credits.value / 1000) }}</span>
                                <span class="badge-dark-info">{{ embedding_percent }}%</span>
                            </div>
                        </div>
                        <div class="progress-dark mb-3">
                            <div class="progress-bar-dark-info" style="width: {{ embedding_percent }}%; height: 10px;"></div>
                        </div>
                        
                        {% if other_credits.value > 0 %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Other</span>
                            <div>
                                <span class="me-2">${{ "%.2f"|format(other_credits.value / 1000) }}</span>
                                <span class="badge-dark-secondary">{{ other_percent }}%</span>
                            </div>
                        </div>
                        <div class="progress-dark mb-3">
                            <div class="progress-bar-dark-secondary" style="width: {{ other_percent }}%; height: 10px;"></div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <div class="card-dark p-3 h-100">
                        <h5 class="mb-3">Usage Statistics</h5>
                        
                        <div class="list-item-dark">
                            <div>
                                <i class="fas fa-coins text-warning me-2"></i>
                                <span class="caption">Total Usage Cost</span>
                            </div>
                            <span>${{ "%.4f"|format(total_credits.value / 1000) }}</span>
                        </div>
                        
                        <div class="list-item-dark">
                            <div>
                                <i class="fas fa-file-alt text-info me-2"></i>
                                <span class="caption">Total Tokens Processed</span>
                            </div>
                            <span>{{ total_tokens.value|default(0) }}</span>
                        </div>
                        
                        <div class="list-item-dark">
                            <div>
                                <i class="fas fa-calculator text-success me-2"></i>
                                <span class="caption">Average Tokens per Request</span>
                            </div>
                            <span>{{ (total_tokens.value / token_count.value)|int if token_count.value > 0 else 0 }}</span>
                        </div>
                        
                        <div class="list-item-dark">
                            <div>
                                <i class="fas fa-exchange-alt text-primary me-2"></i>
                                <span class="caption">Total API Calls</span>
                            </div>
                            <span>{{ usage_list|length }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content Sections -->
            <div id="summary-content" class="tab-content active">
                <!-- Detailed Usage Table Summary View -->
                <h5 class="mb-3">Detailed Usage</h5>
                <div class="table-responsive">
                    <table class="table table-dark">
                        <thead>
                            <tr class="bg-dark">
                                <th>Date/Time</th>
                                <th>Type</th>
                                <th>Model</th>
                                <th>Tokens</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usage in usage_list %}
                            <tr class="usage-row">
                                <td>{{ usage.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if usage.usage_type == 'chat' %}
                                        <span class="badge-dark-primary">Chat</span>
                                    {% elif usage.usage_type == 'embedding' %}
                                        <span class="badge-dark-info">Embedding</span>
                                    {% else %}
                                        <span class="badge-dark-secondary">{{ usage.usage_type|capitalize }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ usage.model_id|truncate(20) if usage.model_id else 'N/A' }}</td>
                                <td>
                                    {% if usage.prompt_tokens and usage.completion_tokens %}
                                        {{ usage.prompt_tokens + usage.completion_tokens }}
                                        <small class="caption">({{ usage.prompt_tokens }} in / {{ usage.completion_tokens }} out)</small>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>${{ "%.4f"|format(usage.credits_used / 1000) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="detailed-content" class="tab-content">
                <!-- Detailed Usage Table Full View -->
                <h5 class="mb-3">Detailed Usage Analytics</h5>
                <div class="table-responsive">
                    <table class="table table-dark">
                        <thead>
                            <tr class="bg-dark">
                                <th>Date</th>
                                <th>Model</th>
                                <th>Input Tokens</th>
                                <th>Input Cost</th>
                                <th>Output Tokens</th>
                                <th>Output Cost</th>
                                <th>Total Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usage in usage_list %}
                            {% if usage.usage_type == 'chat' and usage.model_id and usage.prompt_tokens and usage.completion_tokens %}
                            <tr class="usage-row">
                                <td>{{ usage.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ usage.model_id|truncate(20) }}</td>
                                <td>{{ usage.prompt_tokens }}</td>
                                <td>${{ "%.4f"|format((usage.prompt_tokens * (usage.credits_used / (usage.prompt_tokens + usage.completion_tokens))) / 1000) }}</td>
                                <td>{{ usage.completion_tokens }}</td>
                                <td>${{ "%.4f"|format((usage.completion_tokens * (usage.credits_used / (usage.prompt_tokens + usage.completion_tokens))) / 1000) }}</td>
                                <td>${{ "%.4f"|format(usage.credits_used / 1000) }}</td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div>
                    <small class="caption">Showing {{ usage_list|length }} records</small>
                </div>
                <nav aria-label="Usage pagination">
                    <ul class="pagination pagination-sm pagination-dark mb-0">
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Previous</a>
                        </li>
                        <li class="page-item active">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        {% else %}
            <div class="text-center py-5">
                <div class="mb-3">
                    <i class="fas fa-chart-line fa-3x text-muted"></i>
                </div>
                <h5>No Usage Data</h5>
                <p class="caption">No usage data available for the selected time period.</p>
                <p class="caption">Try a different date range or start using the AI models to generate usage data.</p>
                <a href="{{ url_for('index') }}" class="action-button mt-2">Try Using Models</a>
            </div>
        {% endif %}
    </div>
    
    <div class="card-dark p-4">
        <h5 class="mb-3">Understanding AI Model Pricing</h5>
        <div class="row">
            <div class="col-md-6">
                <h6 class="mb-2">About AI Model Pricing</h6>
                <p class="caption">Our pricing is based on the token usage of different AI models:</p>
                <ul class="caption">
                    <li>AI models process text in "tokens" (roughly 4 characters per token for English)</li>
                    <li>Different models have different capabilities and costs</li>
                    <li>You're only charged for the models and features you use</li>
                    <li>All costs are shown in USD</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6 class="mb-2">Model Cost Comparison</h6>
                <div class="table-responsive">
                    <table class="table table-dark table-sm">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Cost per 1K tokens</th>
                                <th>Approx. messages per $1</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>GPT-3.5</td>
                                <td>$0.0003</td>
                                <td>~3,000</td>
                            </tr>
                            <tr>
                                <td>Claude-3 Haiku</td>
                                <td>$0.003</td>
                                <td>~300</td>
                            </tr>
                            <tr>
                                <td>Gemini 1.5 Pro</td>
                                <td>$0.01</td>
                                <td>~100</td>
                            </tr>
                            <tr>
                                <td>Claude-3 Sonnet</td>
                                <td>$0.015</td>
                                <td>~70</td>
                            </tr>
                            <tr>
                                <td>GPT-4</td>
                                <td>$0.06</td>
                                <td>~18</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
{{ super() }}
<script>
    // Tab switching functionality
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // Show selected tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabName}-content`).classList.add('active');
    }
    
    // Date range switching
    function setDateRange(range) {
        // Update date range buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            if (btn.textContent.trim() === 'Last 30 Days' || 
                btn.textContent.trim() === 'Last 7 Days' || 
                btn.textContent.trim() === 'This Month') {
                btn.classList.remove('active');
            }
        });
        
        let activeButton;
        if (range === '30days') {
            activeButton = 'Last 30 Days';
        } else if (range === '7days') {
            activeButton = 'Last 7 Days';
        } else {
            activeButton = 'This Month';
        }
        
        document.querySelectorAll('.tab-button').forEach(btn => {
            if (btn.textContent.trim() === activeButton) {
                btn.classList.add('active');
            }
        });
        
        // In a real application, we would reload the data for the new range
        // For now, we'll just show a notification
        showNotification(`Date range changed to ${activeButton}`);
    }
    
    // CSV Export functionality
    function exportCSV() {
        // Get table data
        const tableRows = document.querySelectorAll('#detailed-content table tbody tr');
        if (tableRows.length === 0) {
            showNotification('No data to export');
            return;
        }
        
        // Create CSV content with headers
        let csvContent = 'Date,Model,Input Tokens,Input Cost,Output Tokens,Output Cost,Total Cost\n';
        
        // Add each row
        tableRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = Array.from(cells).map(cell => {
                // Clean the cell content (remove $ signs, commas, etc.)
                let content = cell.textContent.trim().replace(/\$/g, '');
                // If the content has commas or quotes, wrap in quotes
                if (content.includes(',') || content.includes('"')) {
                    content = `"${content.replace(/"/g, '""')}"`;
                }
                return content;
            });
            csvContent += rowData.join(',') + '\n';
        });
        
        // Create and download the CSV file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'usage_analytics.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('CSV file downloaded successfully');
    }
    
    // Notification functionality
    function showNotification(message, duration = 3000) {
        // Create notification element if it doesn't exist
        let notification = document.getElementById('notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'notification';
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.backgroundColor = '#17a2b8';
            notification.style.color = 'white';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '4px';
            notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            notification.style.zIndex = '1000';
            notification.style.display = 'flex';
            notification.style.alignItems = 'center';
            notification.style.justifyContent = 'space-between';
            notification.style.minWidth = '200px';
            notification.style.maxWidth = '400px';
            
            document.body.appendChild(notification);
        }
        
        // Set message
        notification.innerHTML = `
            <span>${message}</span>
            <button onclick="this.parentElement.style.display='none'" style="background:none; border:none; color:white; margin-left:10px; cursor:pointer;">×</button>
        `;
        
        // Show notification
        notification.style.display = 'flex';
        
        // Hide after duration
        clearTimeout(notification.timeout);
        notification.timeout = setTimeout(() => {
            notification.style.display = 'none';
        }, duration);
    }
</script>
{% endblock %}
{% endblock %}